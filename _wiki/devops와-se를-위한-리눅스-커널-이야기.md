---
layout  : wiki
title   : DevOps와 SE를 위한 리눅스 커널 이야기
date    : 2022-08-22 13:49:39 +0900
lastmod : 2022-08-22 15:30:47 +0900
tags    : [book, devops, se, linux]
draft   : false
parent  : [devops]
---

## 간략 설명
- 이 책은 실습과 개념, Tip 이 동시에 존재하는 책이다.
- 개념, 실습에 대한 내용은 책을 반드시 참고하자. 실험이 알차다.
- 여기선 Tip 에 해당하는 각 챕터의 요약부분만을 정리해둔다.

## 1. 시스템 구성 정보 확인하기
- demidecode 명령을 통해서 CPU, 메모리, BIOS 등의 정보를 확인할 수 있다.
- CPU 정보는 `/proc/cpuinfo` 파일을 통해서도 확인할 수 있다.
- free 명령을 통해서 시스템에 설치된 메모리의 전체 크기를 알 수 있다.
- 시스템에 마운트된 블록 디바이스의 정보는 df 명령을 통해 확인할 수 있다.
- 네트워크 카드 정보는 ethtool 명령을 통해서 확인할 수 있다.
- ethtool 명령 중 -g 옵션으로 네트워크 카드에 설정된 Ring Buffer의 최대 크기와 현재 크기를 확인할 수 있다.
- ethtool 명령 중 -k 옵션으로 네트워크 카드의 부수적인 기능들을 확인할 수 있다.
- ethtool 명령 중 -i 옵션으로 네트워크 카드가 사용 중인 커널 드라이버의 정보를 확인할 수 있다.

## 2. top을 통해 살펴보는 프로세스 정보들
- top 명령으로 현재 시스템의 CPU, Memory, swap의 사용량 및 각 프로세스들의 상태와 메모리 점유 상태를 확인할 수 있다.
- top 명령의 결과 중 VIRT는 프로세스에게 할당된 가상 메모리 전체의 크기를 가리킨다. RES는 그 중에서도 실제로 메모리에 올려서 사용하고 있는 물리 메모리의 크기, 그리고 SHR은 다른 프로세스와 공유하고 있는 메모리의 크기를 의미한다.
- 커널은 프로세스가 메모리를 요청할 때 그에 맞는 크기를 할당해주지만 해당 영역을 물리 메모리에 바로 할당하지는 않는다. Memory Commit 참고- `vm.overcommit_memory` 는 커널의 Memory Commit 동작 방식을 변경할 수 있게 해주는 커널 파라미터이다.
- top으로 볼 수 있는 프로세스의 상태 중 D는 I/O 대기중인 프로세스, R은 실제 실행 중인 프로세스, S는 sleep 상태의 프로세스를 의미한다. T는 tracing 중인 프로세스, Z는 좀비 상태의 프로세스를 의미한다.
- 프로세스에는 우선순위가 있어 우선순위값이 더 작을 수록 빨리 실행된다. 우선순위는 nice 명령을 통해서 조절될 수 있다.

---
- 개인 생각: nice를 조절해본 경험이 없는데, 조절할일이 많나?

## 3. Load Average와 시스템 부하
- Load Average는 실행 중 혹은 실행 대기 중이거나 I/O 작업 등을 위해 대기 큐에 있는 프로세스들의 수를 기반으로 만들어진 값이다.
- Load Average 자체의 절대적인 높음과 낮음은 없다.
- 커널에도 버그가 있을 수 있으므로 Load Average 값을 절대적으로 신뢰해서는 안된다.
- vmstat 툴도 시스템 부하를 측정하는데 사용할 수 있다.
- `/proc/sched_debug`는 nr_running과 runnable tasks 항목에서 각 CPU에 할당된 프로세스 수와 프로세스의 PID 등 정보를 확인할수 있다.

## 4. free 명령이 숨기고 있는 것들
- free 명령으로 볼 수 있는 buffers 는 파일 시스템의 메타 데이터 등을 저장하고 있는 블록 디바이스의 블록을 위한 캐시이다.
- free 명령으로 볼 수 있는 cached는 I/O 작업의 효율성을 위해 한번 읽은 파일의 내용을 저장하는 데 사용하는 캐시이다.
- buffers와 cached는 미사용중인 메모리 영역을 시스템의 효율성을 위해서 커널이 사용하고 있는 것이며, 프로세스가 요청하면 이 영역을 해제하여 프로세스에게 전달해 줄수 있다.
- `/proc/meminfo` 에서 보이는 anon 영역은 프로세스에서 사용하는 영역, file 영역은 I/O 를 위한 캐시이다.
- slab 영역은 커널이 사용하는 캐싱 영역을 의미, dentry cache, inode cache 등 다양한 캐싱 용도로 사용된다.

## 5. swap, 메모리 증설의 포인트
- 버디시스템
- swap 을 사용할 경우 성능하락이 생길수 있다.
- swap 영역을 사용할 때에는 어떤 프로세스에서 swap 영역을 사용하는지 정확하게 알 필요가 있으며 smem 이라는 툴을 이용해 빠르게 확인할 수 있다.
- `vm.swappiness` 파라미터를 통해서 메모리 재할당시, swap을 사용하게 할지 페이지 캐시를 해제하게 할지 비율을 조절할 수 있다.
- `vm.vfs_cache_pressure` 파라메터를 통해 메모리 재할당시, 페이지 캐시를 더 많이 해제할지 vfs 관련 cache를 더 많이 해제할지 비율을 조절할 수 있다.

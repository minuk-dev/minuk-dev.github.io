<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>What If… Kube-Apiserver Could be Extended Via WebAssembly?</title><style>html body{font-family:raleway,sans-serif;background-color:#fff}:root{--accent:#00a3d2;--border-width:5px}</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/copy-btn.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=/js/copy-btn.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98056974-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-98056974-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta name=google-site-verification content="g_3tJyj-KkW-_wKx7Ij5GimHV1nKPZXetCz8ydbBAfA"></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>What If… Kube-Apiserver Could be Extended Via WebAssembly?
</a><button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/wiki/>Wiki</a></li><li><a href=/posts/>Posts</a></li><li><a href=/about/>About</a></li></ul></div></div></nav><main><div class=navigator style=display:flex><div style=display:flex><div class=parent-doc style=flex:none><button class="btn btn-link" onclick='(function(e){e.querySelector("a").click()})(this)'>
<i class="fa fa-arrow-left"></i>
[[kubecon]]</button></div></div></div><div><h2>What If… Kube-Apiserver Could be Extended Via WebAssembly?</h2><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/What-if-kube-apiserver-could-be-extended-via-webassembly.md><h5>created : Thu, 11 Aug 2022 01:58:52 +0900</h5><h5>modified : Thu, 11 Aug 2022 02:00:01 +0900</h5></a><a href=https://minuk.dev/tags/kubecon><kbd class=item-tag>kubecon</kbd></a>
<a href=https://minuk.dev/tags/devops><kbd class=item-tag>devops</kbd></a></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#what-is-web-assembly>What is Web Assembly?</a></li><li><a href=#webassembly-outside-of-the-browser>WebAssembly Outside of the Browser</a></li><li><a href=#kubernetes-control-plan-extensibility>Kubernetes Control Plan Extensibility</a><ul><li><a href=#dynamic-admission-controller>Dynamic Admission Controller</a></li></ul></li><li><a href=#introducting-kubewarden>Introducting Kubewarden</a><ul><li><a href=#kubewarden-policies>Kubewarden Policies</a></li><li><a href=#the-idea>The Idea</a></li></ul></li><li><a href=#what-do-we-gain>What do we gain?</a><ul><li><a href=#remove-uncertainty>Remove Uncertainty</a></li><li><a href=#limit-resource-usage>Limit Resource Usage</a></li></ul></li><li><a href=#the-poc>The POC</a><ul><li><a href=#the-biggest-challenge>The Biggest Challenge</a></li><li><a href=#poc-the-missing-details>POC: the Missing Details</a></li></ul></li><li><a href=#whats-next>What’s Next?</a><ul><li><a href=#개인-생각>개인 생각</a></li></ul></li></ul></nav></aside><div align=start class=content data-spy=scroll data-offset=20 data-target=#nav-toc style=position:relative><p><a href="https://www.youtube.com/watch?v=4CKcMZySUbc&amp;list=PLj6h78yzYM2MCEgkd8zH0vJWF7jdQ-GRR&amp;index=2">출처</a></p><h2 id=what-is-web-assembly>What is Web Assembly?</h2><ul><li>Polyglot<ul><li>Many langugages can be compiled to Wasm(Web assembly)</li></ul></li><li>Small<ul><li>Like Container</li></ul></li><li>Portable<ul><li>Can run on any architecture and any OS</li></ul></li><li>Secure<ul><li>In sandbox</li><li>Memory safety</li><li>Control-flow integrity</li><li>Runtime isolation</li></ul></li></ul><h2 id=webassembly-outside-of-the-browser>WebAssembly Outside of the Browser</h2><ul><li>A new way to build and distribute applications</li><li>Implement plugin systems</li></ul><h2 id=kubernetes-control-plan-extensibility>Kubernetes Control Plan Extensibility</h2><ul><li>Authentication and Autorization</li><li>Scheduler</li><li>Dynamic Admission Controllers</li></ul><h3 id=dynamic-admission-controller>Dynamic Admission Controller</h3><ul><li>Authentication, Authorization</li><li>Mutating admission</li><li>Schema Validation</li><li>Validating admission</li></ul><h2 id=introducting-kubewarden>Introducting Kubewarden</h2><ul><li>A policy engine for Kubernetes</li><li>Its mission is to simplify the adoption of Policy As Code.</li></ul><h3 id=kubewarden-policies>Kubewarden Policies</h3><ul><li>Written using:<ul><li>Rust, Go, AssemblyScript, Swift</li><li>Rego</li></ul></li><li>Compiled to WebAssembly</li><li>Distributed using container registries</li><li>Signed and verified using Sigstore</li></ul><h3 id=the-idea>The Idea</h3><ul><li>Define admission rules using WebAssembly modules</li><li>Extend the API server to make use of WebAssembly-based rules</li></ul><h2 id=what-do-we-gain>What do we gain?</h2><h3 id=remove-uncertainty>Remove Uncertainty</h3><ul><li>Webhooks rely on the network</li><li>The network introduces many types of failures</li><li>The network increase attack surface</li></ul><h3 id=limit-resource-usage>Limit Resource Usage</h3><ul><li>A set of Kubernetes Cusom Resource Definitions</li><li><del>The Webhook server</del></li><li><del>The Controller that reconciles the Custom Resources</del></li></ul><p>→ Great for Edge environments!</p><h2 id=the-poc>The POC</h2><ul><li>Leverage Kubewarden policies</li><li>Introduce a new Kubernetes Feature Gate capable of running them</li></ul><h3 id=the-biggest-challenge>The Biggest Challenge</h3><ul><li>Major WebAssembly runtimes are not written in pure Go</li><li>Initial approach: patch Kubernetes build system</li><li>Iteration: custom build of wasmtime-go with musl libc</li><li>Final solution, rely on the wazero runtime : pure Go, no usage of CGO</li></ul><h3 id=poc-the-missing-details>POC: the Missing Details</h3><ul><li>No support for Mutating policies</li><li>Not implemented Kubewarden features offered to policy authors:<ul><li>Policy tracing</li><li>Context aware information</li><li>Interactions with ocntainer registries</li><li>Sigstore primitives</li><li>Execute Rego policies built as WebAssembly modules</li></ul></li><li>Verify pulled policies using Sigstore</li><li>Performance testing</li></ul><h2 id=whats-next>What’s Next?</h2><hr><h3 id=개인-생각>개인 생각</h3><ul><li>Kubewarden이 Kubernetes 에서 Policy를 관리하기 위한 프로젝트라는 것을 알게 되었다. (CRD 활용)</li><li>그리고 공식 홈페이지에서부터 Kubewarden 은 Kubernetes Dynamic Admission Controller 이고 WebAssembly 로 쓰여진 정책들로 요청을 검증한다고 나와있다.</li><li>와 이거 좀.. 어지럽다. 이게 맞나? 그러니까 다양한 언어로 policy를 구성하는걸 지원하기 위해서 wasm을 선택했고 kwctl 로 wasm 으로 compile 된 policy 를 제어하는거야?</li><li>강연만 들었을때는 잘 안 와닿았는데 문서를 읽어보니까 쉽지 않다. 이게 맞는 방향인지도 잘 모르겠다.</li><li>아.. 그래서 제목이 kube-apiserver 가 wasm으로 확장된다면이구나.. 아니 이거 런타임 구조가 어떻게 되는거지? wasm이 browser 가 아니라 standalone 으로 동작하는건가? standalone program 이 있어?</li><li>일단 다시 강연을 요약하자면, wasm을 선택한건 단순히 언어 확장성, 아키텍트에 영향을 덜받는것 뿐만 아니라 sandbox 가 된다는것도 중요한 요소라고 설명하고 있다. policy 를 관리하는 거니말이다.</li><li>뿐만 아니라 Webhook 으로 동작하는 것은 Network 를 사용하기에 불확정적인 성질이 있었는데 이런 점들이 제거되었다고 한다. 아직까진 많은 해결해야할 문제들이 남아있다곤 한다.</li></ul></div><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer>
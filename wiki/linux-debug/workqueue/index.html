<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.140.0"><meta name=description content="minuk.dev wiki"><meta name=keywords content="hugo,site,new"><meta name=author content="Min-Uk.Lee"><title>linux-debug/workqueue |
minuk dev wiki
</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></head><body><header class=header><div class=header_left><a href=/><img class=logo src=/images/Rb.png alt=logo>
MinUk.Dev</a></div><div class=header_middle>linux-debug/workqueue -
minuk dev wiki</div></header><main><aside class=sidebar><ul class=section-tree><li class="dir opened-dir"><span class=dir-text>Front Page</span><ul class=section-tree><li class=file><a href=https://minuk.dev/wiki/daily/2025-01-13/ title=./wiki/daily/2025-01-13/>2025-01-13</a></li><li class=file><a href=https://minuk.dev/wiki/kubernetes-community-day-korea/ title=./wiki/kubernetes-community-day-korea/>Kubernetes Community Day 2024</a></li><li class=file><a href=https://minuk.dev/wiki/observability-engineering-kr/ title=./wiki/observability-engineering-kr/>Observability Engineering</a></li><li class=file><a href=https://minuk.dev/wiki/learning-opentelemetry/ title=./wiki/learning-opentelemetry/>Learning OpenTelemetry</a></li><li class=file><a href=https://minuk.dev/wiki/prometheus-native-histograms-in-production/ title=./wiki/prometheus-native-histograms-in-production/>prometheus-native-histograms-in-proudction</a></li><li class=file><a href=https://minuk.dev/wiki/making-sense-of-your-vital-signals-the-future-of-pod-and-containers-monitoring/ title=./wiki/making-sense-of-your-vital-signals-the-future-of-pod-and-containers-monitoring/>Making Sense of Your Vital Signals - The Future of Pod and Containers Monitoring</a></li><li class=file><a href=https://minuk.dev/wiki/defining-a-common-observability-query-language-and-other-observability-tag-updates/ title=./wiki/defining-a-common-observability-query-language-and-other-observability-tag-updates/>Defining A Common Observability Query Language and Other observability TAG Updates</a></li><li class=file><a href=https://minuk.dev/wiki/beyond-tracing-what-do-we-do-with-all-this-data/ title=./wiki/beyond-tracing-what-do-we-do-with-all-this-data/>Beyond Tracing - What do we do with all this data</a></li><li class=file><a href=https://minuk.dev/wiki/grafanacon/ title=./wiki/grafanacon/>grafanacon</a></li><li class=file><a href=https://minuk.dev/wiki/observability-engineering/ title=./wiki/observability-engineering/>Observability Engineering</a></li><li class=file><a href=https://minuk.dev/wiki/rust/ title=./wiki/rust/>rust</a></li><li class=file><a href=https://minuk.dev/wiki/opentelemetry-metrics-deep-dive/ title=./wiki/opentelemetry-metrics-deep-dive/>opentelemetry metrics deep dive</a></li><li class=file><a href=https://minuk.dev/wiki/armeria/ title=./wiki/armeria/>armeria</a></li><li class=file><a href=https://minuk.dev/wiki/kotlin/ title=./wiki/kotlin/>kotlin</a></li><li class=file><a href=https://minuk.dev/wiki/loki-best-practices/ title=./wiki/loki-best-practices/>loki label best practices</a></li><li class=file><a href=https://minuk.dev/wiki/loki/ title=./wiki/loki/>loki</a></li><li class=file><a href=https://minuk.dev/wiki/grafana-loki-like-prometheus-but-for-logs/ title=./wiki/grafana-loki-like-prometheus-but-for-logs/>Grafana Loki - Like Prometheus, But for logs.</a></li><li class=file><a href=https://minuk.dev/wiki/spring-boot-cli/ title=./wiki/spring-boot-cli/>spring boot cli</a></li><li class=file><a href=https://minuk.dev/wiki/autoconf/ title=./wiki/autoconf/>autoconf</a></li><li class=file><a href=https://minuk.dev/wiki/re-minuk-k8s/ title=./wiki/re-minuk-k8s/>다시 시작하는 쿠버네티스 세팅</a></li><li class=file><a href=https://minuk.dev/wiki/cloud-native-go/ title=./wiki/cloud-native-go/>Cloud Native Go</a></li><li class=file><a href=https://minuk.dev/wiki/overlayfs/ title=./wiki/overlayfs/>overlayfs</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/design-pattern/ title=./wiki/lectures/design-pattern/>lectures/design-pattern</a></li><li class=file><a href=https://minuk.dev/wiki/site-reliability-engineering/ title=./wiki/site-reliability-engineering/>사이트 신뢰성 엔지니어링</a></li><li class=file><a href=https://minuk.dev/wiki/to-ipv6-the-dual-stack-adoption-advisory-panel/ title=./wiki/to-ipv6-the-dual-stack-adoption-advisory-panel/>To IPv6 - The Dual-stack Adoption Advisory Panel</a></li><li class=file><a href=https://minuk.dev/wiki/prometheus-intro-and-deep-dive/ title=./wiki/prometheus-intro-and-deep-dive/>Prometheus Intro and Deep Dive</a></li><li class=file><a href=https://minuk.dev/wiki/cs/ title=./wiki/cs/>cs 기본</a></li><li class=file><a href=https://minuk.dev/wiki/coredns/ title=./wiki/coredns/>learning-coredns</a></li><li class=file><a href=https://minuk.dev/wiki/coredns-into-and-deep-dive/ title=./wiki/coredns-into-and-deep-dive/>CoreDNS - Intro and Deep Dive</a></li><li class=file><a href=https://minuk.dev/wiki/deep-dive-into-minikube/ title=./wiki/deep-dive-into-minikube/>Deep Dive into Minikube</a></li><li class=file><a href=https://minuk.dev/wiki/making-your-apps-and-infrastructure-services-failure-resilient-with-dapr/ title=./wiki/making-your-apps-and-infrastructure-services-failure-resilient-with-dapr/>Making Your Apps and Infrastructure Services Failure-Resilient with Dapr</a></li><li class=file><a href=https://minuk.dev/wiki/make-cloud-native-chaos-engineering-easier-deep-dive-into-chaos-mesh/ title=./wiki/make-cloud-native-chaos-engineering-easier-deep-dive-into-chaos-mesh/>Make Cloud Native Chaos Engineering Easier Deep Dive into Chaos Mesh</a></li><li class=file><a href=https://minuk.dev/wiki/selinux/ title=./wiki/selinux/>selinux</a></li><li class=file><a href=https://minuk.dev/wiki/http-go/ title=./wiki/http-go/>go snippet for go</a></li><li class=file><a href=https://minuk.dev/wiki/curl/ title=./wiki/curl/>curl</a></li><li class=file><a href=https://minuk.dev/wiki/volcano-intro-and-deep-dive/ title=./wiki/volcano-intro-and-deep-dive/>Volcano - Intro & Deep Dive</a></li><li class=file><a href=https://minuk.dev/wiki/intro-to-kubernetes-gitops-and-observability-hands-on-tutorial/ title=./wiki/intro-to-kubernetes-gitops-and-observability-hands-on-tutorial/>Intro to Kubernetes, GitOps, and Observability Hands-On Tutorial</a></li><li class=file><a href=https://minuk.dev/wiki/kubespray/ title=./wiki/kubespray/>kubespray</a></li><li class=file><a href=https://minuk.dev/wiki/spark-on-kubernetes-the-elastic-story/ title=./wiki/spark-on-kubernetes-the-elastic-story/>Spark on Kubernetes - The Elastic Story</a></li><li class=file><a href=https://minuk.dev/wiki/devops%EC%99%80-se%EB%A5%BC-%EC%9C%84%ED%95%9C-%EB%A6%AC%EB%88%85%EC%8A%A4-%EC%BB%A4%EB%84%90-%EC%9D%B4%EC%95%BC%EA%B8%B0/ title=./wiki/devops%EC%99%80-se%EB%A5%BC-%EC%9C%84%ED%95%9C-%EB%A6%AC%EB%88%85%EC%8A%A4-%EC%BB%A4%EB%84%90-%EC%9D%B4%EC%95%BC%EA%B8%B0/>DevOps와 SE를 위한 리눅스 커널 이야기</a></li><li class=file><a href=https://minuk.dev/wiki/running-containerd-and-k3s-on-macos/ title=./wiki/running-containerd-and-k3s-on-macos/>Running Containerd and k3s on MacOS</a></li><li class=file><a href=https://minuk.dev/wiki/twelve-factor-app/ title=./wiki/twelve-factor-app/>12요소 어플리케이션</a></li><li class=file><a href=https://minuk.dev/wiki/vim-go/ title=./wiki/vim-go/>vim/vim-go</a></li><li class=file><a href=https://minuk.dev/wiki/kubernetes-patterns/ title=./wiki/kubernetes-patterns/>쿠버네티스 패턴</a></li><li class=file><a href=https://minuk.dev/wiki/horizontalpodautoscaler/ title=./wiki/horizontalpodautoscaler/>Horizontal Pod AutoScaler</a></li><li class=file><a href=https://minuk.dev/wiki/what-if-kube-apiserver-could-be-extended-via-webassembly/ title=./wiki/what-if-kube-apiserver-could-be-extended-via-webassembly/>What If… Kube-Apiserver Could be Extended Via WebAssembly?</a></li><li class=file><a href=https://minuk.dev/wiki/the-future-of-reproducible-research-powered-by-kubeflow/ title=./wiki/the-future-of-reproducible-research-powered-by-kubeflow/>The Future Of Reproducible Research - Powered by Kubeflow</a></li><li class=file><a href=https://minuk.dev/wiki/this-is-the-way-a-crash-course-on-intricacies-of-managing-cpus/ title=./wiki/this-is-the-way-a-crash-course-on-intricacies-of-managing-cpus/>This is The Way- A Crash Course on the Intricacies of Managing CPUs in K8s</a></li><li class=file><a href=https://minuk.dev/wiki/kubernetes-graceful-shutdown/ title=./wiki/kubernetes-graceful-shutdown/>kubernetes-graceful-shutdown</a></li><li class=file><a href=https://minuk.dev/wiki/dockerfile/ title=./wiki/dockerfile/>dockerfile</a></li><li class=file><a href=https://minuk.dev/wiki/automated-progressive-delivery-using-gitops-and-service-mesh/ title=./wiki/automated-progressive-delivery-using-gitops-and-service-mesh/>Automated Progressive Delivery Using GitOps and Service Mesh</a></li><li class=file><a href=https://minuk.dev/wiki/containerd-proejct-update-and-deep-dive/ title=./wiki/containerd-proejct-update-and-deep-dive/>containerd Project Update and Deep Dive</a></li><li class=file><a href=https://minuk.dev/wiki/http2/ title=./wiki/http2/>http2 탐구</a></li><li class=file><a href=https://minuk.dev/wiki/grpc-for-microservices/ title=./wiki/grpc-for-microservices/>gRPC For Microservices Service-mesh and Observability</a></li><li class=file><a href=https://minuk.dev/wiki/kubecon/ title=./wiki/kubecon/>kubecon</a></li><li class=file><a href=https://minuk.dev/wiki/go-http/ title=./wiki/go-http/>go-http</a></li><li class=file><a href=https://minuk.dev/wiki/go/ title=./wiki/go/>go</a></li><li class=file><a href=https://minuk.dev/wiki/cri/ title=./wiki/cri/>CRI(Container Runtime Interface)</a></li><li class=file><a href=https://minuk.dev/wiki/vagrant/ title=./wiki/vagrant/>vagrant</a></li><li class=file><a href=https://minuk.dev/wiki/jsonpath/ title=./wiki/jsonpath/>jsonpath</a></li><li class=file><a href=https://minuk.dev/wiki/systemctl/ title=./wiki/systemctl/>systemctl 중요한것만 정리</a></li><li class=file><a href=https://minuk.dev/wiki/init/ title=./wiki/init/>linux init 요약</a></li><li class=file><a href=https://minuk.dev/wiki/process-cli/ title=./wiki/process-cli/>process 관련된 명령어 모음</a></li><li class=file><a href=https://minuk.dev/wiki/process-status/ title=./wiki/process-status/>process-status</a></li><li class=file><a href=https://minuk.dev/wiki/teamnote-go/ title=./wiki/teamnote-go/>teamnote-go</a></li><li class=file><a href=https://minuk.dev/wiki/cgroups/ title=./wiki/cgroups/>cgroup</a></li><li class=file><a href=https://minuk.dev/wiki/namespaces/ title=./wiki/namespaces/>namespaces</a></li><li class=file><a href=https://minuk.dev/wiki/lxc/ title=./wiki/lxc/>LXC</a></li><li class=file><a href=https://minuk.dev/wiki/devops/ title=./wiki/devops/>devops</a></li><li class=file><a href=https://minuk.dev/wiki/ringle/supply-and-demand/ title=./wiki/ringle/supply-and-demand/>Supply and Demand</a></li><li class=file><a href=https://minuk.dev/wiki/ringle/the-metaverse/ title=./wiki/ringle/the-metaverse/>ringle/The metaverse</a></li><li class=file><a href=https://minuk.dev/wiki/ringle/microsoft-x-activision-blizzard/ title=./wiki/ringle/microsoft-x-activision-blizzard/>ringle/Microsoft x Activision Blizzard</a></li><li class=file><a href=https://minuk.dev/wiki/topcit/ title=./wiki/topcit/>topcit 간략 공부</a></li><li class=file><a href=https://minuk.dev/wiki/software-engineering-at-google/ title=./wiki/software-engineering-at-google/>구글 엔지니어는 이렇게 일한다</a></li><li class=file><a href=https://minuk.dev/wiki/k8s-in-rpi/ title=./wiki/k8s-in-rpi/>k8s-in-rpi</a></li><li class=file><a href=https://minuk.dev/wiki/kubernetes/ title=./wiki/kubernetes/>kubernetes</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/numerical_analysis/ title=./wiki/lectures/numerical_analysis/>수치해석</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/information_security_theory/ title=./wiki/lectures/information_security_theory/>2022-1 정보보호이론</a></li><li class=file><a href=https://minuk.dev/wiki/%EC%A0%9C%ED%85%94%EC%B9%B4%EC%8A%A4%ED%85%90/ title=./wiki/%EC%A0%9C%ED%85%94%EC%B9%B4%EC%8A%A4%ED%85%90/>제텔카스텐</a></li><li class=file><a href=https://minuk.dev/wiki/%EB%A7%81%EA%B8%80/autonomous/ title=./wiki/%EB%A7%81%EA%B8%80/autonomous/>링글/Autonomous</a></li><li class=file><a href=https://minuk.dev/wiki/%EB%A7%81%EA%B8%80/metaverse/ title=./wiki/%EB%A7%81%EA%B8%80/metaverse/>링글/Metaverse</a></li><li class=file><a href=https://minuk.dev/wiki/algorithm/ title=./wiki/algorithm/>algorithm</a></li><li class=file><a href=https://minuk.dev/wiki/study-note/ title=./wiki/study-note/>study-note</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/machine-learning/ title=./wiki/lectures/machine-learning/>2022 1학기 머신러닝</a></li><li class=file><a href=https://minuk.dev/wiki/kubernetes-in-action/ title=./wiki/kubernetes-in-action/>Kubernetes in action</a></li><li class=file><a href=https://minuk.dev/wiki/effective-java/ title=./wiki/effective-java/>Effective Java</a></li><li class=file><a href=https://minuk.dev/wiki/kafka/ title=./wiki/kafka/>Kafka</a></li><li class=file><a href=https://minuk.dev/wiki/%EB%A9%B4%EC%A0%91%EC%A4%80%EB%B9%84/ title=./wiki/%EB%A9%B4%EC%A0%91%EC%A4%80%EB%B9%84/>면접 준비 자료</a></li><li class=file><a href=https://minuk.dev/wiki/zsh/ title=./wiki/zsh/>zsh</a></li><li class=file><a href=https://minuk.dev/wiki/simple-file/ title=./wiki/simple-file/>Simple한 File Server</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2021-12-03/ title=./wiki/%ED%9A%8C%EA%B3%A0/2021-12-03/>회고/2021-12-03</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/bayesian/week3/ title=./wiki/lectures/bayesian/week3/>bayesian/week3</a></li><li class=file><a href=https://minuk.dev/wiki/jupyter/ title=./wiki/jupyter/>jupyter notebook</a></li><li class=file><a href=https://minuk.dev/wiki/ffmpeg/ title=./wiki/ffmpeg/>ffmpeg 를 사용한 convert 요약</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/bayesian/week2/ title=./wiki/lectures/bayesian/week2/>bayesian/week2</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/bayesian/week1/ title=./wiki/lectures/bayesian/week1/>bayesian/week1</a></li><li class=file><a href=https://minuk.dev/wiki/pdf-test/ title=./wiki/pdf-test/>pdf-test</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/automata/ title=./wiki/lectures/automata/>오토마타와 형식언어 정리</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/computer-communication/ title=./wiki/lectures/computer-communication/>컴퓨터통신</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/introduction-to-statistical-learning/ title=./wiki/lectures/introduction-to-statistical-learning/>통계학습개론(Introduction to statistical learnning) 수업 정리</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/bayesian-statistics/ title=./wiki/lectures/bayesian-statistics/>베이지안 통계학(Bayesian Statistics)</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/multi-variant-statistical-analysis/ title=./wiki/lectures/multi-variant-statistical-analysis/>Multi Variant Statistical Analysis</a></li><li class=file><a href=https://minuk.dev/wiki/comment/ title=./wiki/comment/>주석 관련 좋은 글</a></li><li class=file><a href=https://minuk.dev/wiki/ssh/ title=./wiki/ssh/>ssh 관련 명령어 모음</a></li><li class=file><a href=https://minuk.dev/wiki/msk/ title=./wiki/msk/>amazon msk 삽질</a></li><li class=file><a href=https://minuk.dev/wiki/keras-book/ title=./wiki/keras-book/>케라스 창시자에게 배우는 딥러닝 책 공부</a></li><li class=file><a href=https://minuk.dev/wiki/msa-from-ddd/ title=./wiki/msa-from-ddd/>도메인 주도 설계로 시작하는 마이크로서비스 개발</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2021-07-18/ title=./wiki/%ED%9A%8C%EA%B3%A0/2021-07-18/>2021-07-21 회고</a></li><li class=file><a href=https://minuk.dev/wiki/iamroot19/ title=./wiki/iamroot19/>아이엠루트 스터디 자료 정리</a></li><li class=file><a href=https://minuk.dev/wiki/boj-9019/ title=./wiki/boj-9019/>boj-9019</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2021-06-19/ title=./wiki/%ED%9A%8C%EA%B3%A0/2021-06-19/>2021년 6월 19일 회고</a></li><li class=file><a href=https://minuk.dev/wiki/%EB%8F%85%EC%84%B1%EB%A7%90%ED%88%AC/ title=./wiki/%EB%8F%85%EC%84%B1%EB%A7%90%ED%88%AC/>독성말투</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/regression/ title=./wiki/lectures/regression/>Regression Analysis</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%94%BC%EC%8B%9C%EC%8B%A4/ title=./wiki/%ED%94%BC%EC%8B%9C%EC%8B%A4/>피시실</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/multicore/ title=./wiki/lectures/multicore/>Multicore Computing</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/ns3/ title=./wiki/lectures/ns3/>Network Simulator 3</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/nonparametric-statistic/ title=./wiki/lectures/nonparametric-statistic/>비모수 통계학</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/wireless/ title=./wiki/lectures/wireless/>wireless 무선이동통신 수업</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/database_system/ title=./wiki/lectures/database_system/>Database System</a></li><li class=file><a href=https://minuk.dev/wiki/%EC%B9%B4%EC%B9%B4%EC%98%A4%EC%9B%8C%ED%81%AC/ title=./wiki/%EC%B9%B4%EC%B9%B4%EC%98%A4%EC%9B%8C%ED%81%AC/>카카오워크</a></li><li class=file><a href=https://minuk.dev/wiki/soma/ title=./wiki/soma/>소프트웨어 마에스트로</a></li><li class=file><a href=https://minuk.dev/wiki/linux_kakaotalk/ title=./wiki/linux_kakaotalk/>리눅스 카카오톡</a></li><li class=file><a href=https://minuk.dev/wiki/latina/ title=./wiki/latina/>라틴어</a></li><li class=file><a href=https://minuk.dev/wiki/blk-mq/ title=./wiki/blk-mq/>Multi-Queue Block IO Queueing (blk-mq)</a></li><li class=file><a href=https://minuk.dev/wiki/linux-study/ title=./wiki/linux-study/>linux-study</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-12-20/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-12-20/>2020-12-20 회고</a></li><li class=file><a href=https://minuk.dev/wiki/linux-debug/scheduling/ title=./wiki/linux-debug/scheduling/>linux-debug/scheduling</a></li><li class=file><a href=https://minuk.dev/wiki/linux-debug/synchronization/ title=./wiki/linux-debug/synchronization/>linux-debug/synchronization</a></li><li class=file><a href=https://minuk.dev/wiki/linux-debug/timer/ title=./wiki/linux-debug/timer/>linux-debug/timer</a></li><li class=file><a href=https://minuk.dev/wiki/linux-debug/workqueue/ title=./wiki/linux-debug/workqueue/>linux-debug/workqueue</a></li><li class=file><a href=https://minuk.dev/wiki/linux-debug/interrupt/ title=./wiki/linux-debug/interrupt/>linux-debug/interrupt</a></li><li class=file><a href=https://minuk.dev/wiki/linux-debug/process/ title=./wiki/linux-debug/process/>linux-debug/process</a></li><li class=file><a href=https://minuk.dev/wiki/input-method/ title=./wiki/input-method/>linux input-method 삽질</a></li><li class=file><a href=https://minuk.dev/wiki/assembly/ title=./wiki/assembly/>assembly</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-10-24/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-10-24/>2020-10-24 회고</a></li><li class=file><a href=https://minuk.dev/wiki/contextmenu/ title=./wiki/contextmenu/>contextmenu</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-10-09/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-10-09/>2020-10-09 회고</a></li><li class=file><a href=https://minuk.dev/wiki/others/ title=./wiki/others/>others</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-09-18/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-09-18/>2020-09-18 회고</a></li><li class=file><a href=https://minuk.dev/wiki/seccomp/ title=./wiki/seccomp/>seccomp</a></li><li class=file><a href=https://minuk.dev/wiki/debug-linux/ title=./wiki/debug-linux/>디버깅을 통해 배우는 리눅스 커널의 구조와 원리</a></li><li class=file><a href=https://minuk.dev/wiki/fuse/ title=./wiki/fuse/>Filesystem in Userspace</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-08-30/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-08-30/>회고/2020-08-30</a></li><li class=file><a href=https://minuk.dev/wiki/raid/ title=./wiki/raid/>RAID(Redundant Array of Independent Disks)</a></li><li class=file><a href=https://minuk.dev/wiki/storage/ title=./wiki/storage/>Storage</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-08-17/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-08-17/>2020-08-17 회고</a></li><li class=file><a href=https://minuk.dev/wiki/teamnote/ title=./wiki/teamnote/>teamnote</a></li><li class=file><a href=https://minuk.dev/wiki/git/ title=./wiki/git/>git</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-07-31/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-07-31/>2020년 7월 31일자 회고</a></li><li class=file><a href=https://minuk.dev/wiki/3%EA%B3%B5%EB%85%B8%ED%8A%B8/ title=./wiki/3%EA%B3%B5%EB%85%B8%ED%8A%B8/>3공 노트</a></li><li class=file><a href=https://minuk.dev/wiki/nas/ title=./wiki/nas/>NAS</a></li><li class=file><a href=https://minuk.dev/wiki/lfs/ title=./wiki/lfs/>LFS Paper</a></li><li class=file><a href=https://minuk.dev/wiki/ftl/ title=./wiki/ftl/>Flash Translation Layer</a></li><li class=file><a href=https://minuk.dev/wiki/ppn/ title=./wiki/ppn/>PPN(Physical Page Number)</a></li><li class=file><a href=https://minuk.dev/wiki/lpn/ title=./wiki/lpn/>LPN(Logical Page Number)</a></li><li class=file><a href=https://minuk.dev/wiki/load-balance/ title=./wiki/load-balance/>Load Balance</a></li><li class=file><a href=https://minuk.dev/wiki/cache/ title=./wiki/cache/>Cache</a></li><li class=file><a href=https://minuk.dev/wiki/uart/ title=./wiki/uart/>UART (Universal asynchronous receiver/transmitter)</a></li><li class=file><a href=https://minuk.dev/wiki/vhdci/ title=./wiki/vhdci/>VHDCI (Very-high-dencity cable interconnect)</a></li><li class=file><a href=https://minuk.dev/wiki/boxplot/ title=./wiki/boxplot/>boxplot</a></li><li class=file><a href=https://minuk.dev/wiki/quartile/ title=./wiki/quartile/>quartile (사분위수)</a></li><li class=file><a href=https://minuk.dev/wiki/statistics/ title=./wiki/statistics/>statistics</a></li><li class=file><a href=https://minuk.dev/wiki/fsm/ title=./wiki/fsm/>FSM (Finite State machine)</a></li><li class=file><a href=https://minuk.dev/wiki/open-nvm/ title=./wiki/open-nvm/>open-nvm</a></li><li class=file><a href=https://minuk.dev/wiki/mram/ title=./wiki/mram/>MRAM (Magnetic Random Access Memory)</a></li><li class=file><a href=https://minuk.dev/wiki/file/ title=./wiki/file/>vfs - file</a></li><li class=file><a href=https://minuk.dev/wiki/kiocb/ title=./wiki/kiocb/>kiocb</a></li><li class=file><a href=https://minuk.dev/wiki/vfs/ title=./wiki/vfs/>VFS-Virtual File System</a></li><li class=file><a href=https://minuk.dev/wiki/linux/ title=./wiki/linux/>linux</a></li><li class=file><a href=https://minuk.dev/wiki/f2fs-paper/ title=./wiki/f2fs-paper/>F2FS- A New File System for Flash Storage</a></li><li class=file><a href=https://minuk.dev/wiki/english/proverb/ title=./wiki/english/proverb/>english/proverb</a></li><li class=file><a href=https://minuk.dev/wiki/english/ title=./wiki/english/>english</a></li><li class=file><a href=https://minuk.dev/wiki/tool/ title=./wiki/tool/>tool</a></li><li class=file><a href=https://minuk.dev/wiki/verilog/ title=./wiki/verilog/>verilog (베릴로그)</a></li><li class=file><a href=https://minuk.dev/wiki/iommu/ title=./wiki/iommu/>IOMMU (Input Output Memory Management Unit)</a></li><li class=file><a href=https://minuk.dev/wiki/delayed_work/ title=./wiki/delayed_work/>delayed work</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-06-21/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-06-21/>회고/2020-06-21</a></li><li class=file><a href=https://minuk.dev/wiki/jwt/ title=./wiki/jwt/>json web token(jwt)</a></li><li class=file><a href=https://minuk.dev/wiki/tmuxinator/ title=./wiki/tmuxinator/>tmuxinator</a></li><li class=file><a href=https://minuk.dev/wiki/vim-staritfy/ title=./wiki/vim-staritfy/>vim-startify</a></li><li class=file><a href=https://minuk.dev/wiki/my-page/ title=./wiki/my-page/>my-page (나만의 홈페이지 만들기)</a></li><li class=file><a href=https://minuk.dev/wiki/blk_mq/ title=./wiki/blk_mq/>blk_mq</a></li><li class=file><a href=https://minuk.dev/wiki/prp/ title=./wiki/prp/>PRP (Physical Region Page)</a></li><li class=file><a href=https://minuk.dev/wiki/numa/ title=./wiki/numa/>NUMA</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-06-17/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-06-17/>회고/2020-06-17</a></li><li class=file><a href=https://minuk.dev/wiki/block-layer/ title=./wiki/block-layer/>block layer</a></li><li class=file><a href=https://minuk.dev/wiki/workqueue/ title=./wiki/workqueue/>workqueue</a></li><li class=file><a href=https://minuk.dev/wiki/nvme/ title=./wiki/nvme/>nvme</a></li><li class=file><a href=https://minuk.dev/wiki/gem5/ title=./wiki/gem5/>gem5</a></li><li class=file><a href=https://minuk.dev/wiki/simplessd/ title=./wiki/simplessd/>simple-ssd</a></li><li class=file><a href=https://minuk.dev/wiki/mmap/ title=./wiki/mmap/>mmap</a></li><li class=file><a href=https://minuk.dev/wiki/b+tree/ title=./wiki/b+tree/>B+ Tree</a></li><li class=file><a href=https://minuk.dev/wiki/database/ title=./wiki/database/>Database</a></li><li class=file><a href=https://minuk.dev/wiki/memory-cache-clean/ title=./wiki/memory-cache-clean/>memory cache 비우기 (linux command)</a></li><li class=file><a href=https://minuk.dev/wiki/free/ title=./wiki/free/>free (linux command)</a></li><li class=file><a href=https://minuk.dev/wiki/clflush/ title=./wiki/clflush/>clflush (cache line flush)</a></li><li class=file><a href=https://minuk.dev/wiki/c++/ title=./wiki/c++/>C++ Language</a></li><li class=file><a href=https://minuk.dev/wiki/%EC%82%AC%EC%A7%80%EB%B0%A9/ title=./wiki/%EC%82%AC%EC%A7%80%EB%B0%A9/>사지방</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/3%EC%9B%94/ title=./wiki/%ED%9A%8C%EA%B3%A0/3%EC%9B%94/>2020년 3월 회고</a></li><li class=file><a href=https://minuk.dev/wiki/mysql/ title=./wiki/mysql/>mysql (storage engine)</a></li><li class=file><a href=https://minuk.dev/wiki/block-group/ title=./wiki/block-group/>block group</a></li><li class=file><a href=https://minuk.dev/wiki/journal/ title=./wiki/journal/>journal(journaling)</a></li><li class=file><a href=https://minuk.dev/wiki/group-descriptor-table/ title=./wiki/group-descriptor-table/>group descriptor table</a></li><li class=file><a href=https://minuk.dev/wiki/inode/ title=./wiki/inode/>inode</a></li><li class=file><a href=https://minuk.dev/wiki/superblock/ title=./wiki/superblock/>Superblock</a></li><li class=file><a href=https://minuk.dev/wiki/ext4/ title=./wiki/ext4/>The new ext4 filesystem: current status and future plans</a></li><li class=file><a href=https://minuk.dev/wiki/%EA%B3%84%EB%A3%A1-%EA%B0%9C%EB%B0%9C-%EB%AA%A8%EC%9E%84/ title=./wiki/%EA%B3%84%EB%A3%A1-%EA%B0%9C%EB%B0%9C-%EB%AA%A8%EC%9E%84/>계룡 개발 모임</a></li><li class=file><a href=https://minuk.dev/wiki/ssd/ title=./wiki/ssd/>SSD</a></li><li class=file><a href=https://minuk.dev/wiki/gutentags/ title=./wiki/gutentags/>gutentags</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-18--%EB%A9%94%EB%A9%98%ED%86%A0/ title=./wiki/modern-c++-design-pattern/chapter-18--%EB%A9%94%EB%A9%98%ED%86%A0/>Modern C++ Design Pattern/Chatper 18. 메멘토</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-17--%EB%A7%A4%EA%B0%9C%EC%9E%90/ title=./wiki/modern-c++-design-pattern/chapter-17--%EB%A7%A4%EA%B0%9C%EC%9E%90/>Modern C++ Design Pattern/Chatper 17. 매개자</a></li><li class=file><a href=https://minuk.dev/wiki/boj/ title=./wiki/boj/>boj</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-16--%EB%B0%98%EB%B3%B5%EC%9E%90/ title=./wiki/modern-c++-design-pattern/chapter-16--%EB%B0%98%EB%B3%B5%EC%9E%90/>Modern C++ Design Pattern/Chatper 16. 반복자</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-04-20/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-04-20/>회고/2020.04.20</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-15--%EC%9D%B8%ED%84%B0%ED%94%84%EB%A6%AC%ED%84%B0/ title=./wiki/modern-c++-design-pattern/chapter-15--%EC%9D%B8%ED%84%B0%ED%94%84%EB%A6%AC%ED%84%B0/>Modern C++ Design Pattern/Chatper 15. 인터프리터</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-14--%EC%BB%A4%EB%A7%A8%EB%93%9C/ title=./wiki/modern-c++-design-pattern/chapter-14--%EC%BB%A4%EB%A7%A8%EB%93%9C/>Modern C++ Design Pattern/Chatper 14. 커맨드</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-13--%EC%B1%85%EC%9E%84%EC%82%AC%EC%8A%ACchain-of-responsibility/ title=./wiki/modern-c++-design-pattern/chapter-13--%EC%B1%85%EC%9E%84%EC%82%AC%EC%8A%ACchain-of-responsibility/>Modern C++ Design Pattern/Chatper 13. 책임사슬(Chain of Responsibility)</a></li><li class=file><a href=https://minuk.dev/wiki/coc/ title=./wiki/coc/>coc (vim plugin coc)</a></li><li class=file><a href=https://minuk.dev/wiki/regex/ title=./wiki/regex/>Regular Expression (regex)</a></li><li class=file><a href=https://minuk.dev/wiki/glob/ title=./wiki/glob/>glob</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-12--%ED%94%84%EB%A1%9D%EC%8B%9C/ title=./wiki/modern-c++-design-pattern/chapter-12--%ED%94%84%EB%A1%9D%EC%8B%9C/>Modern C++ Design Pattern/Chapter 12. 프록시</a></li><li class=file><a href=https://minuk.dev/wiki/hugo/ title=./wiki/hugo/>hugo</a></li><li class=file><a href=https://minuk.dev/wiki/tee/ title=./wiki/tee/>tee (Linux Command)</a></li><li class=file><a href=https://minuk.dev/wiki/rm/ title=./wiki/rm/>rm (Linux Command)</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-11--%ED%94%8C%EB%9D%BC%EC%9D%B4%EC%9B%A8%EC%9D%B4%ED%8A%B8/ title=./wiki/modern-c++-design-pattern/chapter-11--%ED%94%8C%EB%9D%BC%EC%9D%B4%EC%9B%A8%EC%9D%B4%ED%8A%B8/>Modern C++ Design Pattern/Chapter 11. 플라이웨이트</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-10--%ED%8D%BC%EC%82%AC%EB%93%9C/ title=./wiki/modern-c++-design-pattern/chapter-10--%ED%8D%BC%EC%82%AC%EB%93%9C/>Modern C++ Design Pattern/Chapter 10. 퍼사드</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chapter-7--%EC%8B%A4%ED%96%89-%EC%8B%9C%EA%B0%84-%EA%B8%B0%EB%B2%95/ title=./wiki/effective-debugging/chapter-7--%EC%8B%A4%ED%96%89-%EC%8B%9C%EA%B0%84-%EA%B8%B0%EB%B2%95/>Effective Debugging/Chatper 7. 컴파일 시간 기법</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chapter-8--%EB%A9%80%ED%8B%B0%EC%8A%A4%EB%A0%88%EB%93%9C-%EC%BD%94%EB%93%9C-%EB%94%94%EB%B2%84%EA%B9%85/ title=./wiki/effective-debugging/chapter-8--%EB%A9%80%ED%8B%B0%EC%8A%A4%EB%A0%88%EB%93%9C-%EC%BD%94%EB%93%9C-%EB%94%94%EB%B2%84%EA%B9%85/>Effective Debugging/Chatper 8. 멀티스레드 코드 디버깅</a></li><li class=file><a href=https://minuk.dev/wiki/todo/ title=./wiki/todo/>TODO Lists</a></li><li class=file><a href=https://minuk.dev/wiki/vim/ title=./wiki/vim/>vim</a></li><li class=file><a href=https://minuk.dev/wiki/vimwiki/ title=./wiki/vimwiki/>vimwiki</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-04-08/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-04-08/>회고/2020-04-08</a></li><li class=file><a href=https://minuk.dev/wiki/cloudatcost/ title=./wiki/cloudatcost/>cloudatcost</a></li><li class=file><a href=https://minuk.dev/wiki/web/ title=./wiki/web/>web</a></li><li class=file><a href=https://minuk.dev/wiki/nginx/ title=./wiki/nginx/>nginx</a></li><li class=file><a href=https://minuk.dev/wiki/understanding-linux-kernel/ title=./wiki/understanding-linux-kernel/>Understanding Linux Kernel</a></li><li class=file><a href=https://minuk.dev/wiki/mathematical-statistics/ title=./wiki/mathematical-statistics/>Mathematical Statistics</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/ title=./wiki/effective-debugging/>Effective Debugging</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chapter-1--%EA%B3%A0%EC%B0%A8%EC%9B%90-%EC%A0%84%EB%9E%B5/ title=./wiki/effective-debugging/chapter-1--%EA%B3%A0%EC%B0%A8%EC%9B%90-%EC%A0%84%EB%9E%B5/>Effective Debugging/Chapter 1. 고차원 전략</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chapter-2--%EB%B2%94%EC%9A%A9%EC%A0%81%EC%9D%B8-%EB%94%94%EB%B2%84%EA%B9%85-%EA%B8%B0%EB%B2%95/ title=./wiki/effective-debugging/chapter-2--%EB%B2%94%EC%9A%A9%EC%A0%81%EC%9D%B8-%EB%94%94%EB%B2%84%EA%B9%85-%EA%B8%B0%EB%B2%95/>Effective Debugging/Chapter 2. 범용적인 디버깅 기법</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chapter-3--%EB%B2%94%EC%9A%A9-%EB%8F%84%EA%B5%AC%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EA%B8%B0%EB%B2%95/ title=./wiki/effective-debugging/chapter-3--%EB%B2%94%EC%9A%A9-%EB%8F%84%EA%B5%AC%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EA%B8%B0%EB%B2%95/>Effective Debugging/Chapter 3. 범용 도구를 활용한 기법</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chapter-5--%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EA%B8%B0%EB%B2%95/ title=./wiki/effective-debugging/chapter-5--%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EA%B8%B0%EB%B2%95/>Effective Debugging/Chapter 5. 프로그래밍 기법</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chatper-4--%EB%94%94%EB%B2%84%EA%B1%B0-%ED%99%9C%EC%9A%A9%EB%B2%95/ title=./wiki/effective-debugging/chatper-4--%EB%94%94%EB%B2%84%EA%B1%B0-%ED%99%9C%EC%9A%A9%EB%B2%95/>Effective Debugging/Chatper 4. 디버거 활용법</a></li><li class=file><a href=https://minuk.dev/wiki/effective-debugging/chatper-6--%EC%BB%B4%ED%8C%8C%EC%9D%BC-%EC%8B%9C%EA%B0%84-%EA%B8%B0%EB%B2%95/ title=./wiki/effective-debugging/chatper-6--%EC%BB%B4%ED%8C%8C%EC%9D%BC-%EC%8B%9C%EA%B0%84-%EA%B8%B0%EB%B2%95/>Effective Debugging/Chatper 6. 컴파일 시간 기법</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/ title=./wiki/modern-c++-design-pattern/>Modern C++ Design Pattern</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-1--%EA%B0%9C%EC%9A%94/ title=./wiki/modern-c++-design-pattern/chapter-1--%EA%B0%9C%EC%9A%94/>Modern C++ Design Pattern/Chatper 1. 개요</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-2--%EB%B9%8C%EB%8D%94/ title=./wiki/modern-c++-design-pattern/chapter-2--%EB%B9%8C%EB%8D%94/>Modern C++ Design Pattern/Chatper 2. 빌더</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-4--%ED%94%84%EB%A1%9C%ED%86%A0%ED%83%80%EC%9E%85/ title=./wiki/modern-c++-design-pattern/chapter-4--%ED%94%84%EB%A1%9C%ED%86%A0%ED%83%80%EC%9E%85/>Modern C++ Design Pattern/Chatper 4. 프로토타입</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-5--%EC%8B%B1%EA%B8%80%ED%84%B4/ title=./wiki/modern-c++-design-pattern/chapter-5--%EC%8B%B1%EA%B8%80%ED%84%B4/>Modern C++ Design Pattern/Chatper 5. 싱글턴</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-6--%EC%96%B4%EB%8C%91%ED%84%B0/ title=./wiki/modern-c++-design-pattern/chapter-6--%EC%96%B4%EB%8C%91%ED%84%B0/>Modern C++ Design Pattern/Chatper 6. 어댑터</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-7--%EB%B8%8C%EB%A6%BF%EC%A7%80/ title=./wiki/modern-c++-design-pattern/chapter-7--%EB%B8%8C%EB%A6%BF%EC%A7%80/>Modern C++ Design Pattern/Chatper 7. 브릿지</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-8--%EC%BB%B4%ED%8F%AC%EC%A7%80%ED%8A%B8/ title=./wiki/modern-c++-design-pattern/chapter-8--%EC%BB%B4%ED%8F%AC%EC%A7%80%ED%8A%B8/>Modern C++ Design Pattern/Chatper 8. 컴포지트</a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-9--%EB%8D%B0%EC%BD%94%EB%A0%88%EC%9D%B4%ED%84%B0/ title=./wiki/modern-c++-design-pattern/chapter-9--%EB%8D%B0%EC%BD%94%EB%A0%88%EC%9D%B4%ED%84%B0/>Modern C++ Design Pattern/Chatper 9. 데코레이터</a></li><li class=file><a href=https://minuk.dev/wiki/book-reviews/ title=./wiki/book-reviews/>Book Review</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/algorithm/ title=./wiki/lectures/algorithm/>lectures/algorithm</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/computer-architecture/ title=./wiki/lectures/computer-architecture/>lectures/computer architecture</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/image-processing/ title=./wiki/lectures/image-processing/>lectures/image processing</a></li><li class=file><a href=https://minuk.dev/wiki/lectures/ title=./wiki/lectures/>학교 수업</a></li><li class=file><a href=https://minuk.dev/wiki/tool-configuration/ title=./wiki/tool-configuration/>Tool configuration</a></li><li class=file><a href=https://minuk.dev/wiki/ssh-server/ title=./wiki/ssh-server/>SSH Server Configuration</a></li><li class=file><a href=https://minuk.dev/wiki/firewall/ title=./wiki/firewall/>Firewall (방화벽) Configuration</a></li><li class=file><a href=https://minuk.dev/wiki/ftp/ title=./wiki/ftp/>ftp server command</a></li><li class=file><a href=https://minuk.dev/wiki/user/ title=./wiki/user/>linux user command</a></li><li class=file><a href=https://minuk.dev/wiki/brightness/ title=./wiki/brightness/>Brightness (화면 밝기 조절) command</a></li><li class=file><a href=https://minuk.dev/wiki/wifi-command-line/ title=./wiki/wifi-command-line/>Wifi commands</a></li><li class=file><a href=https://minuk.dev/wiki/wifi/ title=./wiki/wifi/>Wifi commands</a></li><li class=file><a href=https://minuk.dev/wiki/linux-command/ title=./wiki/linux-command/>Linux Command 모음</a></li><li class=file><a href=https://minuk.dev/wiki/docker/ title=./wiki/docker/>docker</a></li><li class=file><a href=https://minuk.dev/wiki/sql/ title=./wiki/sql/>SQL</a></li><li class=file><a href=https://minuk.dev/wiki/typescript/function/ title=./wiki/typescript/function/>Typescript/Function</a></li><li class=file><a href=https://minuk.dev/wiki/typescript/class/ title=./wiki/typescript/class/>Typescript/Class</a></li><li class=file><a href=https://minuk.dev/wiki/typescript/interface/ title=./wiki/typescript/interface/>Typescript/Interface</a></li><li class=file><a href=https://minuk.dev/wiki/typescript/variable-declaration/ title=./wiki/typescript/variable-declaration/>Typescript/Variable Declaration</a></li><li class=file><a href=https://minuk.dev/wiki/typescript/types/ title=./wiki/typescript/types/>Typescript/Types</a></li><li class=file><a href=https://minuk.dev/wiki/typescript/ title=./wiki/typescript/>Typescript</a></li><li class=file><a href=https://minuk.dev/wiki/graphql-typescript/ title=./wiki/graphql-typescript/>graphql typescript (deprecated)</a></li><li class=file><a href=https://minuk.dev/wiki/winston/ title=./wiki/winston/>winston</a></li><li class=file><a href=https://minuk.dev/wiki/jest/ title=./wiki/jest/>Jest</a></li><li class=file><a href=https://minuk.dev/wiki/sequelize/ title=./wiki/sequelize/>Sequelize</a></li><li class=file><a href=https://minuk.dev/wiki/fetch/ title=./wiki/fetch/>Fetch 문법 간단 정리</a></li><li class=file><a href=https://minuk.dev/wiki/promise/ title=./wiki/promise/>Promise 정리</a></li><li class=file><a href=https://minuk.dev/wiki/javascript/ title=./wiki/javascript/>JavaScript</a></li><li class=file><a href=https://minuk.dev/wiki/nexus/ title=./wiki/nexus/>Nexus</a></li><li class=file><a href=https://minuk.dev/wiki/ssdsolid-state-drive/ title=./wiki/ssdsolid-state-drive/>SSD(Solid-State Drive)</a></li><li class=file><a href=https://minuk.dev/wiki/pintos/ title=./wiki/pintos/>Pintos</a></li><li class=file><a href=https://minuk.dev/wiki/%EB%B2%84%EC%8A%A4-%EC%8B%9C%EA%B0%84-%EB%A9%94%EB%AA%A8/ title=./wiki/%EB%B2%84%EC%8A%A4-%EC%8B%9C%EA%B0%84-%EB%A9%94%EB%AA%A8/>Bus 시간 메모</a></li><li class=file><a href=https://minuk.dev/wiki/5-articles-per-week/ title=./wiki/5-articles-per-week/>5 articles per week</a></li><li class=file><a href=https://minuk.dev/wiki/%EC%8D%A9%EC%96%B4%EB%B2%84%EB%A6%B0-query-language/ title=./wiki/%EC%8D%A9%EC%96%B4%EB%B2%84%EB%A6%B0-query-language/>썩어버린 Query Language</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/ title=./wiki/%ED%9A%8C%EA%B3%A0/>회고 모음</a></li><li class=file><a href=https://minuk.dev/wiki/memory_leak/ title=./wiki/memory_leak/>Javascript Memory Leak</a></li><li class=file><a href=https://minuk.dev/wiki/%EC%86%A1%ED%8E%B8%EB%8C%80%ED%9A%8C/ title=./wiki/%EC%86%A1%ED%8E%B8%EB%8C%80%ED%9A%8C/>송편 생성기 (추석 대회)</a></li><li class=file><a href=https://minuk.dev/wiki/endurable_transient_inconsistency_in_byte_addressable_persistent_b+-tree/ title=./wiki/endurable_transient_inconsistency_in_byte_addressable_persistent_b+-tree/>Endurable Transient Inconsistency in Byte Addressable Persistent B+-Tree</a></li><li class=file><a href=https://minuk.dev/wiki/ssd-%EA%B3%B5%EB%B6%80%EC%9E%90%EB%A3%8C-%EB%AA%A8%EC%9D%8C/ title=./wiki/ssd-%EA%B3%B5%EB%B6%80%EC%9E%90%EB%A3%8C-%EB%AA%A8%EC%9D%8C/>SSD 공부 자료 모음</a></li><li class=file><a href=https://minuk.dev/wiki/%EA%B0%9C%EB%B0%9C_todo/ title=./wiki/%EA%B0%9C%EB%B0%9C_todo/>개발 TODO</a></li><li class=file><a href=https://minuk.dev/wiki/f2fs/ title=./wiki/f2fs/>F2FS</a></li><li class=file><a href=https://minuk.dev/wiki/%EC%84%A4%EB%8C%80%ED%9A%8C/ title=./wiki/%EC%84%A4%EB%8C%80%ED%9A%8C/>설대회</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-01-01/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-01-01/>회고/2020-01-01</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-01-17/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-01-17/>회고/2020-01-17</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2019-11-24/ title=./wiki/%ED%9A%8C%EA%B3%A0/2019-11-24/>회고/2019.11.24</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2019-10-19/ title=./wiki/%ED%9A%8C%EA%B3%A0/2019-10-19/>회고/2019.10.19</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2019-09-19/ title=./wiki/%ED%9A%8C%EA%B3%A0/2019-09-19/>회고/2019.09.19</a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2019-09-18/ title=./wiki/%ED%9A%8C%EA%B3%A0/2019-09-18/>회고/2019.09.18</a></li><li class=file><a href=https://minuk.dev/wiki/2024-12-23/ title=./wiki/2024-12-23/></a></li><li class=file><a href=https://minuk.dev/wiki/2025-01-05/ title=./wiki/2025-01-05/></a></li><li class=file><a href=https://minuk.dev/wiki/daily/2025-01-10/ title=./wiki/daily/2025-01-10/></a></li><li class=file><a href=https://minuk.dev/wiki/daily/drawing-2025-01-05-06.04.41.excalidraw/ title=./wiki/daily/drawing-2025-01-05-06.04.41.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/daily/drawing-2025-01-05-06.04.49.excalidraw/ title=./wiki/daily/drawing-2025-01-05-06.04.49.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/daily/drawing-2025-01-05-06.04.59.excalidraw/ title=./wiki/daily/drawing-2025-01-05-06.04.59.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/drawings/drawing-2025-01-05-05.12.23.excalidraw/ title=./wiki/drawings/drawing-2025-01-05-05.12.23.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/drawings/drawing-2025-01-05-05.54.32.excalidraw/ title=./wiki/drawings/drawing-2025-01-05-05.54.32.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/drawings/drawing-2025-01-13-00.26.22.excalidraw/ title=./wiki/drawings/drawing-2025-01-13-00.26.22.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/excalidraw/test-draw/ title=./wiki/excalidraw/test-draw/></a></li><li class=file><a href=https://minuk.dev/wiki/ipad/ title=./wiki/ipad/></a></li><li class=file><a href=https://minuk.dev/wiki/jekyll-%EA%B8%B0%EB%B0%98-wiki-%EC%97%90%EC%84%9C-hugo-%EB%A1%9C-%EB%84%98%EC%96%B4%EA%B0%80%EA%B8%B0/ title=./wiki/jekyll-%EA%B8%B0%EB%B0%98-wiki-%EC%97%90%EC%84%9C-hugo-%EB%A1%9C-%EB%84%98%EC%96%B4%EA%B0%80%EA%B8%B0/></a></li><li class=file><a href=https://minuk.dev/wiki/lectures/compiler/ title=./wiki/lectures/compiler/></a></li><li class=file><a href=https://minuk.dev/wiki/lectures/signal_and_system/ title=./wiki/lectures/signal_and_system/></a></li><li class=file><a href=https://minuk.dev/wiki/macos-initialization/ title=./wiki/macos-initialization/></a></li><li class=file><a href=https://minuk.dev/wiki/modern-c++-design-pattern/chapter-3--%ED%8C%A9%ED%86%A0%EB%A6%AC/ title=./wiki/modern-c++-design-pattern/chapter-3--%ED%8C%A9%ED%86%A0%EB%A6%AC/></a></li><li class=file><a href=https://minuk.dev/wiki/test.excalidraw/ title=./wiki/test.excalidraw/></a></li><li class=file><a href=https://minuk.dev/wiki/test/ title=./wiki/test/></a></li><li class=file><a href=https://minuk.dev/wiki/ucpc_2018_%EC%98%88%EC%84%A0/ title=./wiki/ucpc_2018_%EC%98%88%EC%84%A0/></a></li><li class=file><a href=https://minuk.dev/wiki/%EB%8D%B0%EC%A4%91%EC%96%B4%EC%84%A4/ title=./wiki/%EB%8D%B0%EC%A4%91%EC%96%B4%EC%84%A4/></a></li><li class=file><a href=https://minuk.dev/wiki/%EC%9D%98%EA%B2%AC-%EB%A9%94%EB%AA%A8/ title=./wiki/%EC%9D%98%EA%B2%AC-%EB%A9%94%EB%AA%A8/></a></li><li class=file><a href=https://minuk.dev/wiki/%EC%A3%BC%EC%9E%A5-%EB%A9%94%EB%AA%A8/ title=./wiki/%EC%A3%BC%EC%9E%A5-%EB%A9%94%EB%AA%A8/></a></li><li class=file><a href=https://minuk.dev/wiki/%ED%82%A4%EC%9B%8C%EB%93%9C-%EB%A9%94%EB%AA%A8/ title=./wiki/%ED%82%A4%EC%9B%8C%EB%93%9C-%EB%A9%94%EB%AA%A8/></a></li><li class=file><a href=https://minuk.dev/wiki/%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%9A%A9/ title=./wiki/%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%9A%A9/></a></li><li class=file><a href=https://minuk.dev/wiki/%ED%9A%8C%EA%B3%A0/2020-05-30/ title=./wiki/%ED%9A%8C%EA%B3%A0/2020-05-30/></a></li><li class=file><a href=https://minuk.dev/wiki/tags/ title=./wiki/tags/>tag page</a></li></ul></li><li class=file><a href=https://minuk.dev/about/ title=./about/>about</a></li></ul></aside><aside class=exapandable></aside><article class=main><button class=sidebar-toggle-btn type=menu aria-expanded=false aria-haspopup=true>
<i class="bi bi-list"></i></button><div class=title><h1 class=title-header>linux-debug/workqueue</h1></div><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/linux-debug/workqueue.md><h5>created : Tue, 10 Nov 2020 23:56:55 +0900</h5><h5>modified : Wed, 09 Dec 2020 13:31:24 +0900</h5></a><div class=article-meta><div class="breadcumb content"><i class="bi bi-folder"></i>
Front Page
[[debug-linux]]</div></div><div class=list-terms><ul><i class="bi bi-tags" title=Tags></i>
<a href=/tags/linux-debug class=tag-btn>linux-debug</a>
<a href=/tags/workqueue class=tag-btn>workqueue</a></ul></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><ul><li><a href=#워크큐>워크큐</a></li></ul></li></ul></nav></aside><div class=content><h3 id=워크큐>워크큐</h3><ul><li>주요 키워드 : 워크, 워커스레드, 워커 풀, 풀워크큐</li><li>워크 : 워크큐를 실행하는 단위<ul><li><p>실행 처리 흐름</p><ol><li>워크 큐잉(schedule_work), insert_work)</li><li>워크 스레드 깨움(wake_up_worker)</li><li>워크 스레드 실행(process_one_work)</li></ol></li><li><p>커널 후반부를 처리하는 단위, 워 크핸들러 실행 도중 휴면 상태에 진입할 숫 있다.</p></li><li><p>워크는 워커 스레드가 실행한다.</p></li></ul></li><li>워크 스레드<ul><li>워커 스레드의 이름은 &ldquo;kworker/&rdquo; 로 시작하며, 워크큐의 종류에 다라 &ldquo;kworker/&rdquo; 다음에 번호를 부여한다.</li><li>워커 스레드 핸들러 함수는 worker_thread() 함수다.</li></ul></li><li>워커 풀<ul><li>큐잉한 워크 리스트를 관리</li><li>워커 스레드를 생성하면서 관리</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=struct%20worker_pool%20%7b%0a%20%20spinlock_t%20lock;%0a%20%20int%20cpu;%0a%20%20/*%20skip%20*/%0a%20%20struct%20list_head%20worklist;%0a%20%20int%20nr_workers;%0a%20%20/*%20skip%20*/%0a%20%20struct%20list_head%20workers;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> worker_pool {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spinlock_t</span> lock;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> cpu;
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> list_head worklist;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> nr_workers;
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> list_head workers;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li>풀워크큐<ul><li>워커 풀을 통해 워크와 워커 스레드를 관리한다.</li></ul></li></ul><h4 id=워크큐의-특징>워크큐의 특징</h4><ul><li>워커 스레드가 워커를 실행할 때는 언제든 휴면이 가능한다. 따라서 스케쥴링을 지원하는 모든 커널 함수를 쓸 수 있다.</li><li>실행 시각에 민감한 후반부를 처리하는 용도로 워크큐의 워크를 사용하는 것은 적합하지 않다. 시스템 부하에 따라 워크 핸들러의 실행 시각 시간이 달라질 수 있다.</li><li>드라이브 레벨에 서워크는 쓰기 쉽다. 워크는 work_struct 구조체 변수만 설정, 워크를 실행할 코드에 queue_work() 혹은 schedule_work() 함수만 추가하면 된다.</li><li>워크큐를 쓰면 드라이버를 조금 더 유연하게 설계 가능하다. 또한 딜레이 워크(struct delayed_work)를 제공하며, 이를 사용해 jiffies(1/HZ) 단위로 워크를 특정 시각 이후로 지연시킨 후 실행 가능</li></ul><h4 id=워크큐와-다른-인터럽트-후반부-기법과의-비교>워크큐와 다른 인터럽트 후반부 기법과의 비교</h4><ul><li>vs IRQ 스레드 방식<ul><li>스레드의 우선순위 : IRQ 스레드는 우선순위를 높여서 처리 가능</li></ul></li><li>vs Soft IRQ 방식과의 비교<ul><li>Soft IRQ는 인터럽트 발생 빈도가 높고 후반부를 빨리 처리해야하는 상황에서 사용</li><li>워크큐는 Soft IRQ에 비해 처리 속도가 느리다.</li></ul></li></ul><h4 id=워크큐-설계>워크큐 설계</h4><ul><li>인터럽트 핸들러로 빨리 처리해야 할 코드를 수행한 후 워크를 워크큐에 큐잉한다.</li><li>인터럽트 후반부로 처리해야 할 코드를 워크 핸들러에서 처리한다.</li></ul><h4 id=워크큐의-종류>워크큐의 종류</h4><h5 id=alloc_workqueue>alloc_workqueue()</h5><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#define%20alloc_workqueue%28fmt,%20flags,%20max_active,%20args...%29%20%5c%0a%20%20__alloc_workqueue_key%28%28fmt%29,%20%28flags%29,%20%28max_active%29,%20%5c%0a%20%20%20%20NULL,%20NULL,%20##args%29>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define alloc_workqueue(fmt, flags, max_active, args...) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  __alloc_workqueue_key((fmt), (flags), (max_active), \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    NULL, NULL, ##args)</span></span></span></code></pre></div></div><ul><li><p>fmt : 워크큐의 이름을 지정하며, workqueue_struct 구조체의 name 필드에 저장된다.</p></li><li><p>flags : 워크큐의 속성 정보 저장, workqueue_struct 구조체의 flags 필드에 저장.</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="enum%20%7b%0a%20%20WQ_UNBOUND%20=%201%20%3c%3c%201,%0a%20%20WQ_FREEZABLE%20=%201%20%3c%3c%202,%0a%20%20WQ_MEM_RECLAIM%20=%201%20%3c%3c%203,%0a%20%20WQ_HIGHPRI%20=%201%20%3c%3c%204,%0a%20%20WQ_CPU_INTENSIVE%20=%201%20%3c%3c%205,%0a%20%20WQ_SYSFS%20=%201%20%3c%3c%206,%0a%20%20WQ_POWER_EFFICIENT%20=%201%20%3c%3c%207,%0a%20%20/*%20skip%20*/%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>  WQ_UNBOUND <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  WQ_FREEZABLE <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  WQ_MEM_RECLAIM <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>  WQ_HIGHPRI <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>  WQ_CPU_INTENSIVE <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>  WQ_SYSFS <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>  WQ_POWER_EFFICIENT <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>max_active : workqueue_struct 구조체의 saved_max_active에 저장</p></li><li><p>workqueue_init_early 함수에서 호출됨.</p></li></ul><h5 id=7가지-워크큐>7가지 워크큐</h5><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="int%20__init%20workqueue_init_early%28void%29%0a%7b%0a%20%20int%20std_nice[NR_STD_WORKER_POOLS]%20=%20%7b%200,%20HIGHPRI_NICE_LEVEL%20%7d;%0a%20%20int%20i,%20cpu;%0a%20%20/*%20skip%20*/%0a%20%20system_wq%20=%20alloc_workqueue%28%22events%22,%200,%200%29;%0a%20%20system_highpri_wq%20=%20alloc_workqueue%28%22events_highpri%22,%20WQ_HIGHPRI,%200%29;%0a%20%20system_long_wq%20=%20alloc_workqueue%28%22events_long%22,%200,%200%29;%0a%20%20system_unbound_wq%20=%20alloc_workqueue%28%22evnets_unbound%22,%20WQ_UNBOUND,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20WQ_UNBOUND_MAX_ACTIVE%29;%0a%20%20system_freezable_wq%20=%20alloc_workqueue%28%22events_power_efficient%22,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20WQ_FREEZABLE,%200%29;%0a%20%20system_power_efficient_wq%20=%20alloc_workqueue%28%22events_power_efficient%22,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20WQ_POWER_EFFICIENT,%200%29;%0a%20%20system_freezable_power_efficient_wq%20=%0a%20%20%20%20alloc_workqueue%28%22events_freezable_power_efficient%22,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20WQ_FREEZABLE%20%7c%20WQ_POWER_EFFICIENT,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200%29;%0a%0a%20%20BUG_ON%28!system_wq%20%7c%7c%20!system_highpri_wq%20%7c%7c%20!system_long_wq%20%7c%7c%0a%20%20%20%20%20%20%20%20!system_unbound_wq%20%7c%7c%20!system_freezable_sq%20%7c%7c%0a%20%20%20%20%20%20%20%20!system_power_efficient_wq%20%7c%7c%0a%20%20%20%20%20%20%20%20!system_freezable_power_efficient_wq%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>workqueue_init_early</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> std_nice[NR_STD_WORKER_POOLS] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, HIGHPRI_NICE_LEVEL };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> i, cpu;
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  system_wq <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;events&#34;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  system_highpri_wq <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;events_highpri&#34;</span>, WQ_HIGHPRI, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  system_long_wq <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;events_long&#34;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  system_unbound_wq <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;evnets_unbound&#34;</span>, WQ_UNBOUND,
</span></span><span style=display:flex><span>                        WQ_UNBOUND_MAX_ACTIVE);
</span></span><span style=display:flex><span>  system_freezable_wq <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;events_power_efficient&#34;</span>,
</span></span><span style=display:flex><span>                        WQ_FREEZABLE, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  system_power_efficient_wq <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;events_power_efficient&#34;</span>,
</span></span><span style=display:flex><span>                        WQ_POWER_EFFICIENT, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  system_freezable_power_efficient_wq <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alloc_workqueue</span>(<span style=color:#e6db74>&#34;events_freezable_power_efficient&#34;</span>,
</span></span><span style=display:flex><span>                        WQ_FREEZABLE <span style=color:#f92672>|</span> WQ_POWER_EFFICIENT,
</span></span><span style=display:flex><span>                        <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>BUG_ON</span>(<span style=color:#f92672>!</span>system_wq <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>system_highpri_wq <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>system_long_wq <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>system_unbound_wq <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>system_freezable_sq <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>system_power_efficient_wq <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>system_freezable_power_efficient_wq);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>7가지 워크큐 생성</li><li>워크큐가 제대로 생성됐는지 점검</li><li>system_wq : 시스템 워크큐</li><li>system_highpri_wq : 시스템 워크큐에서 쓰는 워커 스레드 보다 우선순위가 높은 워커 스레드를 처리하는 큐</li><li>system_long_wq : 오래걸리는 작업 때 사용</li><li>system_unbound_wq : percpu 타입의 워커를 쓰지 않고 wq->numa_pwq_tbl[node]에 지정된 워커 풀을 쓴다. 시스템 워크큐보다 빨리 실행된다.</li><li>system_freezable_wq : freezable 유저 프로세스나 커널 쓰레드를 처리할때 사용. (freeze_wokques_begin() 함수에서 실행)<ul><li>프로세스를 얼릴때는 __frefrigerator 함수를 호출</li></ul></li><li>system_power_efficient_wq, system_freezable_power_efficient_wq : 절전 목적으로 사용하는 워크큐</li></ul><h5 id=워크>워크</h5><ul><li>워크큐를 실행하는 기본 단위</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=struct%20work_struct%20%7b%0a%20%20atomic_long_t%20data;%0a%20%20struct%20list_head%20entry;%0a%20%20work_func_t%20func;%0a%20%20#ifdef%20CONFIG_LOCKDEP%0a%20%20struct%20lockdep_map%20lockdep_map;%0a%20%20#endif%0a%7d;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> work_struct {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>atomic_long_t</span> data;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> list_head entry;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>work_func_t</span> func;
</span></span><span style=display:flex><span>  <span style=color:#75715e>#ifdef CONFIG_LOCKDEP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> lockdep_map lockdep_map;
</span></span><span style=display:flex><span>  <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};</span></span></code></pre></div></div><ul><li><p>data : 워크 실행상태를 나타낸다.</p><ul><li>워크 초기화 : 0xFFFFFFE0</li><li>워크를 워크큐에 큐잉 : WORK_STRUCT_PENDING_BIT(0x1)</li></ul></li><li><p>entry : 연결 리스트, worker_pool 구조체 중 연결 리스트 worklist에 등록된다.</p></li><li><p>func : 워크 핸들러 함수의 주소를 저장</p></li><li><p>초기화 방법 : INIT_WORK, DECLARE_WORK</p><ul><li><p>INIT_WORK : 커널이 INIT_WORK 함수를 실행할 때 워크를 초기화</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=INIT_WORK%28&amp;work,%20callback%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>INIT_WORK</span>(<span style=color:#f92672>&amp;</span>work, callback);</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="#define%20INIT_WORK%28_work,%20_func%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20__INIT_WORK%28%28_work%29,%20%28_func%29,%200%29%0a%0a#define%20__INIT_WORK%28_work,%20_func,%20_onstack%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20do%20%7b%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20%20%20__init_work%28%28_work%29,%20_onstack%29;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20%20%20%28_work%29-%3edata%20=%20%28atomic_long_t%29%20WORK_DATA_INIT%28%29;%20%5c%0a%20%20%20%20%20%20%20%20INIT_LIST_HEAD%28&%28_work%29-%3eentry%29;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20%20%20%28_work%29-%3efunc%20=%20%28_func%29;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%7d%20while%280%29%0a%0a#define%20WORK_DATA_INIT%28%29%20ATOMIC_LONG_INIT%28WORKSTRUCT_NO_POOL%29">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define INIT_WORK(_work, _func)                              \
</span></span></span><span style=display:flex><span><span style=color:#75715e>      __INIT_WORK((_work), (_func), 0)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __INIT_WORK(_work, _func, _onstack)                  \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  do {                                                    \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        __init_work((_work), _onstack);                   \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        (_work)-&gt;data = (atomic_long_t) WORK_DATA_INIT(); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        INIT_LIST_HEAD(&amp;(_work)-&gt;entry);                  \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        (_work)-&gt;func = (_func);                          \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  } while(0)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define WORK_DATA_INIT() ATOMIC_LONG_INIT(WORKSTRUCT_NO_POOL)</span></span></span></code></pre></div></div><ul><li>6번째 줄의 __init_work 함수는 CONFIG_DEBUG_OBJECTS 커널 컨피그가 활성화돼 있어야 실행, 대부분 비활성</li></ul></li><li><p>DECLARE_WORK : 커널이 컴파일될 때 워크 세부 정보가 포함된 전역 변수 생성</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=static%20DECLARE_WORK%28work,%20callback%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#a6e22e>DECLARE_WORK</span>(work, callback);</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="#define%20DECLARE_WORK%28n,%20f%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20struct%20work_struct%20n%20=%20__WORK_INITIALIZER%28n,%20f%29%0a%0a#define%20__WORK_INITIALIZER%28n,%20f%29%20%7b%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20.data%20=%20WORK_DATA_STATIC_INIT%28%29,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20.entry%20=%20%7b%20&%28n%29.entry,%20&%28n%29.entry%20%7d,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20.func%20=%20%28f%29,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20__WORK_INIT_LOCKDEP_MAP%28#n,%20&%28n%29%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%7d%0a%0a#define%20WORK_DATA_STATIC_INIT%28%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20ATOMIC_LONG_INIT%28%28unsigned%20long%29%28WORK_STRUCT_NO_POOL%20%7c%20WORK_STRUCT_STATIC%29%29">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define DECLARE_WORK(n, f)                                    \
</span></span></span><span style=display:flex><span><span style=color:#75715e>      struct work_struct n = __WORK_INITIALIZER(n, f)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define __WORK_INITIALIZER(n, f) {                            \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  .data = WORK_DATA_STATIC_INIT(),                            \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  .entry = { &amp;(n).entry, &amp;(n).entry },                        \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  .func = (f),                                                \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  __WORK_INIT_LOCKDEP_MAP(#n, &amp;(n))                           \
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define WORK_DATA_STATIC_INIT()                               \
</span></span></span><span style=display:flex><span><span style=color:#75715e>      ATOMIC_LONG_INIT((unsigned long)(WORK_STRUCT_NO_POOL | WORK_STRUCT_STATIC))</span></span></span></code></pre></div></div></li></ul></li></ul><h5 id=워크-큐잉>워크 큐잉</h5><ul><li><p>schedule_work(), queue_work_on(), __queue_work(), insert_work(), wake_up_worker()</p></li><li><p>interface</p><ul><li><p>schedule_work()</p><ul><li>시스템 워크큐에 큐잉</li><li>호출 구조 : schedule_work() -> queue_work() -> queue_work_on() -> __queue_work()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=schedule_work%28&amp;work%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>schedule_work</span>(<span style=color:#f92672>&amp;</span>work);</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=static%20inline%20bool%20schedule_work%28struct%20work_struct%20*work%29%0a%7b%0a%20%20%20return%20queue_work%28system_wq,%20work%29;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>schedule_work</span>(<span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>queue_work</span>(system_wq, work);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=struct%20workqueue_struct%20*system_wq%20__read_mostly;%0aEXPORT_SYMBOL%28system_wq%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>system_wq __read_mostly;
</span></span><span style=display:flex><span><span style=color:#a6e22e>EXPORT_SYMBOL</span>(system_wq);</span></span></code></pre></div></div><ul><li>queue_work()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=static%20inline%20bool%20queue_work%28struct%20workqueue_struct%20*wq,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20work_struct%20*work%29%0a%7b%0a%20%20return%20queue_work_on%28WORK_CPU_UNBOUND,%20wq,%20work%29;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>queue_work</span>(<span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>queue_work_on</span>(WORK_CPU_UNBOUND, wq, work);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>queue_work_on()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="bool%20queue_work_on%28int%20cpu,%20struct%20workqueue_struct%20*wq,%0a%20%20%20struct%20work_struct%20*work%29%0a%7b%0a%20%20bool%20ret%20=%20false;%0a%20%20unsigned%20long%20flags;%0a%0a%20%20local_irq_save%28flags%29;%0a%0a%20%20if%20%28!test_and_set_bit%28WORK_STRUCT_PENDING_BIT,%20work_data_bits%28work%29%29%29%20%7b%0a%20%20%20%20__queue_work%28cpu,%20wq,%20work%29;%0a%20%20%20%20ret%20=%20true;%0a%20%20%7d%0a%0a%20%20local_irq_restore%28flags%29;%0a%20%20return%20ret;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>queue_work_on</span>(<span style=color:#66d9ef>int</span> cpu, <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> ret <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> flags;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>local_irq_save</span>(flags);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>test_and_set_bit</span>(WORK_STRUCT_PENDING_BIT, <span style=color:#a6e22e>work_data_bits</span>(work))) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__queue_work</span>(cpu, wq, work);
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>local_irq_restore</span>(flags);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>__queue_work()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=static%20void%20__queue_work%28int%20cpu,%20struct%20workqueue_struct%20*wq,%0a%20%20%20%20%20%20%20%20%20%20%20struct%20work_struct%20*work%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__queue_work</span>(<span style=color:#66d9ef>int</span> cpu, <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work);</span></span></code></pre></div></div><ul><li>queue_work_on 이 호출할 때, 인자<ul><li>cpu : WORK_CPU_UNBOUND</li><li>wq : system_wq</li><li>work : work_struct 구조체의 주소</li></ul></li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20__queue_work%28int%20cpu,%20struct%20workqueue_struct%20*wq,%0a%20%20%20%20%20%20%20%20%20%20%20struct%20work_struct%20*work%29%0a%7b%0a%20%20struct%20pool_workqueue%20*pwq;%0a%20%20struct%20worker_pool%20*last_pool;%0a%20%20struct%20list_head%20*worklist;%0a%20%20unsigned%20int%20work_flags;%0a%20%20unsigned%20int%20req_cpu%20=%20cpu;%0a%20%20/*%20skip%20*/%0aretry:%0a%20%20if%20%28req_cpu%20==%20WORK_CPU_UNBOUND%29%0a%20%20%20%20cpu%20=%20wq_select_unbound_cpu%28raw_smp_processor_id%28%29%29;%0a%20%20/*%20pwq%20which%20will%20be%20used%20unless%20@work%20is%20executing%20elsewhere%20*/%0a%20%20if%20%28!%28wq-%3eflags%20&%20WQ_UNBOUND%29%29%0a%20%20%20%20pwd%20=%20per_cpu_ptr%28wq-%3ecpu_pwqs,%20cpu%29;%0a%20%20else%0a%20%20%20%20pwd%20=%20unbound_pwq_by_node%28wq,%20cpu_to_node%28cpu%29%29;%0a%0a%20%20last_pool%20=%20get_work_pool%28work%29;%0a%20%20if%20%28last_pool%20&&%20last_pool%20!=%20pwq-%3epool%29%20%7b%0a%20%20%20%20struct%20worker%20*worker;%0a%0a%20%20%20%20spin_lock%28&amp;last_pool-%3elock%29;%0a%0a%20%20%20%20worker%20=%20find_worker_executing_work%28last_pool,%20work%29;%0a%0a%20%20%20%20if%20%28worker%20&&%20worker-%3ecurrent_pwq-%3ewq%20==%20wq%29%20%7b%0a%20%20%20%20%20%20pwd%20=%20worker-%3ecurrent_pwq;%0a%20%20%20%20%7d%20else%20%7b%0a%20%20%20%20%20%20/*%20meh...%20not%20running%20there,%20queue%20her%20*/%0a%20%20%20%20%20%20spin_unlock%28&amp;last_pool-%3elock%29;%0a%20%20%20%20%20%20spin_lock%28&amp;pwd-%3epool-%3elock%29;%0a%20%20%20%20%7d%0a%20%20%7d%20else%20%7b%0a%20%20%20%20spin_lock%28&amp;pwq-%3epool-%3elock%29;%0a%20%20%7d%0a%20%20/*%20skip%20*/%0a%20%20/*%20pwq%20determined,%20queue%20*/%0a%20%20trace_workqueue_queue_work%28req_cpu,%20pwq,%20work%29;%0a%20%20/*%20skip%20*/%0a%20%20if%20%28likely%28pwq-%3enr_active%20%3c%20pwq-%3emax_active%29%29%20%7b%0a%20%20%20%20trace_workqueue_activate_work%28work%29;%0a%20%20%20%20pwq-%3enr_active++;%0a%20%20%20%20worklist%20=%20&amp;pwq-%3epool-%3eworklist;%0a%20%20%20%20if%20%28list_empty%28worklist%29%29%0a%20%20%20%20%20%20pwq-%3epool-%3ewatchdog_ts%20=%20jiffies;%0a%20%20%7d%20else%20%7b%0a%20%20%20%20work_flags%20%7c=%20WORK_STRUCT_DELAYED;%0a%20%20%20%20worklist%20=%20&amp;pwq-%3edelayed_works;%0a%20%20%7d%0a%0a%20%20insert_work%28pwq,%20work,%20worklist,%20work_flags%29;%0a%20%20/*%20skip%20*/%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__queue_work</span>(<span style=color:#66d9ef>int</span> cpu, <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> pool_workqueue <span style=color:#f92672>*</span>pwq;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>last_pool;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> list_head <span style=color:#f92672>*</span>worklist;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> work_flags;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> req_cpu <span style=color:#f92672>=</span> cpu;
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>retry:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (req_cpu <span style=color:#f92672>==</span> WORK_CPU_UNBOUND)
</span></span><span style=display:flex><span>    cpu <span style=color:#f92672>=</span> <span style=color:#a6e22e>wq_select_unbound_cpu</span>(<span style=color:#a6e22e>raw_smp_processor_id</span>());
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* pwq which will be used unless @work is executing elsewhere */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(wq<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> WQ_UNBOUND))
</span></span><span style=display:flex><span>    pwd <span style=color:#f92672>=</span> <span style=color:#a6e22e>per_cpu_ptr</span>(wq<span style=color:#f92672>-&gt;</span>cpu_pwqs, cpu);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    pwd <span style=color:#f92672>=</span> <span style=color:#a6e22e>unbound_pwq_by_node</span>(wq, <span style=color:#a6e22e>cpu_to_node</span>(cpu));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  last_pool <span style=color:#f92672>=</span> <span style=color:#a6e22e>get_work_pool</span>(work);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (last_pool <span style=color:#f92672>&amp;&amp;</span> last_pool <span style=color:#f92672>!=</span> pwq<span style=color:#f92672>-&gt;</span>pool) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spin_lock</span>(<span style=color:#f92672>&amp;</span>last_pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    worker <span style=color:#f92672>=</span> <span style=color:#a6e22e>find_worker_executing_work</span>(last_pool, work);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (worker <span style=color:#f92672>&amp;&amp;</span> worker<span style=color:#f92672>-&gt;</span>current_pwq<span style=color:#f92672>-&gt;</span>wq <span style=color:#f92672>==</span> wq) {
</span></span><span style=display:flex><span>      pwd <span style=color:#f92672>=</span> worker<span style=color:#f92672>-&gt;</span>current_pwq;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>/* meh... not running there, queue her */</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>spin_unlock</span>(<span style=color:#f92672>&amp;</span>last_pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>spin_lock</span>(<span style=color:#f92672>&amp;</span>pwd<span style=color:#f92672>-&gt;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spin_lock</span>(<span style=color:#f92672>&amp;</span>pwq<span style=color:#f92672>-&gt;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* pwq determined, queue */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>trace_workqueue_queue_work</span>(req_cpu, pwq, work);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(pwq<span style=color:#f92672>-&gt;</span>nr_active <span style=color:#f92672>&lt;</span> pwq<span style=color:#f92672>-&gt;</span>max_active)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>trace_workqueue_activate_work</span>(work);
</span></span><span style=display:flex><span>    pwq<span style=color:#f92672>-&gt;</span>nr_active<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    worklist <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>pwq<span style=color:#f92672>-&gt;</span>pool<span style=color:#f92672>-&gt;</span>worklist;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>list_empty</span>(worklist))
</span></span><span style=display:flex><span>      pwq<span style=color:#f92672>-&gt;</span>pool<span style=color:#f92672>-&gt;</span>watchdog_ts <span style=color:#f92672>=</span> jiffies;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    work_flags <span style=color:#f92672>|=</span> WORK_STRUCT_DELAYED;
</span></span><span style=display:flex><span>    worklist <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>pwq<span style=color:#f92672>-&gt;</span>delayed_works;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>insert_work</span>(pwq, work, worklist, work_flags);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>풀워크큐 가져오기</li><li>워커 구조체 가져오기</li><li>ftrace 로그 출력</li><li>워커 풀에 워크의 연결리스트를 등록하고 워커 스레드 깨우기</li></ul></li><li><p>get_work_pool()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20struct%20worker_pool%20*get_work_pool%28struct%20work_struct%20*work%29%0a%7b%0a%20%20unsigned%20long%20data%20=%20atomic_long_read%28&amp;work-%3edata%29;%0a%20%20int%20pool_id;%0a%0a%20%20assert_rcu_or_pool_mutex%28%29;%0a%0a%20%20if%20%28data%20&%20WORK_STRUCT_PWQ%29%0a%20%20%20%20return%20%28%28struct%20pool_workqueue%20*%29%0a%20%20%20%20%20%20%28data%20&%20WORK_STRUCT_WQ_DATA_MASK%29%29-%3epool;%0a%0a%20%20pool_id%20=%20data%20%3e%3e%20WORK_OFFQ_POOL_SHIFT;%0a%20%20if%20%28pool_id%20==%20WORK_OFFQ_POOL_NONE%29%0a%20%20%20%20return%20NULL;%0a%0a%20%20return%20idr_find%28&amp;worker_pool_idr,%20pool_id%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span><span style=color:#a6e22e>get_work_pool</span>(<span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> data <span style=color:#f92672>=</span> <span style=color:#a6e22e>atomic_long_read</span>(<span style=color:#f92672>&amp;</span>work<span style=color:#f92672>-&gt;</span>data);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> pool_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>assert_rcu_or_pool_mutex</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (data <span style=color:#f92672>&amp;</span> WORK_STRUCT_PWQ)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ((<span style=color:#66d9ef>struct</span> pool_workqueue <span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>      (data <span style=color:#f92672>&amp;</span> WORK_STRUCT_WQ_DATA_MASK))<span style=color:#f92672>-&gt;</span>pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  pool_id <span style=color:#f92672>=</span> data <span style=color:#f92672>&gt;&gt;</span> WORK_OFFQ_POOL_SHIFT;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (pool_id <span style=color:#f92672>==</span> WORK_OFFQ_POOL_NONE)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>idr_find</span>(<span style=color:#f92672>&amp;</span>worker_pool_idr, pool_id);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>insert_work()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20insert_work%28struct%20pool_workqueue%20*pwq,%20struct%20work_struct%20*work,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20list_head%20*head,%20unsigned%20int%20extra_flags%29%0a%7b%0a%20%20struct%20worker_pool%20*pool%20=%20pwq-%3epool;%0a%0a%20%20set_work_pwq%28work,%20pwq,%20extra_flags%29;%0a%20%20list_add_tail%28&amp;work-%3eentry,%20head%29;%0a%20%20get_pwq%28pwq%29;%0a%0a%20%20smp_mb%28%29;%0a%0a%20%20if%20%28__need_more_worker%28pool%29%29%0a%20%20%20%20wake_up_worker%28pool%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert_work</span>(<span style=color:#66d9ef>struct</span> pool_workqueue <span style=color:#f92672>*</span>pwq, <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work,
</span></span><span style=display:flex><span>                     <span style=color:#66d9ef>struct</span> list_head <span style=color:#f92672>*</span>head, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> extra_flags)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool <span style=color:#f92672>=</span> pwq<span style=color:#f92672>-&gt;</span>pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set_work_pwq</span>(work, pwq, extra_flags);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>list_add_tail</span>(<span style=color:#f92672>&amp;</span>work<span style=color:#f92672>-&gt;</span>entry, head);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>get_pwq</span>(pwq);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>smp_mb</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>__need_more_worker</span>(pool))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wake_up_worker</span>(pool);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>wake_up_worker()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20wake_up_worker%28struct%20worker_pool%20*pool%29%0a%7b%0a%20%20struct%20worker%20*worker%20=%20first_idle_worker%28pool%29;%0a%0a%20%20if%20%28likely%28worker%29%29%0a%20%20%20%20wake_up_process%28worker-%3etask%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wake_up_worker</span>(<span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker <span style=color:#f92672>=</span> <span style=color:#a6e22e>first_idle_worker</span>(pool);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(worker))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wake_up_process</span>(worker<span style=color:#f92672>-&gt;</span>task);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>find_worker_executing_work()</p></li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20struct%20worker%20*find_worker_executing_work%28struct%20worker_pool%20*pool,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20work_struct%20*work%29%0a%7b%0a%20%20struct%20worker%20*worker;%0a%0a%20%20hash_for_each_possible%28pool-%3ebusy_hash,%20worker,%20hentry,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%28unsigned%20long%29work%29%0a%20%20%20%20if%20%28worker-%3ecurrent_work%20==%20work%20&&%0a%20%20%20%20%20%20%20%20%20%20worker-%3ecurrent_func%20==%20work-%3efunc%29%0a%20%20%20%20%20%20return%20worker;%0a%0a%20%20return%20NULL;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span><span style=color:#a6e22e>find_worker_executing_work</span>(<span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool,
</span></span><span style=display:flex><span>                                                <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hash_for_each_possible</span>(pool<span style=color:#f92672>-&gt;</span>busy_hash, worker, hentry,
</span></span><span style=display:flex><span>                      (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)work)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (worker<span style=color:#f92672>-&gt;</span>current_work <span style=color:#f92672>==</span> work <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>          worker<span style=color:#f92672>-&gt;</span>current_func <span style=color:#f92672>==</span> work<span style=color:#f92672>-&gt;</span>func)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> worker;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li></ul><h5 id=워크의-실행-주체>워크의 실행 주체</h5><ul><li><p>워커 스레드, 워크를 워크큐에 큐잉하면 워커 스레드를 깨운다.</p></li><li><p>worker_thread()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20int%20worker_thread%28void%20*__worker%29%0a%7b%0a%20%20struct%20worker%20*worker%20=%20__worker;%0a%20%20struct%20worker_pool%20*pool%20=%20worker-%3epool;%0a%0a%20%20/*%20skip%20*/%0a%20%20do%20%7b%0a%20%20%20%20struct%20work_struct%20*work%20=%0a%20%20%20%20%20%20list_first_entry%28&amp;pool-%3eworklist,%0a%20%20%20%20%20%20%20%20struct%20work_struct,%20entry%29;%0a%0a%20%20%20%20pool-%3ewatchdog_ts%20=%20jiffies;%0a%0a%20%20%20%20if%20%28likely%28!%28*work_data_bits%28work%29%20&%20WORK_STRUCT_LINKED%29%29%29%20%7b%0a%20%20%20%20%20%20/*%20optimization%20path,%20not%20strictly%20necessary%20*/%0a%20%20%20%20%20%20process_one_work%28worker,%20work%29;%0a%20%20%20%20%20%20if%20%28unlikely%28!list_empty%28&amp;worker-%3escheduled%29%29%29%0a%20%20%20%20%20%20%20%20process_scheduled_works%28worker%29;%0a%20%20%20%20%7d%20else%20%7b%0a%20%20%20%20%20%20move_linked_works%28work,%20&amp;worker-%3escheduled,%20NULL%29;%0a%20%20%20%20%20%20process_scheduled_works%28worker%29;%0a%20%20%20%20%7d%0a%20%20%7d%20while%20%28keep_working%28pool%29%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>worker_thread</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>__worker)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker <span style=color:#f92672>=</span> __worker;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool <span style=color:#f92672>=</span> worker<span style=color:#f92672>-&gt;</span>pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>list_first_entry</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>worklist,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> work_struct, entry);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pool<span style=color:#f92672>-&gt;</span>watchdog_ts <span style=color:#f92672>=</span> jiffies;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(<span style=color:#f92672>!</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>work_data_bits</span>(work) <span style=color:#f92672>&amp;</span> WORK_STRUCT_LINKED))) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>/* optimization path, not strictly necessary */</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process_one_work</span>(worker, work);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>list_empty</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>scheduled)))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>process_scheduled_works</span>(worker);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>move_linked_works</span>(work, <span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>scheduled, NULL);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process_scheduled_works</span>(worker);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>keep_working</span>(pool));
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li><p>keep_working() : 이미 큐잉된 워크가 있으면 true를 반환하는 역할</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20bool%20keep_working%28struct%20worker_pool%20*pool%29%0a%7b%0a%20%20return%20!list_empty%28&amp;pool-%3eworklist%29%20&&%0a%20%20%20%20atomic_read%28&amp;pool-%3enr_running%29%20%3c=%201;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>keep_working</span>(<span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>list_empty</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>worklist) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>atomic_read</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>nr_running) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>워커 풀에 워크가 큐잉됐는지 체크한다.</p></li><li><p>워커 풀에 큐잉된 워크의 연결 리스트를 가져와 워크 구조체를 알아낸다.</p></li><li><p>process_one_work() 함수를 호출해 워크를 실행한다.</p></li></ul></li><li><p>process_one_work()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20process_one_work%28struct%20worker%20*worker.%20struct%20work_struct%20*work%29%0a__releases%28&amp;pool-%3elock%29%0a__acquires%28&amp;pool-%3elock%29%0a%7b%0a%20%20struct%20pool_workqueue%20*pwq%20=%20get_work_pwq%28work%29;%0a%20%20struct%20worker_pool%20*pool%20=%20worker-%3epool;%0a%20%20bool%20cpu_intensive%20=%20pwq-%3ewq-%3eflags%20&%20WQ_CPU_INTENSIVE;%0a%20%20int%20work_color;%0a%20%20struct%20worker%20*collision;%0a%20%20/*%20skip%20*/%0a%20%20collision%20=%20find_worker_executing_work%28pool,%20work%29;%0a%20%20if%20%28unlikely%28collision%29%29%20%7b%0a%20%20%20%20move_linked_works%28work,%20&amp;collision-%3escheduled,%20NULL%29;%0a%20%20%20%20return;%0a%20%20%7d%0a%0a%20%20/*%20claim%20and%20dequeue%20*/%0a%20%20debug_work_deactivate%28work%29;%0a%20%20hash_add%28pool-%3ebusy_hash,%20&amp;worker-%3ehentry,%20%28unsgined%20long%29work%29;%0a%20%20worker-%3ecurrent_work%20=%20work;%0a%20%20worker-%3ecurrent_func%20=%20work-%3efunc;%0a%20%20worker-%3ecurrent_pwq%20=%20pwq;%0a%20%20work_color%20=%20get_work_color%28work%29;%0a%20%20/*%20skip%20*/%0a%0a%20%20list_del_init%28&amp;work-%3eentry%29;%0a%20%20/*%20skip%20*/%0a%0a%20%20set_work_pool_and_clear_pending%28work,%20pool-%3eid%29;%0a%20%20/*%20skip%20*/%0a%0a%20%20trace_workqueue_execute_start%28work%29;%0a%20%20worker-%3ecurrent_func%28work%29;%0a%20%20trace_workqueue_execute_end%28work%29;%0a%20%20/*%20skip%20*/%0a%20%20if%20%28unlikely%28in_atomic%28%29%20%7c%7c%20lockdep_depth%28current%29%20%3e%200%29%20%7b%0a%20%20%20%20pr_err%28%22BUG:%20workqueue%20leaked%20lock%20or%20atomic:%20%25s/0x%08x/%25d%5cn%22%0a%20%20%20%20%20%20%22last%20function:%20%25pf%5cn%22,%0a%20%20%20%20%20%20current-%3ecomm,%20prempt_count%28%29,%20task_pid_nr%28current%29,%0a%20%20%20%20%20%20worker-%3ecurrent_func%29;%0a%20%20%20%20%20%20debug_show_held_locks%28current%29;%0a%20%20%20%20%20%20dump_stack%28%29;%0a%20%20%7d%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_one_work</span>(<span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker. <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work)
</span></span><span style=display:flex><span><span style=color:#a6e22e>__releases</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock)
</span></span><span style=display:flex><span><span style=color:#a6e22e>__acquires</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> pool_workqueue <span style=color:#f92672>*</span>pwq <span style=color:#f92672>=</span> <span style=color:#a6e22e>get_work_pwq</span>(work);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool <span style=color:#f92672>=</span> worker<span style=color:#f92672>-&gt;</span>pool;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> cpu_intensive <span style=color:#f92672>=</span> pwq<span style=color:#f92672>-&gt;</span>wq<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> WQ_CPU_INTENSIVE;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> work_color;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>collision;
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  collision <span style=color:#f92672>=</span> <span style=color:#a6e22e>find_worker_executing_work</span>(pool, work);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(collision)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>move_linked_works</span>(work, <span style=color:#f92672>&amp;</span>collision<span style=color:#f92672>-&gt;</span>scheduled, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* claim and dequeue */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>debug_work_deactivate</span>(work);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hash_add</span>(pool<span style=color:#f92672>-&gt;</span>busy_hash, <span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>hentry, (unsgined <span style=color:#66d9ef>long</span>)work);
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>current_work <span style=color:#f92672>=</span> work;
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>current_func <span style=color:#f92672>=</span> work<span style=color:#f92672>-&gt;</span>func;
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>current_pwq <span style=color:#f92672>=</span> pwq;
</span></span><span style=display:flex><span>  work_color <span style=color:#f92672>=</span> <span style=color:#a6e22e>get_work_color</span>(work);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>list_del_init</span>(<span style=color:#f92672>&amp;</span>work<span style=color:#f92672>-&gt;</span>entry);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set_work_pool_and_clear_pending</span>(work, pool<span style=color:#f92672>-&gt;</span>id);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>trace_workqueue_execute_start</span>(work);
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>current_func</span>(work);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>trace_workqueue_execute_end</span>(work);
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(<span style=color:#a6e22e>in_atomic</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>lockdep_depth</span>(current) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pr_err</span>(<span style=color:#e6db74>&#34;BUG: workqueue leaked lock or atomic: %s/0x%08x/%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;last function: %pf</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>      current<span style=color:#f92672>-&gt;</span>comm, <span style=color:#a6e22e>prempt_count</span>(), <span style=color:#a6e22e>task_pid_nr</span>(current),
</span></span><span style=display:flex><span>      worker<span style=color:#f92672>-&gt;</span>current_func);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>debug_show_held_locks</span>(current);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dump_stack</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>워크 전처리 : 하나의 워크를 여러 워커에서 실행하지 않도록 관리</li><li>워크 핸들러 실행</li></ul></li></ul><hr><h5 id=워커-스레드>워커 스레드</h5><ul><li><p>워커 스레드의 흐름</p><ol><li>워커 스레드 생성 : create_worker() 함수를 호출하면 워커 스레드를 생성.</li><li>휴면 상태 : 휴면 상태에서 다른 드라이버가 자신을 깨워주기를 기다림.</li><li>실행 : 워크를 워크큐에 큐잉한 후 워커 스레드가 깨어나면 스레드 핸들러인 worker_thread() 함수가 실행</li><li>소멸 : 워커 스레드가 필요 없으면 소멸.</li></ol></li><li><p>worker 구조체</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=struct%20worker%20%7b%0a%20%20union%20%7b%0a%20%20%20%20struct%20list_head%20%20%20%20%20%20entry;%0a%20%20%20%20struct%20hlist_node%20%20%20%20%20hentry;%0a%20%20%7d;%0a%20%20struct%20work_struct%20%20%20%20%20%20*current;%0a%20%20work_func_t%20%20%20%20%20%20%20%20%20%20%20%20%20current_func;%0a%20%20struct%20pool_workqueue%20%20%20*current_pwq;%0a%20%20bool%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20desc_valid;%0a%20%20struct%20list_head%20%20%20%20%20%20%20%20scheduled;%0a%0a%20%20struct%20task_struct%20%20%20%20%20%20*task;%0a%20%20struct%20worker_pool%20%20%20%20%20%20*pool;%0a%0a%20%20struct%20list_head%20%20%20%20%20%20%20%20node;%0a%20%20unsigned%20long%20%20%20%20%20%20%20%20%20%20%20last_active;%0a%20%20unsigned%20int%20%20%20%20%20%20%20%20%20%20%20%20flags;%0a%20%20int%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20id;%0a%0a%20%20char%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20desc[WORKER_DESC_LEN];%0a%0a%20%20struct%20workqueue_struct%20*rescue_wq;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> worker {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> list_head      entry;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> hlist_node     hentry;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> work_struct      <span style=color:#f92672>*</span>current;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>work_func_t</span>             current_func;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> pool_workqueue   <span style=color:#f92672>*</span>current_pwq;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span>                    desc_valid;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> list_head        scheduled;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> task_struct      <span style=color:#f92672>*</span>task;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool      <span style=color:#f92672>*</span>pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> list_head        node;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>           last_active;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>            flags;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span>                     id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span>                    desc[WORKER_DESC_LEN];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>rescue_wq;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>current_work : work_struct 구조체로, 현재 실행하려는 워크를 저장하는 필드</li><li>current_func : 실행하려는 워크 핸들러의 주소를 저장하는 필드</li></ul></li><li><p>워커는 워커 스레드를 표현하는 자료구조이며, worker 구조체</p></li></ul><h5 id=워커-스레드의-생성-시기>워커 스레드의 생성 시기</h5><ul><li><p>기본적으로 부팅과정에서 워크큐 자료구조를 초기화할 때 워커 스레드를 생성.</p></li><li><p>만약 워크큐에 많이 큐잉될 상황이 예측될 때, create_worker() 함수를 호출해 워커 스레드를 생성 가능</p></li><li><p>부팅 과정에서 워커 스레드 생성되는 로직</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="int%20__init%20workqueue_init%28void%29%0a%7b%0a%20%20struct%20workqueue_struct%20*wq;%0a%20%20struct%20worker_pool%20*pool;%0a%20%20int%20cpu,%20bkt;%0a%0a%20%20wq_numa_init%28%29;%0a%0a%20%20mutex_lock%28&amp;wq_pool_mutex%29;%0a%0a%20%20/*%20skip%20*/%0a%20%20/*%20create%20the%20initial%20workers%20*/%0a%20%20for_each_online_cpu%28cpu%29%20%7b%0a%20%20%20%20for_each_cpu_worker_pool%28pool,%20cpu%29%20%7b%0a%20%20%20%20%20%20pool-%3eflags%20&=%20~POOL_DISASSOCIATED;%0a%20%20%20%20%20%20BUG_ON%28!create_worker%28pool%29%29;%0a%20%20%20%20%7d%0a%20%20%7d%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>workqueue_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> cpu, bkt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>wq_numa_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutex_lock</span>(<span style=color:#f92672>&amp;</span>wq_pool_mutex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* create the initial workers */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>for_each_online_cpu</span>(cpu) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>for_each_cpu_worker_pool</span>(pool, cpu) {
</span></span><span style=display:flex><span>      pool<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>POOL_DISASSOCIATED;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>BUG_ON</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>create_worker</span>(pool));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>create_worker()</p><ul><li>워커 풀의 아이디 읽어오기</li><li>워커 스레드의 이름을 지정해 워커 스레드 생성 요청</li><li>워커 풀에 워커 스레드를 등록</li><li>워커 정보를 갱신하고 생성된 워커 스레드를 깨우기</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#ZgotmplZ>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> owrker <span style=color:#f92672>*</span><span style=color:#a6e22e>create_worker</span>(<span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> id_buf[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  id <span style=color:#f92672>=</span> <span style=color:#a6e22e>ida_simple_get</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>worker_da, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, GFP_KERNEL);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (id <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> fail;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>worker)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> fail;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>pool <span style=color:#f92672>=</span> pool;
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>id <span style=color:#f92672>=</span> id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (pool<span style=color:#f92672>-&gt;</span>cpu <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>snprintf</span>(id_buf, <span style=color:#66d9ef>sizeof</span>(id_buf), <span style=color:#e6db74>&#34;%d:%d%s&#34;</span>, pool<span style=color:#f92672>-&gt;</span>cpu, id,
</span></span><span style=display:flex><span>      pool<span style=color:#f92672>-&gt;</span>attrs<span style=color:#f92672>-&gt;</span>nice <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;H&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>snprintf</span>(id_buf, <span style=color:#66d9ef>sizeof</span>(id_buf), <span style=color:#e6db74>&#34;u%d:%d&#34;</span>, pool<span style=color:#f92672>-&gt;</span>id, id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>task <span style=color:#f92672>=</span> <span style=color:#a6e22e>kthread_create_on_node</span>(worker_thread, worker, pool<span style=color:#f92672>-&gt;</span>node,
</span></span><span style=display:flex><span>                                    <span style=color:#e6db74>&#34;kworker/%s&#34;</span>, id_buf);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>IS_ERR</span>(worker<span style=color:#f92672>-&gt;</span>task))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> fail;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set_user_nice</span>(worker<span style=color:#f92672>-&gt;</span>task, pool<span style=color:#f92672>-&gt;</span>attrs<span style=color:#f92672>-&gt;</span>nice);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>kthread_bind_mask</span>(worker<span style=color:#f92672>-&gt;</span>task, pool<span style=color:#f92672>-&gt;</span>attrs<span style=color:#f92672>-&gt;</span>cpumask);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* successful, attach the worker to the pool */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker_attach_to_pool</span>(worker, pool);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* start the newly created worker */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spin_lock_irq</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>pool<span style=color:#f92672>-&gt;</span>nr_workers<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker_enter_idle</span>(worker);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>wake_up_process</span>(worker<span style=color:#f92672>-&gt;</span>task);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spin_unlock_irq</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> worker;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fail:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (id <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ida_simple_remove</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>worker_ida, id);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>kfree</span>(worker);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li><p>worker_attach_to_pool()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20worker_attach_to_pool%28struct%20worker%20*worker,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20worker_pool%20*pool%29%0a%7b%0a%20%20mutex_lock%28&amp;pool-%3eattach_mutex%29;%0a%0a%20%20set_cpus_allowed_ptr%28worker-%3etask,%20pool-%3eattrs-%3ecpumask%29;%0a%20%20if%20%28pool-%3eflags%20&%20POOL_DISASSOCIATED%29%0a%20%20%20%20worker-%3eflags%20%7c=%20WORKER_UNBOUND;%0a%0a%20%20list_add_tail%28&amp;worker-%3enode,%20&amp;pool-%3eworkers%29;%0a%0a%20%20mutex_unlock%28&amp;pool-%3eattach_mutex%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>worker_attach_to_pool</span>(<span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutex_lock</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>attach_mutex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set_cpus_allowed_ptr</span>(worker<span style=color:#f92672>-&gt;</span>task, pool<span style=color:#f92672>-&gt;</span>attrs<span style=color:#f92672>-&gt;</span>cpumask);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (pool<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> POOL_DISASSOCIATED)
</span></span><span style=display:flex><span>    worker<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>|=</span> WORKER_UNBOUND;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>list_add_tail</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>node, <span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>workers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutex_unlock</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>attach_mutex);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>worker_enter_idle()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20worker_enter_idle%28struct%20worker%20*worker%29%0a%7b%0a%20%20struct%20worker_pool%20*pool%20=%20worker-%3epool;%0a%0a%20%20if%20%28WARN_ON_ONCE%28worker-%3eflags%20&%20WORKER_IDLE%29%20%7c%7c%0a%20%20%20%20WARN_ON_ONCE%28!list_empty%28&amp;worker-%3eentry%29%20&&%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%28worker-%3ehentry.next%20%7c%7c%20worker-%3ehentry.pprev%29%29%29%0a%20%20%20%20return;%0a%20%20worker-%3eflags%20%7c=%20WORKER_IDLE;%0a%20%20pool-%3enr_idle++;%0a%20%20worker-%3elast_active%20=%20jiffies;%0a%0a%20%20list_add%28&amp;worker-%3eentry,%20&amp;pool-%3eidle_list%29;%0a%0a%20%20if%20%28too_many_workers%28pool%29%20&&%20!timer_pending%28&amp;pool-%3eidle_time%29%29%0a%20%20%20%20mod_timer%28&amp;pool-%3eidle_timer,%20jiffies%20+%20IDLE_WORKER_TIMEOUT%29;%0a%0a%20%20WARN_ON_ONCE%28!%28pool-%3eflags%20*%20POOL_DISASSOCIATED%29%20&&%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pool-%3enr_workers%20==%20pool-%3enr_idle%20&&%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20atomic_read%28&amp;pool-%3enr_running%29%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>worker_enter_idle</span>(<span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool <span style=color:#f92672>=</span> worker<span style=color:#f92672>-&gt;</span>pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>WARN_ON_ONCE</span>(worker<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> WORKER_IDLE) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>list_empty</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>entry) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                (worker<span style=color:#f92672>-&gt;</span>hentry.next <span style=color:#f92672>||</span> worker<span style=color:#f92672>-&gt;</span>hentry.pprev)))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>|=</span> WORKER_IDLE;
</span></span><span style=display:flex><span>  pool<span style=color:#f92672>-&gt;</span>nr_idle<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>last_active <span style=color:#f92672>=</span> jiffies;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>list_add</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>entry, <span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>idle_list);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>too_many_workers</span>(pool) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>timer_pending</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>idle_time))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mod_timer</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>idle_timer, jiffies <span style=color:#f92672>+</span> IDLE_WORKER_TIMEOUT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#f92672>!</span>(pool<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>*</span> POOL_DISASSOCIATED) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                 pool<span style=color:#f92672>-&gt;</span>nr_workers <span style=color:#f92672>==</span> pool<span style=color:#f92672>-&gt;</span>nr_idle <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>atomic_read</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>nr_running));
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>정리</p><ul><li>kthread_create_on_node() : &ldquo;kworker/&rdquo; 이름으로 워커 스레드를 만듦.</li><li>worker_attach_to_pool() : 워커 풀에 워커를 등록.</li><li>worker_enter_idle() : 워커 상태를 WORKER_IDLE로 바꿈.</li><li>wake_up_process() : 워커 스레드를 깨움.</li></ul></li></ul></li><li><p>woker_thread()</p><ul><li><p>create_worker()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20struct%20worker%20*create_worker%28struct%20worker_pool%20*pool%29%0a%7b%0a%20%20struct%20worker%20*worker%20=%20NULL;%0a%20%20/*%20skip%20*/%0a%20%20worker-%3etask%20=%20kthread_create_on_node%28worker_thread,%20worker,%20pool-%3enode,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22kworker/%25s%22,%20id_buf%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span><span style=color:#a6e22e>create_worker</span>(<span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  worker<span style=color:#f92672>-&gt;</span>task <span style=color:#f92672>=</span> <span style=color:#a6e22e>kthread_create_on_node</span>(worker_thread, worker, pool<span style=color:#f92672>-&gt;</span>node,
</span></span><span style=display:flex><span>                                       <span style=color:#e6db74>&#34;kworker/%s&#34;</span>, id_buf);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li><li><p>전체 동작 과정</p><ul><li>1단계 깨어남 : 워크를 워크큐에 큐잉하면 wake_up_worker() 함수를 호출.</li><li>2단계 전처리 : need_more_worker() 함수를 호출해 워커 스레드를 실행할 조건인지 점검.</li><li>3단계 워크 실행 : process_one_work() 함수 호출해 워크 실행</li><li>4단계 슬립 : 워커 상태를 아이들로 설정하고 슬립 상태로 진입.</li></ul></li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20int%20worker_thread%28void%20*__worker%29%0a%7b%0a%20%20struct%20worker%20*worker%20=%20__worker;%0a%20%20struct%20worker_pool%20*pool%20=%20worker-%3epool;%0a%0a%20%20set_pf_worker%28true%29;%20//%20worker-%3etask-%3eflags%20%7c=%20PF_WQ_WORKER;%0awoke_up:%0a%20%20spin_lock_irq%28&amp;pool-%3elock%29;%0a%0a%20%20/*%20am%20I%20supposed%20to%20die?%20*/%0a%20%20if%20%28unlikely%28worker-%3eflags%20&%20WORKER_DIE%29%29%20%7b%0a%20%20%20%20spin_unlock_irq%28&amp;pool-%3elock%29;%0a%20%20%20%20WARN_ON_ONCE%28!list_mepty%28&amp;worker-%3eentry%29%29;%0a%20%20%20%20set_pf_worker%28false%29;%20//%20worker-%3etask-%3eflags%20&=%20~PF_WQ_WORKER;%0a%0a%20%20%20%20set_task_comm%28worker-%3etask,%20%22kworker/dying%22%29;%0a%20%20%20%20ida_simple_remove%28&amp;pool-%3eworker_ida,%20worker-%3eid%29;%0a%20%20%20%20worker_detach_from_pool%28worker,%20pool%29;%0a%20%20%20%20kfree%28worker%29;%0a%20%20%20%20return%200;%0a%20%20%7d%0a%0a%20%20worker_leave_idle%28worker%29;%0arecheck:%0a%20%20/*%20no%20more%20worker%20necessary?%20*/%0a%20%20if%20%28!need_more_worker%28pool%29%29%0a%20%20%20%20goto%20sleep;%0a%0a%20%20/*%20do%20we%20need%20to%20manage?%20*/%0a%20%20if%20%28unlikely%28!may_start_working%28pool%29%29%20&&%20manage_workers%28worker%29%29%0a%20%20%20%20goto%20recheck;%0a%0a%20%20WARN_ON_ONCE%28!list_emtpry%28&amp;worker-%3escheduled%29%29;%0a%0a%20%20worker_clr_flags%28worker,%20WORKER_PREP%20%7c%20WORKER_REBOUND%29;%0a%0a%20%20do%20%7b%0a%20%20%20%20struct%20work_struct%20*work%20=%0a%20%20%20%20%20%20list_first_entry%28&amp;pool-%3eworklist,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20work_struct,%20entry%29;%0a%0a%20%20%20%20pool-%3ewatchdog_ts%20=%20jiffies;%0a%0a%20%20%20%20if%20%28likely%28!%28*work_data_bits%28work%29%20&%20WORK_STRUCT_LINKED%29%29%29%20%7b%0a%20%20%20%20%20%20/*%20optimization%20path,%20not%20strictly%20necessary%20*/%0a%20%20%20%20%20%20process_one_work%28worker,%20work%29;%0a%20%20%20%20%20%20if%20%28unlikely%28!list_empty%28&amp;worker-%3escheduled%29%29%29%0a%20%20%20%20%20%20%20%20process_scheduled_works%28worker%29;%0a%20%20%20%20%7d%20else%20%7b%0a%20%20%20%20%20%20move_linked_works%28work,%20&amp;worker-%3escheduled,%20NULL%29;%0a%20%20%20%20%20%20process_scheduled_works%28worker%29;%0a%20%20%20%20%7d%0a%20%20%7d%20while%20%28keep_working%28pool%29%29;%0a%0a%20%20worker_set_flags%28worker,%20WORKER_PREP%29;%0asleep:%0a%20%20worker_enter_idle%28worker%29;%0a%20%20__set_current_state%28TASK_IDLE%29;%0a%20%20spin_unlock_irq%28&amp;pool-%3elock%29;%0a%20%20schedule%28%29;%0a%20%20goto%20woke_up;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>worker_thread</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>__worker)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker <span style=color:#f92672>*</span>worker <span style=color:#f92672>=</span> __worker;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> worker_pool <span style=color:#f92672>*</span>pool <span style=color:#f92672>=</span> worker<span style=color:#f92672>-&gt;</span>pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set_pf_worker</span>(true); <span style=color:#75715e>// worker-&gt;task-&gt;flags |= PF_WQ_WORKER;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>woke_up:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spin_lock_irq</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* am I supposed to die? */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(worker<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> WORKER_DIE)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>spin_unlock_irq</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>list_mepty</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>entry));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>set_pf_worker</span>(false); <span style=color:#75715e>// worker-&gt;task-&gt;flags &amp;= ~PF_WQ_WORKER;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>set_task_comm</span>(worker<span style=color:#f92672>-&gt;</span>task, <span style=color:#e6db74>&#34;kworker/dying&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ida_simple_remove</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>worker_ida, worker<span style=color:#f92672>-&gt;</span>id);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>worker_detach_from_pool</span>(worker, pool);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kfree</span>(worker);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker_leave_idle</span>(worker);
</span></span><span style=display:flex><span>recheck:
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* no more worker necessary? */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>need_more_worker</span>(pool))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> sleep;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* do we need to manage? */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>may_start_working</span>(pool)) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>manage_workers</span>(worker))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> recheck;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>list_emtpry</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>scheduled));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker_clr_flags</span>(worker, WORKER_PREP <span style=color:#f92672>|</span> WORKER_REBOUND);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>list_first_entry</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>worklist,
</span></span><span style=display:flex><span>                      <span style=color:#66d9ef>struct</span> work_struct, entry);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pool<span style=color:#f92672>-&gt;</span>watchdog_ts <span style=color:#f92672>=</span> jiffies;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>likely</span>(<span style=color:#f92672>!</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>work_data_bits</span>(work) <span style=color:#f92672>&amp;</span> WORK_STRUCT_LINKED))) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>/* optimization path, not strictly necessary */</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process_one_work</span>(worker, work);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>list_empty</span>(<span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>scheduled)))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>process_scheduled_works</span>(worker);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>move_linked_works</span>(work, <span style=color:#f92672>&amp;</span>worker<span style=color:#f92672>-&gt;</span>scheduled, NULL);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process_scheduled_works</span>(worker);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>keep_working</span>(pool));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker_set_flags</span>(worker, WORKER_PREP);
</span></span><span style=display:flex><span>sleep:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker_enter_idle</span>(worker);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>__set_current_state</span>(TASK_IDLE);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>spin_unlock_irq</span>(<span style=color:#f92672>&amp;</span>pool<span style=color:#f92672>-&gt;</span>lock);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>schedule</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>goto</span> woke_up;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li><p>set_pf_worker()</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20set_pf_worker%28bool%20val%29%0a%7b%0a%20%20mutex_lock%28&amp;wq_pool_attach_mutex%29;%0a%20%20if%20%28val%29%0a%20%20%20%20current-%3eflags%20%7c=%20PF_WQ_WORKER;%0a%20%20else%0a%20%20%20%20current-%3eflags%20&=%20~PF_WQ_WORKER;%0a%20%20mutex_unlock%28&amp;wq_pool_attach_mutex%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_pf_worker</span>(<span style=color:#66d9ef>bool</span> val)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutex_lock</span>(<span style=color:#f92672>&amp;</span>wq_pool_attach_mutex);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (val)
</span></span><span style=display:flex><span>    current<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>|=</span> PF_WQ_WORKER;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    current<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>PF_WQ_WORKER;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutex_unlock</span>(<span style=color:#f92672>&amp;</span>wq_pool_attach_mutex);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></li></ul></li></ul><h4 id=딜레이워크>딜레이워크</h4><ul><li>딜레이 워크 : 워크를 일정시간 후에 지연시켜 실행하는 기법.</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=struct%20delayed_work%20%7b%0a%20%20struct%20work_struct%20work;%0a%20%20struct%20timer_list%20timer;%0a%0a%20%20struct%20workqueue_struct%20*wq;%0a%20%20int%20cpu;%0a%7d;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> delayed_work {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> work_struct work;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> timer_list timer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> cpu;
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div><ul><li>work : 어떤 일을 할지</li><li>timer : 워크를 지정된 시간만큰 지연할 수 있는 시간 정보를 저장</li><li>wq : 딜레이 워크를 관리하는 워크큐 주소</li><li>cpu : 딜레이 워크를 실행한 cpu 번호</li></ul><h5 id=딜레이-워크의-전체-흐름>딜레이 워크의 전체 흐름</h5><ul><li>딜레이 워크 초기화 : INIT_DELAYED_WORK()</li><li>딜레이 워크 타이머 등록 : schedule_delayed_work(), queue_delayed_work(), queue_delayed_work_on(), __queue_delayed_work()</li><li>딜레이 워크 큐잉 : delayed_work_timer_fn(), __queue_wokr()</li><li>딜레이 워크 실행 : process_one_work()</li></ul><h5 id=init_delayed_work>INIT_DELAYED_WORK()</h5><ul><li>사용법</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=struct%20delayed_work%20d_work;%0astatic%20int%20sample%28%29%0a%7b%0a%20%20INIT_DELAYED_WORK%28&amp;d_work,%20callback_fn%29;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> delayed_work d_work;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sample</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>INIT_DELAYED_WORK</span>(<span style=color:#f92672>&amp;</span>d_work, callback_fn);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>INIT_DELAYED_WORK()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#define%20INIT_DELAYED_WORK%28_work,%20_func%29%20%20%20%20%20%20%20%5c%0a%20%20__INIT_DELAYED_WORK%28_work,%20_func,%200%29>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define INIT_DELAYED_WORK(_work, _func)       \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  __INIT_DELAYED_WORK(_work, _func, 0)</span></span></span></code></pre></div></div><ul><li>__INIT_DELAYED_WORK()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#define%20__INIT_DELAYED_WORK%28_work,%20_func,%20_tflags%29%20%20%5c%0a%20%20do%20%7b%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20INIT_WORK%28&%28_work%29-%3ework,%20%28_func%29%29;%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20__init_timer%28&%28_work%29-%3etimer,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20delayed_work_timer_fn,%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20%28_tflags%29%20%7c%20TIMER_IRQSAFE%29;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%7d%20while%280%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define __INIT_DELAYED_WORK(_work, _func, _tflags)  \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  do {                                              \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    INIT_WORK(&amp;(_work)-&gt;work, (_func));             \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    __init_timer(&amp;(_work)-&gt;timer,                   \
</span></span></span><span style=display:flex><span><span style=color:#75715e>      delayed_work_timer_fn,                        \
</span></span></span><span style=display:flex><span><span style=color:#75715e>      (_tflags) | TIMER_IRQSAFE);                   \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  } while(0);</span></span></span></code></pre></div></div><ul><li>__init_timer()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#define%20__init_timer%28_timer,%20_fn,%20_flags%29%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20do%20%7b%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20static%20struct%20lock_class_key%20__key;%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20init_timer_key%28%28_timer%29,%20%28_fn%29,%20%28_flags%29,%20#_timer,%20&__key%29;%20%5c%0a%20%20%7d%20while%20%280%29>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define __init_timer(_timer, _fn, _flags)                       \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  do {                                                          \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    static struct lock_class_key __key;                         \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    init_timer_key((_timer), (_fn), (_flags), #_timer, &amp;__key); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>  } while (0)</span></span></span></code></pre></div></div><ul><li>init_timer_key()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=void%20init_timer_key%28struct%20timer_list%20*timer,%0a%20%20void%20%28*func%29%28truct%20timer_list%20*%29,%20unsigned%20int%20flags,%0a%20%20const%20char%20*name,%20struct%20lock_class_key%20*key%29%0a%7b%0a%20%20debug_init%28timer%29;%0a%20%20do_init_timer%28timer,%20func,%20flags,%20name,%20key%29;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_timer_key</span>(<span style=color:#66d9ef>struct</span> timer_list <span style=color:#f92672>*</span>timer,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>func)(truct timer_list <span style=color:#f92672>*</span>), <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>struct</span> lock_class_key <span style=color:#f92672>*</span>key)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>debug_init</span>(timer);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>do_init_timer</span>(timer, func, flags, name, key);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h5 id=schedule_delayed_work>schedule_delayed_work()</h5><ul><li>사용법</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=schedule_delayed_work%28&amp;d_work,%20timeout%29;>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>schedule_delayed_work</span>(<span style=color:#f92672>&amp;</span>d_work, timeout);</span></span></code></pre></div></div><ul><li>schedule_delayed_work()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=static%20inline%20bool%20schedule_delayed_work%28struct%20delayed_work%20*dwork,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unsigned%20long%20delay%29%0a%7b%0a%20%20return%20queue_dleayed_work%28system_wq,%20dwork,%20delay%29;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>schedule_delayed_work</span>(<span style=color:#66d9ef>struct</span> delayed_work <span style=color:#f92672>*</span>dwork,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> delay)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>queue_dleayed_work</span>(system_wq, dwork, delay);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>queue_delayed_work()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=static%20inline%20bool%20queue_delayed_work%28struct%20workqueue_struct%20*wq,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20delayed_work%20*dwork,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unsigned%20long%20delayed%29%0a%7b%0a%20%20return%20queue_delayed_work_on%28WORK_CPU_UNBOUND,%20wq,%20dwork,%20delay%29;%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>queue_delayed_work</span>(<span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>struct</span> delayed_work <span style=color:#f92672>*</span>dwork,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> delayed)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>queue_delayed_work_on</span>(WORK_CPU_UNBOUND, wq, dwork, delay);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>queue_delayed_work_on()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="bool%20queue_delayed_work_on%28int%20cpu,%20struct%20workqueue_struct%20*wq,%0a%20%20%20%20%20%20%20%20%20%20struct%20delayed_work%20*dwork,%20unsigned%20long%20delay%29%0a%7b%0a%20%20struct%20work-struct%20*work%20=%20&amp;dwork-%3ework;%0a%20%20bool%20ret%20=%20false;%0a%20%20unsigned%20long%20flags;%0a%0a%20%20/*%20read%20the%20comment%20in%20__queue_work%28%29%20*/%0a%20%20local_irq_save%28flags%29;%0a%0a%20%20if%20%28!test_and_set_bit%28WORK_STRUCT_PENDING_BIT,%20work_data_bits%28work%29%29%29%20%7b%0a%20%20%20%20__queue_delayed_work%28cpu,%20wq,%20dwork,%20delay%29;%0a%20%20%20%20ret%20=%20true;%0a%20%20%7d%0a%0a%20%20local_irq_restore%28flags%29;%0a%20%20return%20ret;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>queue_delayed_work_on</span>(<span style=color:#66d9ef>int</span> cpu, <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>struct</span> delayed_work <span style=color:#f92672>*</span>dwork, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> delay)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> work<span style=color:#f92672>-</span><span style=color:#66d9ef>struct</span> <span style=color:#f92672>*</span>work <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>dwork<span style=color:#f92672>-&gt;</span>work;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> ret <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> flags;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* read the comment in __queue_work() */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>local_irq_save</span>(flags);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>test_and_set_bit</span>(WORK_STRUCT_PENDING_BIT, <span style=color:#a6e22e>work_data_bits</span>(work))) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__queue_delayed_work</span>(cpu, wq, dwork, delay);
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>local_irq_restore</span>(flags);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>__queue_delayed_work()</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="static%20void%20__queue_delayed_work%28int%20cpu,%20struct%20workqueue_struct%20*wq,%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20struct%20dealyed_work%20*dwork,%20unsigned%20long%20delay%29%0a%7b%0a%20%20struct%20timer_list%20*timer%20=%20&amp;dwork-%3etimer;%0a%20%20struct%20work_struct%20*work%20=%20&amp;dwork-%3ework;%0a%0a%20%20WARN_ON_ONCE%28!wq%29;%0a%20%20WARN_ON_ONCE%28timer-%3efunction%20!=%20delayed_work_timer_fn%20%7c%7c%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20timer-%3edata%20!=%20%28unsigned%20long%29dwork%29;%0a%20%20WARN_ON_ONCE%28timer_pending%28timer%29%29;%0a%20%20WARN_ON_ONCE%28!list_empty%28&amp;work-%3eentry%29%29;%0a%0a%20%20if%20%28!delay%29%20%7b%0a%20%20%20%20__queue_work%28cpu,%20wq,%20&amp;dwork-%3ework%29;%0a%20%20%20%20return;%0a%20%20%7d%0a%0a%20%20dwork-%3ewq%20=%20wq;%0a%20%20dwork-%3ecpu%20=%20cpu;%0a%20%20timer-%3eexpires%20=%20jiffies%20+%20delay;%0a%0a%20%20if%20%28unlikely%28cpu%20!=%20WORK_CPU_UNBOUND%29%29%0a%20%20%20%20add_timer_on%28timer,%20cpu%29;%0a%20%20else%0a%20%20%20%20add_tiemr%28timer%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__queue_delayed_work</span>(<span style=color:#66d9ef>int</span> cpu, <span style=color:#66d9ef>struct</span> workqueue_struct <span style=color:#f92672>*</span>wq,
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>struct</span> dealyed_work <span style=color:#f92672>*</span>dwork, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> delay)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> timer_list <span style=color:#f92672>*</span>timer <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>dwork<span style=color:#f92672>-&gt;</span>timer;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> work_struct <span style=color:#f92672>*</span>work <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>dwork<span style=color:#f92672>-&gt;</span>work;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#f92672>!</span>wq);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>WARN_ON_ONCE</span>(timer<span style=color:#f92672>-&gt;</span>function <span style=color:#f92672>!=</span> delayed_work_timer_fn <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>              timer<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>!=</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)dwork);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#a6e22e>timer_pending</span>(timer));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>WARN_ON_ONCE</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>list_empty</span>(<span style=color:#f92672>&amp;</span>work<span style=color:#f92672>-&gt;</span>entry));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>delay) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__queue_work</span>(cpu, wq, <span style=color:#f92672>&amp;</span>dwork<span style=color:#f92672>-&gt;</span>work);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  dwork<span style=color:#f92672>-&gt;</span>wq <span style=color:#f92672>=</span> wq;
</span></span><span style=display:flex><span>  dwork<span style=color:#f92672>-&gt;</span>cpu <span style=color:#f92672>=</span> cpu;
</span></span><span style=display:flex><span>  timer<span style=color:#f92672>-&gt;</span>expires <span style=color:#f92672>=</span> jiffies <span style=color:#f92672>+</span> delay;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>unlikely</span>(cpu <span style=color:#f92672>!=</span> WORK_CPU_UNBOUND))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_timer_on</span>(timer, cpu);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add_tiemr</span>(timer);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h5 id=delayed_work_timer_fn>delayed_work_timer_fn()</h5><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="void%20delayed_work_timer_fn%28unsigned%20long%20__data%29%0a%7b%0a%20%20struct%20delayed_work%20*dwork%20=%20%28struct%20dleayed_work%20*%29__data;%0a%0a%20%20/*%20should%20have%20been%20called%20from%20irqsafe%20timer%20with%20irq%20already%20off%20*/%0a%20%20__queue_work%28dwork-%3ecpu,%20dwork-%3ewq,%20&amp;dwork-%3ework%29;%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delayed_work_timer_fn</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> __data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> delayed_work <span style=color:#f92672>*</span>dwork <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> dleayed_work <span style=color:#f92672>*</span>)__data;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* should have been called from irqsafe timer with irq already off */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>__queue_work</span>(dwork<span style=color:#f92672>-&gt;</span>cpu, dwork<span style=color:#f92672>-&gt;</span>wq, <span style=color:#f92672>&amp;</span>dwork<span style=color:#f92672>-&gt;</span>work);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div><hr><div class=list-files><ul class=section-tree></ul></div></article><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer></body><script src=/js/sidebar.js></script><script src=/js/dir_toggle.js></script><script src=/js/codeblock_copy.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css><script type=module>
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
mermaid.initialize({
  startOnLoad: true,
  theme: "dark",
});
</script></html>
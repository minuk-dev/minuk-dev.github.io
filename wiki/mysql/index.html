<!DOCTYPE html>
<html lang="ko-kr">
    <head>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>mysql (storage engine)</title>
        
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #00a3d2;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 

<link rel="stylesheet" href="/vendor/highlight/styles/default.css">




<link rel="stylesheet" href="/vendor/bootstrap-3.3.7-dist/css/bootstrap.min.css">


<link rel="stylesheet" href="/vendor/font-awesome-4.7.0/css/font-awesome.min.css">
 


    <script src="/vendor/highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>







<script src="/vendor/jquery-3.4.1.min.js"></script>



<script src="/vendor/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>

        

        

        
            
          <script type="text/javascript" async src="/vendor/MathJax-2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        

        <meta name="google-site-verification" content="g_3tJyj-KkW-_wKx7Ij5GimHV1nKPZXetCz8ydbBAfA" />

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">mysql (storage engine)</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/wiki/">Wiki</a></li>
                            
                                <li><a href="/posts/">Posts</a></li>
                            
                                <li><a href="/projects/">Projects</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:makerdark98@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/makerdark98/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://twitter.com/makerdark98/"><i class="fa fa-twitter"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/makerdark98/"><i class="fa fa-linkedin"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.stackoverflow.com/makerdark98/"><i class="fa fa-stack-overflow"></i></a></li>
                            
                            <li>
                              <div style="max-width:300px;display:inline-block;max-height:40px;">
                                <script async src="https://cse.google.com/cse.js?cx=003491619885022567520:wnnypdnx4aj"></script>
<div class="gcse-search"></div>

                              </div>
                            </li>
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div style="text-align:left;">
      <button class="btn btn-link" onclick="history.back();"><i class="fa fa-arrow-left"></i>&nbsp;뒤로 가기 </button>
    </div>
    <div>
        <h2>mysql (storage engine)</h2>
        <a href="https://github.com/makerdark98/makerdark98.github.io/blame/master/src/content/wiki/mysql.md">
  <h5>created : Thu, 28 May 2020 07:48:47 &#43;0900</h5>
  <h5>modified : Fri, 29 May 2020 16:13:17 &#43;0900</h5>
</a>

        
<a href="http://makerdark98.dev/tags/mysql"><kbd class="item-tag">mysql</kbd></a>

<a href="http://makerdark98.dev/tags/storage-engine"><kbd class="item-tag">storage engine</kbd></a>


    </div>

    <aside class="navbar" id="nav-toc" style="text-align:left;"><nav id="TableOfContents">
<ul>
<li><a href="#참고용-홈페이지">참고용 홈페이지</a>
<ul>
<li><a href="#환경-설정">환경 설정</a></li>
<li><a href="#겪었던-문제들">겪었던 문제들</a></li>
<li><a href="#코딩할-때-알아야할-내용">코딩할 때 알아야할 내용</a>
<ul>
<li><a href="#mysys-h-관련">mysys.h 관련</a></li>
<li><a href="#thd-mysql-thread-객체-관련">THD (mysql thread 객체) 관련</a></li>
<li><a href="#debug">Debug</a></li>
</ul></li>
</ul></li>
<li><a href="#참고용-홈페이지-읽고-정리하기">참고용 홈페이지 읽고 정리하기</a>
<ul>
<li>
<ul>
<li><a href="#23-2-overview">23.2 Overview</a></li>
<li><a href="#23-3-creating-storage-engine-source-files">23.3 Creating Storage Engine Source Files</a></li>
<li><a href="#23-4-adding-engine-specific-variables-and-parameters">23.4 Adding Engine Specific Variables and Parameters</a></li>
<li><a href="#23-5-creating-the-handlerton">23.5 Creating the handlerton</a></li>
<li><a href="#23-6-handling-handler-instantiation">23.6 Handling Handler Instantiation</a></li>
<li><a href="#23-7-defining-filename-extensions">23.7 Defining Filename Extensions</a></li>
<li><a href="#23-8-creating-tables">23.8 Creating Tables</a></li>
<li><a href="#23-9-opening-a-table">23.9 Opening a Table</a>
<ul>
<li><a href="#코드-보면서-느낀거">코드 보면서 느낀거</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav></aside>
    <div align="start" class="content" data-spy="scroll" data-offset="20" data-target="#nav-toc" style="position:relative;">
      

<h1 id="참고용-홈페이지">참고용 홈페이지</h1>

<ol>
<li><a href="https://dev.mysql.com/doc/internals/en/custom-engine.html">https://dev.mysql.com/doc/internals/en/custom-engine.html</a></li>
<li>mysql architecture

<ul>
<li><img src="/wiki/images/mysql_architecture.png" alt="mysql architecture" /></li>
</ul></li>
<li><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PFS_PSI.html">https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PFS_PSI.html</a></li>
</ol>

<h2 id="환경-설정">환경 설정</h2>

<ul>
<li>일단 지금 집에다가 예전에 썻던 삼성 노트북을 wol 으로 설정하고 (완전히 꺼지면 안켜지니까 shutdown 을 alias 해놓고, suspend를 사용하는 식으로 했다.휴가 때 마다 혹은 가끔씩 reboot 해주면 되겠지?)</li>
<li>github 에서 다운로드 해서 private repository 에다가 올려놨다.
<code>bash
$ git clone https://github.com/mysql/mysql-server
</code></li>
<li>참고용 홈페이지 1을 보면 알 수 있듯이 <code>storage/example</code> 을 똑같이 카피했다.</li>
<li>일단 지금 목표는 custom engine 을 만들어 보는 거고 가능하다면 2018년 FAST 에 나온 논문인 FAST_PAIR 를 만들어보는거다.</li>

<li><p>일단 공부한 내용을 아래에 써놓겠다.</p>

<h2 id="겪었던-문제들">겪었던 문제들</h2></li>

<li><p>git push 를 할때 너무 많아서 그런지 안올라가진다. -&gt; 브랜치를 나눠서 올리면 된다. mysql 8.0.0 까진 수월하게 올라간다. mysql-8.0.0 브랜치까지 올리고 나머지 올리면 올라가진다. 용량이 커서 안올라가지는 것 같다.</p></li>
</ul>

<h2 id="코딩할-때-알아야할-내용">코딩할 때 알아야할 내용</h2>

<h3 id="mysys-h-관련">mysys.h 관련</h3>

<ol>
<li><code>include/mysys.h</code> 에 사용할만한 함수들이 많이 정리되어 있다.</li>
<li>File 관련 : <code>my_create</code>, <code>my_close</code></li>
<li>문자열 관련 : <code>fn_format</code> (filename format)</li>

<li><p>Memory 관련 : <code>my_malloc</code>, <code>my_free</code></p>

<h3 id="thd-mysql-thread-객체-관련">THD (mysql thread 객체) 관련</h3></li>

<li><p>mysql thread 객체 (<code>THD</code>) 에 변수로 넣으면 (<code>THDVAR_SET</code>) 복사가 일어난다. (추측) -&gt; 따라서 넣어야할 값이 있으면 my_malloc 하고 넣은다음에 my_free 해줘야한다. (Memory Leak 나지 않게 조심하자!)</p></li>

<li><p>Mysql Thread 객체 (THD)에 값 확인, 넣기 : <code>THDVAR(대상 Thread, 원하는 변수명)</code>, <code>THDVAR_SET(대상 Thread, 원하는 변수명, 값의 주소)</code></p></li>
</ol>

<h3 id="debug">Debug</h3>

<ol>
<li>Debug를 위해서 return 같은거 할때 <code>DBUG_RETURN</code> 을 적극적으로 활용하자</li>
</ol>

<h1 id="참고용-홈페이지-읽고-정리하기">참고용 홈페이지 읽고 정리하기</h1>

<h3 id="23-2-overview">23.2 Overview</h3>

<ul>
<li><code>handler</code>라는 interface를 구현하도록 되어 있는데, 각 connection 마다 thread가 생성되고 각 thread마다 handler instance를 생성하고 가지고 있도록 한다.

<ul>
<li>질문점 : 그러면 각 handler들이 같은 table에 접근하게 되면 어떻게 되나 : handler를 구현할때 알아서 해결해야 한다. 가장 단순한 해결법은 table마다 lock을 가지게 해서 동시에 handler들이 접근 못하도록 하는것. (생각해보면 read lock, write lock마다 구현법도 다양하고 mvcc같은거 고려하면 생각할게 너무 많을 텐데 당연하게도 storage engine이 알아서 처리하도록 하는게 맞다)</li>
</ul></li>

<li><p>read-only -&gt; insert, update, delete -&gt; indexing, transactions -&gt; other advanced options 순서로 구현하라고 한다.</p>

<h3 id="23-3-creating-storage-engine-source-files">23.3 Creating Storage Engine Source Files</h3></li>

<li><p><code>example</code> 을 복사해서 수정하는게 제일 단순하다 (사실 이렇게 공식 홈페이지 적어놓을만 한게, innobase(=innodb)코드를 보고 비슷하게 만들어보려고 시도했는데, 나에게는 이건 너무 어려웠다. ㅠ)</p>

<h3 id="23-4-adding-engine-specific-variables-and-parameters">23.4 Adding Engine Specific Variables and Parameters</h3></li>

<li><p>구조가 Plugin 식으로 추가되는 식인것 같은데 그래서 Plugin 을 만드는 방법에 대해서 나와있다.</p></li>

<li><p>이걸 열심히 공부하는것도 맞지만, 조금 목표와 멀어질 것 같아서 일단은 innobase 꺼 CMakeLists.txt 를 참고했고, 나중에 필요하면 다시 보면 될거라고 생각한다.</p>

<h3 id="23-5-creating-the-handlerton">23.5 Creating the handlerton</h3></li>

<li><p><code>handlerton</code> (= handler singleton) : storage engine 마다 1개씩 있는 객체로, transaction을 다루는 commit, rollbacks 같은 기능을 제공하게 된다.</p>

<pre><code class="language-cpp">typedef struct
{
const char *name; /* storage engine 의 이름 : CREATE TABLE ... ENGINE=FOO; 에 쓰인다. */
SHOW_COMP_OPTION state; /* SHOW STORAGE ENGINES command를 사용하면 출력되는 값 */
const char *comment; /* SHOW  STORAGE ENGINES command를 사용할때 출력되는 설명 */
enum db_type db_type; /* custom engine 은 반드시 DB_TYPE_UNKNOWN 을 사용해야한다고 합니다. */
bool (*init)(); /* Server 가 시작할때 딱 1번 불리게 되고, handler가 instance 화 되기 전에 처리되야할 내용을 넣으면된다. */
uint slot; /* storage engine 마다 고유하게 가지고있는 메모리 영역 thd-&gt;ha_data[foo_hton.slot]으로 접근가능하고, Rollback 구현할떄 참조하라고 적혀있음 */
uint savepoint_offset; /* savepoint 의 위치, 0이면 savepoint memory가 필요하지 않다. */
int  (*close_connection)(THD *thd);
int  (*savepoint_set)(THD *thd, void *sv);
int  (*savepoint_rollback)(THD *thd, void *sv);
int  (*savepoint_release)(THD *thd, void *sv);
int  (*commit)(THD *thd, bool all);
int  (*rollback)(THD *thd, bool all);
int  (*prepare)(THD *thd, bool all);
int  (*recover)(XID *xid_list, uint len);
int  (*commit_by_xid)(XID *xid);
int  (*rollback_by_xid)(XID *xid);
void *(*create_cursor_read_view)();
void (*set_cursor_read_view)(void *);
void (*close_cursor_read_view)(void *);
handler *(*create)(TABLE *table);
void (*drop_database)(char* path);
int (*panic)(enum ha_panic_function flag);
int (*release_temporary_latches)(THD *thd);
int (*update_statistics)();
int (*start_consistent_snapshot)(THD *thd);
bool (*flush_logs)();
bool (*show_status)(THD *thd, stat_print_fn *print, enum ha_stat_type stat);
int (*repl_report_sent_binlog)(THD *thd, char *log_file_name, my_off_t end_offset);
uint32 flags;
} handlerton;
</code></pre></li>

<li><p>적다보니 아래 부분은 transcation 을 구현할때나 필요한 부분이라 나중에 생각하기로 했다. 대충 공식 메뉴얼정도만 읽었고 굳이 번역해놓을 필요는 없을듯?</p></li>
</ul>

<h3 id="23-6-handling-handler-instantiation">23.6 Handling Handler Instantiation</h3>

<pre><code class="language-cpp">static handler* example_create_handler (TABLE* table);
</code></pre>

<ul>
<li>handler 생성 함수를 만들어야된다.</li>

<li><p>handler constructor를 단순히 호출하는 형식으로 구현할 수도 있다. (아래 예시는 myisam 의 구현)</p>

<pre><code class="language-cpp">static handler *myisam_create_handler(TABLE *table)
{
return new ha_myisam(table);
}
</code></pre></li>

<li><p>constructor 의 구현 예시</p>

<pre><code class="language-cpp">ha_federated::ha_federated(TABLE *table_arg)
:handler(&amp;federated_hton, table_arg),
mysql(0), stored_result(0), scan_flag(0),
ref_length(sizeof(MYSQL_ROW_OFFSET)), current_position(0)
{}
</code></pre></li>
</ul>

<h3 id="23-7-defining-filename-extensions">23.7 Defining Filename Extensions</h3>

<ul>
<li>지원하는 확장자를 <code>const char* []</code> 로 넘기면 처리해준다</li>
<li>단 array 의 마지막 은 <code>NullS</code> 로 끝나야함.</li>
<li>아래 코드는 csv 예시
<br /></li>
</ul>

<pre><code class="language-cpp">static const char *ha_tina_exts[] = {
  &quot;.CSV&quot;,
  NullS
};
</code></pre>

<ul>
<li>이렇게 정의된 array를 다음과 같이 설정해주면 됨.
<br /></li>
</ul>

<pre><code class="language-cpp">const char **ha_tina::bas_ext() const
{
  return ha_tina_exts;
}
</code></pre>

<ul>
<li><code>DROP TABLE</code> 에서 table을 지웠을 때 파일이 삭제되는 기능을 딱히 구현하지 않고 생략해도 된다.</li>
<li>근데 이건 필수가 아닌 건지, <code>handler</code> class에 따로 선언되어 있지는 않다. -&gt; 직접 구현했는데 혹시 문제가 생길수도 있으니 메모해놓는다.</li>
</ul>

<h3 id="23-8-creating-tables">23.8 Creating Tables</h3>

<pre><code class="language-cpp">virtual int create(const char *name, TABLE *form, HA_CREATE_INFO *info)=0;
</code></pre>

<ul>
<li>위 함수를 반드시 구현하라고 한다.</li>
<li><code>name</code> 은 <code>table</code>의 이름</li>
<li><code>form</code> 은 <code>tablename</code> 이랑 매칭되는 <code>TABLE</code> structure : <code>tablename.frm</code> 이라는 파일에 이미 다 만들어 놨으니, Storage Engine은 이를 변경하면 안됨.</li>
<li><code>info</code> 는 <code>CREATE TABLE</code>을 했을 때 생기는 정보. <code>handler.h</code>에 정의 되어 있으니 참조.
<br /></li>
</ul>

<pre><code class="language-cpp">typedef struct st_ha_create_information
{
    CHARSET_INFO *table_charset, *default_table_charset;
    LEX_STRING connect_string;
    const char *comment,*password;
    const char *data_file_name, *index_file_name;
    const char *alias;
    ulonglong max_rows,min_rows;
    ulonglong auto_increment_value;
    ulong table_options;
    ulong avg_row_length;
    ulong raid_chunksize;
    ulong used_fields;
    SQL_LIST merge_list;
    enum db_type db_type;
    enum row_type row_type;
    uint null_bits;                       /* NULL bits at start of record */
    uint options;                         /* OR of HA_CREATE_ options */
    uint raid_type,raid_chunks;
    uint merge_insert_method;
    uint extra_size;                      /* length of extra data segment */
    bool table_existed;                /* 1 in create if table existed */
    bool frm_only;                        /* 1 if no ha_create_table() */
    bool varchar;                         /* 1 if table has a VARCHAR */
} HA_CREATE_INFO;
</code></pre>

<ul>
<li>storage engine 이 파일 기반이라는 가정하에 <code>form</code>, <code>info</code>는 신경 쓰지 않아도 됨.</li>
<li>csv engine 같은 경우 아래와 같이 구현되어 있음
<br /></li>
</ul>

<pre><code>int ha_tina::create(const char *name, TABLE *table_arg,
  HA_CREATE_INFO *create_info)
{
    char name_buff[FN_REFLEN];
    File create_file;
    DBUG_ENTER(&quot;ha_tina::create&quot;);

    if ((create_file= my_create(fn_format(name_buff, name, &quot;&quot;, &quot;.CSV&quot;,
          MY_REPLACE_EXT|MY_UNPACK_FILENAME),0,
          O_RDWR | O_TRUNC,MYF(MY_WME))) &lt; 0)
    DBUG_RETURN(-1);

    my_close(create_file,MYF(0));

    DBUG_RETURN(0);
}
</code></pre>

<ul>
<li>흐음&hellip;. 딱히 예제 코드에서 수정할게 없어보여서 거의 그대로 가져왔다.</li>
<li>변경한 부분은 확장자 부분이랑, ccls에서 warning을 뱉길레 if문 안에 assignment구문을 넣지 않고 밖으로 뺴기만 했다.</li>
<li>그리고 원래 example source에 thread variable 을 설정하는 예시로 현재 사용하고 있는 Thread(아마도 내 추측으로는 client의 connection과 동일한 맥락을 가질듯, server에서는 connection 당 1개의 thread가 붙어서 담당한다고 알고 있음, 이건 위에 Overview 참고)마다 생성시킨 Table 개수를 tracking 하는 코드가 있었는데, 굳이 문제가 안될것 같아서 냅뒀다.</li>
</ul>

<h3 id="23-9-opening-a-table">23.9 Opening a Table</h3>

<ul>
<li>read나 write 연산 전에 반드시 table data와 index file(있다면)을 열도록 되어있다.
<br /></li>
</ul>

<pre><code class="language-cpp">int open(const char *name, int mode, int test_if_locked);
</code></pre>

<ul>
<li><code>name</code>은 table 의 이름</li>
<li><code>mode</code>는 <code>O_RDONLY</code>(Open read only) 또는 <code>O_RDWR</code>(Open read/write)</li>
<li><code>test_if_locked</code>는 파일을 열 때 확인해야할 내용에 대한 값이고,
<br /></li>
</ul>

<pre><code class="language-cpp">#define HA_OPEN_ABORT_IF_LOCKED   0   /* default */
#define HA_OPEN_WAIT_IF_LOCKED    1
#define HA_OPEN_IGNORE_IF_LOCKED  2
#define HA_OPEN_TMP_TABLE         4   /* Table is a temp table */
#define HA_OPEN_DELAY_KEY_WRITE   8   /* Don't update index */
#define HA_OPEN_ABORT_IF_CRASHED  16
#define HA_OPEN_FOR_REPAIR        32  /* open even if crashed */
</code></pre>

<ul>
<li>이 값들중 하나이다.</li>
<li>lock을 어떻게 다루는지 같은건 <code>get_share()</code>와 <code>free_share()</code>를 참조하라고 한다.</li>
</ul>

<h4 id="코드-보면서-느낀거">코드 보면서 느낀거</h4>

<ul>
<li><code>handler::ha_open</code> 이라는 메서드가 존재하는데 얘가 <code>handler::open</code>을 호출하는 구조이다. (정확히 여기서는 <code>handler</code>를 상속받은 custom storage engine의 open이라는 메서드)</li>
<li>csv 의 <code>ha_tina</code>를 보면 (물론 여기서는 싱글톤? share를 활용해서 파일을 여는 구조인것 같다.) <code>mysql_file_open</code> 이라는 메서드를 사용해서 처리하는데, 여기서 받는 첫번째 인자가 <code>PSI_file_key</code>인데 이게 먼지 모르겠다. 참조 3에 있는 홈페이지에서 검색해서 찾아보면, 계측된? (instrumented) 파일 이라고 하는데&hellip;. 아예 innobase에서는 <code>mysql_file_open</code> 이라는 걸 사용하지도 않는다. csv에서도 static하게 선언해놓고 그냥 사용한다. 자동으로 채워지는 데이터 구조인지 잘모르겠다.</li>
<li>흐음&hellip; 찾아보았는데 file을 생성할 때 PSI_file_key를 같이 주고서 생성하면 넣어주는 방식인듯. 내가 구현할 때는 <code>my_create</code>를 사용해서 생성했으니까, 그냥 <code>my_open</code>으로 파일을 열어서 사용하면 될 듯. 사용하는 곳들을 보니까 전부 singleton 이거나 metadata 임.</li>
</ul>

    </div>

  <script>
      ;(function() {
              var content = document.querySelector('.content');
        content.innerHTML = content.innerHTML.replace(/\[\[(.+?)\]\]\{(.+?)\}/g, (original, matching, display) => {
          console.log(matching, display);
          return `<a href="/wiki/${matching.toLowerCase().replace(/ /g, '-').replace(/[()]/g, '')}">${display}</a>`;
        });
        content.innerHTML = content.innerHTML.replace(/\[\[(.+?)\]\]/g, (original, matching) =>
          `<a href="/wiki/${matching.toLowerCase().replace(/ /g, '-').replace(/[()]/g, '')}">${matching}</a>`);
      })();
</script>

  <div style="min-width:500px;">
<script src="https://utteranc.es/client.js"
        repo="makerdark98/makerdark98.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>

</main>
        <footer>
            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>


<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/simpledotcss/simple.css><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.140.0"><meta name=description content="minuk.dev wiki"><meta name=keywords content="hugo,site,new"><meta name=author content="Min-Uk.Lee"><title>Running Containerd and k3s on MacOS |
minuk dev wiki
</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></head><body><header class=header><div class=header_left><a href=/><img class=logo src=/images/Rb.png alt=logo>
MinUk.Dev</a></div><div class=header_middle>Running Containerd and k3s on MacOS</div></header><main><article class=main><div class=title><h1 class=title-header>Running Containerd and k3s on MacOS</h1></div><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/running-containerd-and-k3s-on-macos.md><h5>created : Fri, 19 Aug 2022 01:01:46 +0900</h5><h5>modified : Fri, 19 Aug 2022 01:48:53 +0900</h5></a><div class=article-meta><div class="breadcumb content"><i class="bi bi-folder"></i>
[[kubecon]]</div></div><div class=list-terms><ul><i class="bi bi-tags" title=Tags></i>
<a href=/tags/kubecon class=tag-btn>kubecon</a>
<a href=/tags/containerd class=tag-btn>containerd</a></ul></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#why-run-containers-on-macos>Why run containers on macOS?</a></li><li><a href=#existing-methods>Existing methods</a></li><li><a href=#our-solution-lima>Our solution: Lima</a></li><li><a href=#lima--linux-machine>Lima = LInux MAchine</a></li><li><a href=#continaerd-with-lima>continaerd with Lima</a></li><li><a href=#k3s-with-lima>k3s with Lima</a></li><li><a href=#extra-docker-with-lima>Extra: Docker with Lima</a></li><li><a href=#extra-podman-with-lima>Extra: Podman with Lima</a></li><li><a href=#how-it-works-hypervisor>How it works: Hypervisor</a></li><li><a href=#how-it-works-filesystem-sharing>How it works: Filesystem sharing</a></li><li><a href=#how-its-works-port-forwarding>How its works: Port forwarding</a></li><li><a href=#enterprise-dns-requirements>Enterprise DNS Requirements</a></li><li><a href=#how-it-works-host-resolver>How it works: Host Resolver</a></li><li><a href=#how-it-works-proxy-settings>How it works: Proxy Settings</a></li><li><a href=#port-forwarding-limitations>Port Forwarding Limitations</a></li><li><a href=#how-it-works-vde_vmnet>How it works: vde_vmnet</a></li><li><a href=#lima-community-after-one-year>Lima community after one year</a></li><li><a href=#third-party-foss-projects>Third party FOSS projects</a></li><li><a href=#개인생각>개인생각</a></li></ul></nav></aside><div class=content><ul><li><a href=https://youtu.be/g5GCsbjkzRM>원본</a>, Kubecon EU 2022</li><li><a href=https://static.sched.com/hosted_files/kccnceu2022/5f/lima.pdf>Slide</a></li><li><a href=https://events.linuxfoundation.org/archive/2022/kubecon-cloudnativecon-europe/program/schedule/>Slide 출처</a></li></ul><h2 id=why-run-containers-on-macos>Why run containers on macOS?</h2><ul><li>2022 is The Year of the Linux Desktop</li><li>But ordinary developers still need macOS (or Windows)</li><li>Almost solely for the dev & test environment</li><li>Not the best fit for running a production server</li></ul><h2 id=existing-methods>Existing methods</h2><ul><li><p>Docker Desktop for Mac has been the popular solution</p></li><li><p>Supports automatic host filesystem sharing</p></li><li><p>Supports automatic port forwarding</p></li><li><p>But proprietary</p></li><li><p>Just install Docker and Kubernetes inside a Linux VM? Maybe via minikube?:</p><ul><li>VMWare Fusion and Parallels are proprietary</li><li>VirtualBox is FLOSS but won&rsquo;t support M1</li><li>QEMU is FLOSS and supports M1, but still:<ul><li>Not easy to access the host FS from the containers</li><li>Not easy to access the container ports from the host</li></ul></li></ul></li></ul><h2 id=our-solution-lima>Our solution: Lima</h2><ul><li><p>Similar to WSL2 but for macOS hosts</p></li><li><p>Automatic host filesystem sharing</p></li><li><p>Automatic port forwarding</p></li><li><p>Built-in integration for containerd</p></li></ul><h2 id=lima--linux-machine>Lima = LInux MAchine</h2><ul><li>Originally designed as &ldquo;containerd machine&rdquo; to mimic Docker Machine</li><li>The scope was extended immediately to cover other use cases too</li><li>Still focuses on containerd and k3s</li></ul><h2 id=continaerd-with-lima>continaerd with Lima</h2><ul><li><p>continared: the de facto standard container runtime:</p><ul><li>CNCF Graudated project</li><li>Not just made for Kubernetes</li><li>Provides the docker-compatible CLI too: nerdctl</li><li>With a lot of cutting-edge features:<ul><li>Lazy-pulling, IPFS, OCIcryupt, Faster rootless&mldr;</li></ul></li></ul></li><li><p>Lima provides built-in support for containerd</p></li><li><p>Even supports running Intel(AMD64) containers on M1(ARM64) and vice versa, using <a href=https://github.com/tonistiigi/binfmt>tonistiigi/binfmt</a></p></li></ul><h2 id=k3s-with-lima>k3s with Lima</h2><ul><li>k3s: Lightweight Kubernetes:<ul><li>CNCF Sandbox project</li><li>Adopts containerd as the CRI runtime</li><li>Works with Lima too</li></ul></li></ul><h2 id=extra-docker-with-lima>Extra: Docker with Lima</h2><ul><li>The original design was only to support containerd, but the scope is now expanded to support Docker Engine too</li></ul><h2 id=extra-podman-with-lima>Extra: Podman with Lima</h2><h2 id=how-it-works-hypervisor>How it works: Hypervisor</h2><ul><li>Vanilla QEMU</li><li>Supports both Intel and ARM</li><li>Even supports Intel-on-ARM and ARM-on-Intel (slow though)</li><li>FAQ: why not use Apple&rsquo;s Virtualization.framework?:<ul><li>Proprietary</li><li>Limited functionalities</li></ul></li></ul><h2 id=how-it-works-filesystem-sharing>How it works: Filesystem sharing</h2><ul><li><p>Lima &lt; 1.0 : reverse SSHFS:</p><ul><li>macOS works as an SSH client but as an SFTP server</li><li>Linux works an SSH server but as an SFTP client</li></ul></li><li><p>Lima >= 1.0 : virtio-9p-pci, aka virtfs( not virtio-fs):</p><ul><li>Less weirdness</li><li>Lima 1.0 is probably available by the time of KubeCon</li></ul></li><li><p>FAQ: why not use virtio-fs (faster than virtfs) ?:</p><ul><li>QEMU still doesn&rsquo;t implement virtio-fs for macOS hosts</li><li>Apple&rsquo;s Virtualization.framework implements virtio-fs, but it is proprietary and lacks other functionalities</li></ul></li></ul><h2 id=how-its-works-port-forwarding>How its works: Port forwarding</h2><ul><li>THe guest is accessible as localhost from the host</li><li>Watch guest events, and run <code>ssh -L</code> to let SSH forward TCP ports</li><li>Event sources:<ul><li><code>/proc/net/{tcp,tcp6}</code>: For non-CNI ports</li><li><code>iptables</code>, <code>AUDIT_NETFILTER_CFG</code> : For CNI ports</li></ul></li></ul><h2 id=enterprise-dns-requirements>Enterprise DNS Requirements</h2><ul><li>Use nameservers from VPN connections</li><li>Support for split-DNS</li><li>Other QEMU DNS limitations:<ul><li>Picks single random nameserver from <code>/etc/resolv.conf</code></li><li>Cannot support mDNS</li><li>Doesn&rsquo;t load <code>/etc/hosts</code> from the host</li></ul></li></ul><h2 id=how-it-works-host-resolver>How it works: Host Resolver</h2><ul><li>여긴 그림이 있는데, 그림은 글 상단의 Slide Page 19 를 참고하면 된다.</li><li>대충 이해한대로 설명을 써보자면,:<ul><li>Lima VM 은 QEMU 내부에서 실행되며, QEMU Internal Network 에 Virtual Network 로 붙어있다.</li><li>QEMU 내부에 존재하며, Host 와 연결을 해주는 HostGateWay로 Resolver를 요청한다.</li><li>HostGateway는 Host 위에서 동작하는 Lima Host Agent에 있는 Host Resolver와 DNS over UDP&amp;TCP 로 통신한다.</li><li>즉, 기존에 QEMU 내에 구현되어있던 DNS가 <code>/etc/resolv.conf</code> 에서 무작위로 선택하는 방식에서, macOS resolver를 최종적으로 호출하는 구조를 형성하여 <code>/etc/resolv.conf</code>, <code>/etc/hosts</code>, mdnsResponder, VPN 등에서 Domain Name을 가져오는게 가능해졌다.</li></ul></li><li>영상에서 굉장히 설명을 깔끔하게 잘하고 있으니 영상을 설명을 들으면 좋다.</li></ul><h2 id=how-it-works-proxy-settings>How it works: Proxy Settings</h2><ol><li>Network settings</li><li>lima.yaml</li><li>Environment variable</li></ol><ul><li>이것만 적어두면 조금 이해가 어려운데, Host Netowrk를 설정하고, lima.yaml 에 환경변수로 <code>https_proxy</code>,<code>http_proxy</code>를 127.0.0.1 에서 192.168.5.2 로 교체, 나머지 환경변수들을 설정해둔뒤 lima를 시작하면 된다.</li><li>궁금점 : 192.168.5.2 는 고정인건가?</li></ul><h2 id=port-forwarding-limitations>Port Forwarding Limitations</h2><ul><li>Port forwarding is delayed up to 3s due to polling</li><li>Port may already be in use on the host</li><li>Guest IP != Host IP breaks external IP for k8s services</li><li>UDP is not supported by ssh port forwarding</li></ul><h2 id=how-it-works-vde_vmnet>How it works: vde_vmnet</h2><ul><li>이거 글로만 적으려니 어렵다. Slide 22 쪽을 참고하자. 그림은 그렇게 어렵지 않다.</li></ul><h2 id=lima-community-after-one-year>Lima community after one year</h2><ul><li>45 contributors</li><li>400 merged pull requests</li><li>26 releases</li><li>8k stars on Github</li></ul><h2 id=third-party-foss-projects>Third party FOSS projects</h2><ul><li>Lima-GUI</li><li>Colima</li><li>Rancher Desktop</li></ul><hr><h2 id=개인생각>개인생각</h2><ul><li>UDP 가 안된다는건 이거 안들었으면 몰랐을것 같다. Network를 이런식으로 구성해놨는지 몰랐다.</li><li>lima 를 굉장히 자주 사용하고 있는데, 쓰면서 큰 장애를 못느꼇는데 생각보다 안되는게 좀 있었다는게 신기하다.</li><li>hosts 파일이라던가 몇몇 기능을 지원하기 위해서 lima agent 를 띄우는 방식은 참신하다. 하지만 근본적인 해결책이라고 보이지는 않는다. QEMU 는 보안상, 또는 기능상의 이유로 막아두었을텐데 왜 그런지 좀 알았으면 이해가 더 좋았을 것같다.</li><li>filesystem layer에 대해서 고민을 많이한게 보인다.</li></ul></div><hr><div class=list-files><ul class=section-tree></ul></div></article><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer></body><script src=/js/dir_toggle.js></script><script src=/js/codeblock_copy.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css><script type=module>
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
mermaid.initialize({
  startOnLoad: true,
  theme: "dark",
});
</script></html>
<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>This is The Way- A Crash Course on the Intricacies of Managing CPUs in K8s</title><style>html body{font-family:raleway,sans-serif;background-color:#fff}:root{--accent:#00a3d2;--border-width:5px}</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/copy-btn.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=/js/copy-btn.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98056974-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-98056974-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta name=google-site-verification content="g_3tJyj-KkW-_wKx7Ij5GimHV1nKPZXetCz8ydbBAfA"></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>This is The Way- A Crash Course on the Intricacies of Managing CPUs in K8s</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/wiki/>Wiki</a></li><li><a href=/posts/>Posts</a></li><li><a href=/about/>About</a></li></ul></div></div></nav><main><div class=navigator style=display:flex><div style=display:flex><div class=parent-doc style=flex:none><button class="btn btn-link" onclick='(function(e){e.querySelector("a").click()})(this)'>
<i class="fa fa-arrow-left"></i>
[[kubecon]]</button></div></div></div><div><h2>This is The Way- A Crash Course on the Intricacies of Managing CPUs in K8s</h2><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/this-is-the-way-a-crash-course-on-intricacies-of-managing-cpus.md><h5>created : Fri, 05 Aug 2022 02:07:46 +0900</h5><h5>modified : Fri, 05 Aug 2022 02:09:13 +0900</h5></a><a href=https://minuk.dev/tags/kubecon><kbd class=item-tag>kubecon</kbd></a>
<a href=https://minuk.dev/tags/numa><kbd class=item-tag>numa</kbd></a>
<a href=https://minuk.dev/tags/devops><kbd class=item-tag>devops</kbd></a></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#simple-systems>Simple Systems</a></li><li><a href=#high-performance-uses-cases>High Performance Uses Cases</a><ul><li><a href=#cpu-manager---pinned-cores>CPU Manager - Pinned Cores</a></li><li><a href=#cpu-manager-policies>CPU Manager Policies</a></li><li><a href=#cpu-manager-policy-options>CPU Manager Policy Options</a></li></ul></li><li><a href=#numa-zones-not-for-the-weak-of-heart>NUMA Zones: Not for the weak of heart</a><ul><li><a href=#along-comes-topology-management>Along Comes Topology Management</a></li><li><a href=#going-with-the-topology-flow>Going with the Topology Flow</a></li></ul></li><li><a href=#current-gaps-for-high-performance-compute>Current Gaps for High Performance Compute</a><ul><li><a href=#heterogeneous-clusters>Heterogeneous Clusters</a></li><li><a href=#out-of-tree-solutions-for-cpu-management>Out of Tree solutions for CPU management</a></li></ul></li><li><a href=#how-can-you-get-involved>How Can YOU Get Involved?</a></li><li><a href=#개인-생각>개인 생각</a></li></ul></nav></aside><div align=start class=content data-spy=scroll data-offset=20 data-target=#nav-toc style=position:relative><ul><li><a href=https://youtu.be/IFEJD1YOpXo>원본 링크</a></li><li>Scope : We will cover CPU Management requirements Only, but also reference other projects.</li></ul><h2 id=simple-systems>Simple Systems</h2><ul><li>Nodes<ul><li>Single NIC</li><li>Single Socket CPU</li><li>Memory</li></ul></li><li>Kubelet was designed for simple at first</li><li>Early Kubelet</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># &lt; Kubernetes v1.8 - before 2017</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>frontend</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>my-company.example/myapp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#e6db74>&#34;64Mi&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cpu</span>: <span style=color:#e6db74>&#34;250m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#e6db74>&#34;128Mi&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cpu</span>: <span style=color:#e6db74>&#34;500m&#34;</span>
</span></span></code></pre></div><ul><li>Resources supported:<ul><li>CPU</li><li>Memory</li></ul></li><li>Reuqests: Ask for resources for your container</li><li>Limits: limit the amount of resources consumed by the container</li><li>Resource Mangement in Kubelet<ul><li>Kubernetes v1.8-v.11 (2017-2018)</li><li>Pre-allocated hugepage support as native resources (Alpha support v1.8, graduated to Beta in v.11)</li><li>CPU Manager support to enable container level CPU affinity support (Alpha support v1.8, graduated to Beta in v.11)</li><li>Device Plugin Support to enable a consistent and portable solution for users to consume hardware devices across k8s clusters(Alpha support in v1.8, graduated to Beta in v.10)</li></ul></li></ul><h2 id=high-performance-uses-cases>High Performance Uses Cases</h2><ul><li>Performance Sensitive Workloads</li><li>High Performance, AI/ML Clusters<ul><li>Multiple CPU Socket</li><li>Multiple NIC</li><li>Multiple Numa</li></ul></li></ul><h3 id=cpu-manager---pinned-cores>CPU Manager - Pinned Cores</h3><ul><li>Cpu Manager with static policy allocates CPUs exclusively for a container if<ul><li>pod QoS is Guaranteed</li><li>has a positive integer CPU request</li><li>does not change CPU assignments for exclusively pinned guaranteed containers after the main container process start</li></ul></li></ul><h3 id=cpu-manager-policies>CPU Manager Policies</h3><ul><li><code>--cpu-manager-policy</code> kubelet flag used to specify the policy</li><li>None:<ul><li>Default</li><li>Provides no affinity beyond what the OS scheduler does automatically</li><li>Can handle partial CPUs</li></ul></li><li>Static:<ul><li>allows containers access to exclusive CPUs on the node</li><li>does not change CPU assignments for exclusively pinned guaranteed containers after the main container process starts</li><li>Only uses whole CPUs, so increases perceived CPU utilization</li><li>Only by container, not by pod</li></ul></li></ul><h3 id=cpu-manager-policy-options>CPU Manager Policy Options</h3><ul><li>Introduced in v1.22, Beta in v1.23</li><li><code>--cpu-manager-policy-options</code> : kubelet flag used to specify the policy option</li><li>full-pcpus-only:<ul><li>Beta option, visible by default</li><li>the static policy will always allocate full physical cores, so guarantee same NUMA zone.</li><li>Fails with SMTAlignmentError for partial core allocation</li></ul></li><li>distribute-cpus-acorss-numa:<ul><li>alpha, hidden by default</li><li>the static policy will evenly distribute CPUs across NUMA nodes</li><li>Still per container</li></ul></li></ul><h2 id=numa-zones-not-for-the-weak-of-heart>NUMA Zones: Not for the weak of heart</h2><ul><li>If CPU and Memory are located in different NUMA zones, …</li></ul><h3 id=along-comes-topology-management>Along Comes Topology Management</h3><ul><li>Kubernetes v1.8 (2019 onwards)</li><li>Topology Manger to coordinate resource assignment to avoid cross NUMA assignments (alpha support v1.16, graduated to beta in v1.18)</li><li>Memory Manager for guarnteed memory (and hugepages) allocation to pods (alpha support v1.21, graduated to beta in v1.22))</li><li>Known Issue: Scheduler is not NUMA aware and pod can fail with TopologyAffinityError if kubelet is unable to align all the resources based on the Topology Manager policy.</li></ul><h3 id=going-with-the-topology-flow>Going with the Topology Flow</h3><p>kubelet - Admit()</p><p>— Topology Manager - Get Topology Hints()</p><p>—— HintProvides (CPU Manager, Device Manager, Memory Manager)</p><p>— Topology Manager - Allocate()</p><p>kubelet - AddContainer</p><h2 id=current-gaps-for-high-performance-compute>Current Gaps for High Performance Compute</h2><ul><li>Cores cannot be pinned by pod</li><li>Affinity node-level only, CANNOT choose affinity of resources.</li><li>Can’t mix pinned with shared cores</li><li>Limits with larger numbers of NUMA zones</li><li>Cannot schedule one pod or container per NUMA zone</li><li>Cannot choose what type of CPUs</li><li>Cannot ask for more cpus on the fly</li></ul><h3 id=heterogeneous-clusters>Heterogeneous Clusters</h3><ul><li>Fun for the whole family</li></ul><hr><h3 id=out-of-tree-solutions-for-cpu-management>Out of Tree solutions for CPU management</h3><ul><li>All rely on turning off all resource management by the Kublet - specifically cpu manager features</li><li>CRI Resource Manager (CRI-RM):<ul><li>a pluggable add-on for controlling resource assignment to containers</li><li>plugs in between the Kubelet and the container runtime</li><li>keeps track of the states of all containers on a node</li><li>intercepts CRI protocol requests from the kubelet</li></ul></li><li>CPU Pooler:<ul><li>A solution for Kubernetes to manage predefined, distinct CPU pools of Kubernetes Nodes</li><li>physically separate the CPU resources of the containers connecting to the various pools</li><li>A Device Plugin that exposes the CPU cores as consumable devices to Kubernetes.</li></ul></li><li>CMK (deprecated now):<ul><li>accomplished core isolation by controlling the logical CPUs each container may use for execution</li><li>wrapped target application commands with the CMK command-line program for managing CPU pools and constraining workloads to specific CPUs</li></ul></li></ul><h2 id=how-can-you-get-involved>How Can YOU Get Involved?</h2><hr><h2 id=개인-생각>개인 생각</h2><ul><li>Kubernetes 는 Pod 로 추상화 하기 때문에 결국 매우 고성능이 요구되는 환경에서는 문제가 발생한다.</li><li>예를 들어 특히 NUMA(Non-Uniform Memory Access) 환경을 들수 있는데, AI/ML 환경에서는 (뿐만 아니라 다중 소켓이 들어간 어떤 서버라도) CPU가 메모리에 접근할때 메모리 영역에 따라서 성능이 달라진다.</li><li>또한, 다른 컨테이너와 함께 CPU를 쓰게 되면, 고성능 처리가 필요해서 스케쥴링을 안하고 그 프로세스만을 돌리고 싶다고 해도 그렇게 동작하는게 불가능하다. 이를 위해서 독점적으로 CPU를 사용하고, 모든 자원이 같은 NUMA 영역 안에 들어오는 것을 보장하는 옵션들을 제공한다.</li><li>하지만 이와 같은 해결책은 결국 미봉책이 될수 있다. 왜냐하면 이와같은 요구사항들은 계속해서 증가하는데, Kubelet은 이를 위해서 계속 확장하기에는 부담이 가기 때문이다. 따라서 CRI-RM 과 같은 규격을 만들어서 plugin 형태로 이를 해결하려는 시도가 생기고 있다.</li></ul></div><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer>
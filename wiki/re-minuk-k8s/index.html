<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/simpledotcss/simple.css><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.140.0"><meta name=description content="minuk.dev wiki"><meta name=keywords content="hugo,site,new"><meta name=author content="Min-Uk.Lee"><title>다시 시작하는 쿠버네티스 세팅 |
minuk dev wiki
</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></head><body><header class=header><div class=header_left><a href=/><img class=logo src=/images/Rb.png alt=logo>
MinUk.Dev</a></div><div class=header_middle>다시 시작하는 쿠버네티스 세팅</div></header><main><article class=main><div class=title><h1 class=title-header>다시 시작하는 쿠버네티스 세팅</h1></div><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/re-minuk-k8s.md><h5>created : Thu, 17 Nov 2022 02:33:21 +0900</h5><h5>modified : Tue, 29 Nov 2022 00:31:26 +0900</h5></a><div class=article-meta><div class="breadcumb content"><i class="bi bi-folder"></i>
[[devops]]</div></div><div class=list-terms><ul><i class="bi bi-tags" title=Tags></i>
<a href=/tags/k8s class=tag-btn>k8s</a></ul></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#개요>개요</a><ul><li><a href=#목표>목표</a></li><li><a href=#1-kubespray-설정>1. kubespray 설정</a></li><li><a href=#2-argocd-설정>2. argocd 설정</a></li><li><a href=#3-ingress-설정>3. ingress 설정</a></li><li><a href=#4-cert-manager-cluster-issuer-설정>4. cert-manager, cluster issuer 설정</a></li></ul></li></ul></nav></aside><div class=content><h2 id=개요>개요</h2><ul><li>뭔가 너무 막썻다. 처음부터 다시 천천히 기록하면서 클러스터를 세팅하자</li></ul><h3 id=목표>목표</h3><h4 id=인프라적-목표>인프라적 목표</h4><ul><li>kubespray 를 통한 설치</li><li>argocd 만 helm 으로 관리, 나머지는 모두 argocd 를 통한 gitops</li><li>monitoring 을 위한 loki 와 grafana dashboard</li><li>vault 와 harbor 설치</li></ul><h4 id=사용-관점의-목표>사용 관점의 목표</h4><ul><li>jupyter notebook 를 띄워서 언제나 접속해서 간단한 스크립팅을 할수 있는 환경</li><li>임시 pod 과 이를 위한 계정 발급을 통한 리눅스 샌드박스 서버 찍어내기</li><li>github action runner 를 통한 다중 architecture 빌드 및 테스트 지원</li></ul><h3 id=1-kubespray-설정>1. kubespray 설정</h3><ul><li><p><a href=https://developer-ankiwoong.tistory.com/1673>참고자료</a> :</p><ul><li>한국어로 되어있는 것중에서는 제일 괜찮은 듯</li></ul></li><li><p><strong>모든 노드에서</strong> swap off</p></li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=swapoff%20-a>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>swapoff -a</span></span></code></pre></div></div><ul><li><strong>모든 노드에서</strong> ip_forward 설정을 한다.</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=echo%201%20%3e%20/proc/sys/net/ipv4/ip_forward%0a#%20check%20configuration%0a#%20cat%20/proc/sys/net/ipv4/ip_forward>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#ae81ff>1</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span style=display:flex><span><span style=color:#75715e># check configuration</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cat /proc/sys/net/ipv4/ip_forward</span></span></span></code></pre></div></div><ul><li><strong>모든 노드에서</strong> password 없이 root 를 사용할 수 있도록 설정한다.</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="groupadd%20wheel%0ausermod%20-G%20wheel%20%3cusername%3e%0a#%20edit%20/etc/pam.d/su%0a#%20uncomment%20auth%20sufficient%20pam_wheel.so%20trust%20use_uid%0a#%20edit%20/etc/sudoers%0a#%20Add%20%3cusername%3e%20ALL=%28ALL%29%20NOPASSWD:%20ALL">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>groupadd wheel
</span></span><span style=display:flex><span>usermod -G wheel &lt;username&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># edit /etc/pam.d/su</span>
</span></span><span style=display:flex><span><span style=color:#75715e># uncomment auth sufficient pam_wheel.so trust use_uid</span>
</span></span><span style=display:flex><span><span style=color:#75715e># edit /etc/sudoers</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add &lt;username&gt; ALL=(ALL) NOPASSWD: ALL</span></span></span></code></pre></div></div><ul><li>실행은 mac 에서 할것이므로 <code>/etc/hosts</code> 에 다음과 같이 내용을 추가한다.</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=192.168.0.8%20master%0a192.168.0.9%20worker1>
<i class="bi bi-copy"></i></button></div><pre><code>192.168.0.8 master
192.168.0.9 worker1</code></pre></div><ul><li>working directory 를 만들고 그곳에 asdf 를 통해 환경 버전관리를 한다.</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=mkdir%20-p%20~/workspace/minuk-cluster>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/workspace/minuk-cluster</span></span></code></pre></div></div><ul><li>kubespray repo clone</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#ZgotmplZ>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/kubernetes-sigs/kubespray</span></span></code></pre></div></div><ul><li>install libraries</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#%20on%20kubespray/%0apip3%20install%20-r%20requirements.txt>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># on kubespray/</span>
</span></span><span style=display:flex><span>pip3 install -r requirements.txt</span></span></code></pre></div></div><ul><li>configure inventory</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=cp%20-rfp%20inventory/sample%20inventory/minuk-cluster>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp -rfp inventory/sample inventory/minuk-cluster</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#ZgotmplZ>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[all]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>master  ansible_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;username&gt; ansible_host=192.168.0.8 ip=192.168.0.8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker1 ansible_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;username&gt; ansible_host=192.168.0.9 ip=192.168.0.9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[kube-master]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[etcd]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[kube-node]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[calico_rr]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[k8s_cluster:children]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kube_control_plane</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kube_node</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>calico_rr</span></span></span></code></pre></div></div><ul><li>provisioning cluster</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="ansible-playbook%20-i%20./inventory/minuk-cluster/inventory.ini%20cluster.yml%20--become%20--become-user=root">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i ./inventory/minuk-cluster/inventory.ini cluster.yml --become --become-user<span style=color:#f92672>=</span>root</span></span></code></pre></div></div><ul><li><p>실제로 실행시켜보면, github 에서 파일 다운 받는데, 중간중간 실패한다. 단순히 다시 실행해주면 해결된다.</p></li><li><p>다시 실행해도 안되면 reset 하고 다시 하면 된다.</p><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="ansible-playbook%20-i%20./inventory/minuk-cluster/inventory.ini%20reset.yml%20--become%20--become-user=root">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i ./inventory/minuk-cluster/inventory.ini reset.yml --become --become-user<span style=color:#f92672>=</span>root</span></span></code></pre></div></div></li><li><p>중간에 이것저것 하다보니 calico 가 설치가 이상하게 되었다는 것을 알았다.:</p><ul><li><code>/opt/cni/calico</code> 와 관련되어 파일이 없다고 나올 때 : <a href=https://projectcalico.docs.tigera.io/getting-started/kubernetes/hardway/install-cni-plugin>다음 링크</a> 를 참고하여 파일을 노드 위에 설치해주자</li></ul></li></ul><h3 id=2-argocd-설정>2. argocd 설정</h3><ul><li><p>앞으로 cluster 위의 모든 자원을 argocd 로 gitops 할 계획이므로, argocd 를 설치한다.</p></li><li><p>따라서, helm 으로 argocd 를 설치한다.</p></li><li><p><a href=https://github.com/minuk-dev/minuk-cluster/tree/master/helm/argocd>해당 디렉토리 확인</a></p></li><li><p>argocd 초기 admin password 얻기</p></li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="kubectl%20-n%20argocd%20get%20secret%20argocd-initial-admin-secret%20-o%20jsonpath=%22%7b.data.password%7d%22%20%7c%20base64%20-d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.data.password}&#34;</span> | base64 -d</span></span></code></pre></div></div><ul><li>argocd 에 접속하기(현재는 ingress 가 전혀 없으므로, 그냥 port-forward 로 접속한다.)</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=kubectl%20port-forward%20service/argocd-server%20-n%20argocd%208080:443>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward service/argocd-server -n argocd 8080:443</span></span></code></pre></div></div><h3 id=3-ingress-설정>3. ingress 설정</h3><ul><li><p>일단은 익숙한 nginx 로 설정하자:</p><ul><li>나중에 istio 를 고민하자.</li></ul></li><li><p><a href=https://github.com/minuk-dev/minuk-cluster/tree/master/argocd/nginx-ingress-controller>해당 디렉토리 확인</a></p></li></ul><h3 id=4-cert-manager-cluster-issuer-설정>4. cert-manager, cluster issuer 설정</h3><ul><li><p>앞으로도 argocd 를 이렇게 접속할 수는 없다. nginx 로 설정해주기 전에 cluster issuer 를 등록해준다.</p></li><li><p><a href=https://github.com/minuk-dev/minuk-cluster/tree/master/argocd/cert-manager>해당 디렉토리 확인</a></p></li><li><p>드는 고민: 순서상으로 argocd 를 먼저 설치, nginx 를 그 다음에 설치했는데, 이제 nginx 에 argocd ingress 옵션을 켜주면 되긴 하는데, 이러면 순서대로 실행했을때 동일한 상태가 안나온다.:</p><ul><li>argocd 를 깔때 nginx 에 대한 dependency 가 생기기 때문에</li><li>결론 : values 를 두가지를 유지하자. 하나는 nginx 를 설치하기 전, 하나는 nginx 를 설치한 이후로 분리해서 보관하자. 일단은 시간이 늦었으니 고민만 해두고 오늘은 여기까지</li></ul></li></ul></div><hr><div class=list-files><ul class=section-tree></ul></div></article><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer></body><script src=/js/dir_toggle.js></script><script src=/js/codeblock_copy.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css><script type=module>
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
mermaid.initialize({
  startOnLoad: true,
  theme: "dark",
});
</script></html>
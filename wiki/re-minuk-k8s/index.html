<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>다시 시작하는 쿠버네티스 세팅</title><style>html body{font-family:raleway,sans-serif;background-color:#fff}:root{--accent:#00a3d2;--border-width:5px}</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/copy-btn.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=/js/copy-btn.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98056974-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-98056974-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta name=google-site-verification content="g_3tJyj-KkW-_wKx7Ij5GimHV1nKPZXetCz8ydbBAfA"></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>다시 시작하는 쿠버네티스 세팅</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/wiki/>Wiki</a></li><li><a href=/posts/>Posts</a></li><li><a href=/about/>About</a></li></ul></div></div></nav><main><div class=navigator style=display:flex><div style=display:flex><div class=parent-doc style=flex:none><button class="btn btn-link" onclick='(function(e){e.querySelector("a").click()})(this)'>
<i class="fa fa-arrow-left"></i>
[[devops]]</button></div></div></div><div><h2>다시 시작하는 쿠버네티스 세팅</h2><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/re-minuk-k8s.md><h5>created : Thu, 17 Nov 2022 02:33:21 +0900</h5><h5>modified : Tue, 29 Nov 2022 00:31:26 +0900</h5></a><a href=https://minuk.dev/tags/k8s><kbd class=item-tag>k8s</kbd></a></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#개요>개요</a><ul><li><a href=#목표>목표</a></li><li><a href=#1-kubespray-설정>1. kubespray 설정</a></li><li><a href=#2-argocd-설정>2. argocd 설정</a></li><li><a href=#3-ingress-설정>3. ingress 설정</a></li><li><a href=#4-cert-manager-cluster-issuer-설정>4. cert-manager, cluster issuer 설정</a></li></ul></li></ul></nav></aside><div align=start class=content data-spy=scroll data-offset=20 data-target=#nav-toc style=position:relative><h2 id=개요>개요</h2><ul><li>뭔가 너무 막썻다. 처음부터 다시 천천히 기록하면서 클러스터를 세팅하자</li></ul><h3 id=목표>목표</h3><h4 id=인프라적-목표>인프라적 목표</h4><ul><li>kubespray 를 통한 설치</li><li>argocd 만 helm 으로 관리, 나머지는 모두 argocd 를 통한 gitops</li><li>monitoring 을 위한 loki 와 grafana dashboard</li><li>vault 와 harbor 설치</li></ul><h4 id=사용-관점의-목표>사용 관점의 목표</h4><ul><li>jupyter notebook 를 띄워서 언제나 접속해서 간단한 스크립팅을 할수 있는 환경</li><li>임시 pod 과 이를 위한 계정 발급을 통한 리눅스 샌드박스 서버 찍어내기</li><li>github action runner 를 통한 다중 architecture 빌드 및 테스트 지원</li></ul><h3 id=1-kubespray-설정>1. kubespray 설정</h3><ul><li><p><a href=https://developer-ankiwoong.tistory.com/1673>참고자료</a> :</p><ul><li>한국어로 되어있는 것중에서는 제일 괜찮은 듯</li></ul></li><li><p><strong>모든 노드에서</strong> swap off</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>swapoff -a
</span></span></code></pre></div><ul><li><strong>모든 노드에서</strong> ip_forward 설정을 한다.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#ae81ff>1</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span style=display:flex><span><span style=color:#75715e># check configuration</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cat /proc/sys/net/ipv4/ip_forward</span>
</span></span></code></pre></div><ul><li><strong>모든 노드에서</strong> password 없이 root 를 사용할 수 있도록 설정한다.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>groupadd wheel
</span></span><span style=display:flex><span>usermod -G wheel &lt;username&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># edit /etc/pam.d/su</span>
</span></span><span style=display:flex><span><span style=color:#75715e># uncomment auth sufficient pam_wheel.so trust use_uid</span>
</span></span><span style=display:flex><span><span style=color:#75715e># edit /etc/sudoers</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add &lt;username&gt; ALL=(ALL) NOPASSWD: ALL</span>
</span></span></code></pre></div><ul><li>실행은 mac 에서 할것이므로 <code>/etc/hosts</code> 에 다음과 같이 내용을 추가한다.</li></ul><pre tabindex=0><code>192.168.0.8 master
192.168.0.9 worker1
</code></pre><ul><li>working directory 를 만들고 그곳에 asdf 를 통해 환경 버전관리를 한다.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/workspace/minuk-cluster
</span></span></code></pre></div><ul><li>kubespray repo clone</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/kubernetes-sigs/kubespray
</span></span></code></pre></div><ul><li>install libraries</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># on kubespray/</span>
</span></span><span style=display:flex><span>pip3 install -r requirements.txt
</span></span></code></pre></div><ul><li>configure inventory</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp -rfp inventory/sample inventory/minuk-cluster
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[all]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>master  ansible_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;username&gt; ansible_host=192.168.0.8 ip=192.168.0.8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker1 ansible_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;username&gt; ansible_host=192.168.0.9 ip=192.168.0.9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[kube-master]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[etcd]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[kube-node]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>worker1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[calico_rr]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[k8s_cluster:children]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kube_control_plane</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kube_node</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>calico_rr</span>
</span></span></code></pre></div><ul><li>provisioning cluster</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i ./inventory/minuk-cluster/inventory.ini cluster.yml --become --become-user<span style=color:#f92672>=</span>root
</span></span></code></pre></div><ul><li><p>실제로 실행시켜보면, github 에서 파일 다운 받는데, 중간중간 실패한다. 단순히 다시 실행해주면 해결된다.</p></li><li><p>다시 실행해도 안되면 reset 하고 다시 하면 된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i ./inventory/minuk-cluster/inventory.ini reset.yml --become --become-user<span style=color:#f92672>=</span>root
</span></span></code></pre></div></li><li><p>중간에 이것저것 하다보니 calico 가 설치가 이상하게 되었다는 것을 알았다.:</p><ul><li><code>/opt/cni/calico</code> 와 관련되어 파일이 없다고 나올 때 : <a href=https://projectcalico.docs.tigera.io/getting-started/kubernetes/hardway/install-cni-plugin>다음 링크</a> 를 참고하여 파일을 노드 위에 설치해주자</li></ul></li></ul><h3 id=2-argocd-설정>2. argocd 설정</h3><ul><li><p>앞으로 cluster 위의 모든 자원을 argocd 로 gitops 할 계획이므로, argocd 를 설치한다.</p></li><li><p>따라서, helm 으로 argocd 를 설치한다.</p></li><li><p><a href=https://github.com/minuk-dev/minuk-cluster/tree/master/helm/argocd>해당 디렉토리 확인</a></p></li><li><p>argocd 초기 admin password 얻기</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.data.password}&#34;</span> | base64 -d
</span></span></code></pre></div><ul><li>argocd 에 접속하기(현재는 ingress 가 전혀 없으므로, 그냥 port-forward 로 접속한다.)</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward service/argocd-server -n argocd 8080:443
</span></span></code></pre></div><h3 id=3-ingress-설정>3. ingress 설정</h3><ul><li><p>일단은 익숙한 nginx 로 설정하자:</p><ul><li>나중에 istio 를 고민하자.</li></ul></li><li><p><a href=https://github.com/minuk-dev/minuk-cluster/tree/master/argocd/nginx-ingress-controller>해당 디렉토리 확인</a></p></li></ul><h3 id=4-cert-manager-cluster-issuer-설정>4. cert-manager, cluster issuer 설정</h3><ul><li><p>앞으로도 argocd 를 이렇게 접속할 수는 없다. nginx 로 설정해주기 전에 cluster issuer 를 등록해준다.</p></li><li><p><a href=https://github.com/minuk-dev/minuk-cluster/tree/master/argocd/cert-manager>해당 디렉토리 확인</a></p></li><li><p>드는 고민: 순서상으로 argocd 를 먼저 설치, nginx 를 그 다음에 설치했는데, 이제 nginx 에 argocd ingress 옵션을 켜주면 되긴 하는데, 이러면 순서대로 실행했을때 동일한 상태가 안나온다.:</p><ul><li>argocd 를 깔때 nginx 에 대한 dependency 가 생기기 때문에</li><li>결론 : values 를 두가지를 유지하자. 하나는 nginx 를 설치하기 전, 하나는 nginx 를 설치한 이후로 분리해서 보관하자. 일단은 시간이 늦었으니 고민만 해두고 오늘은 여기까지</li></ul></li></ul></div><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer>
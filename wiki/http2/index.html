<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>http2 탐구</title><style>html body{font-family:raleway,sans-serif;background-color:#fff}:root{--accent:#00a3d2;--border-width:5px}</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/copy-btn.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=/js/copy-btn.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-98056974-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-98056974-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><meta name=google-site-verification content="g_3tJyj-KkW-_wKx7Ij5GimHV1nKPZXetCz8ydbBAfA"></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>http2 탐구</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/wiki/>Wiki</a></li><li><a href=/posts/>Posts</a></li><li><a href=/about/>About</a></li></ul></div></div></nav><main><div class=navigator style=display:flex><div style=display:flex><div class=parent-doc style=flex:none><button class="btn btn-link" onclick='(function(e){e.querySelector("a").click()})(this)'>
<i class="fa fa-arrow-left"></i>
[[devops]]</button></div></div></div><div><h2>http2 탐구</h2><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/http2.md><h5>created : Wed, 03 Aug 2022 15:42:58 +0900</h5><h5>modified : Wed, 03 Aug 2022 15:44:45 +0900</h5></a><a href=https://minuk.dev/tags/http><kbd class=item-tag>http</kbd></a>
<a href=https://minuk.dev/tags/http2><kbd class=item-tag>http2</kbd></a></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#rfc-7540-과-go-코드-뜯어보기>RFC 7540 과 go 코드 뜯어보기</a><ul><li><a href=#http-버전별-분기>HTTP 버전별 분기</a></li><li><a href=#http2-multiplexed-stream>HTTP2 Multiplexed stream</a></li><li><a href=#stream-prioritization>Stream Prioritization</a></li><li><a href=#server-push>Server Push</a></li><li><a href=#header-compression>Header Compression</a></li></ul></li></ul></nav></aside><div align=start class=content data-spy=scroll data-offset=20 data-target=#nav-toc style=position:relative><ul><li>동기 : gRPC 에서 bidirection을 지원하는데 이게 http2 에서 이미 지원하고 있어서 라는 사실을 알게 되었다. http2 에 대해 너무 모르고 있었던 것 같아서 정리한다.</li></ul><hr><ul><li>특징 알아보기<ul><li><a href=https://www.popit.kr/%EB%82%98%EB%A7%8C-%EB%AA%A8%EB%A5%B4%EA%B3%A0-%EC%9E%88%EB%8D%98-http2/>출처 - 나만 모르고 있던 http2</a></li><li>HTTP/1.1 의 문제점<ul><li>HOL(Head Of Line) Blocking</li><li>반복적인 3-way Handshake 로 인한 RTT 증가</li><li>언제나 Cookie를 보내면서 무거운 Header 구조</li></ul></li><li>Multiplexed Streams</li><li>Stream Prioritization</li><li>Server Push</li><li>Header Compression</li></ul></li></ul><hr><h2 id=rfc-7540-과-go-코드-뜯어보기>RFC 7540 과 go 코드 뜯어보기</h2><ul><li>특징이 나와있는 사이트들은 정말 많지만, 코드 레벨로 말하는 곳은 얼마 없다.</li><li>RFC 문서와 구현 코드를 비교하면서 정리하자.</li><li>golang 에서는 아직 standard library인 net/http 는 http 1.1 만을 지원하는 것 같다. http2 는 <a href=http://golang.org/x/net/http2>golang.org/x/net/http2</a> 를 사용해야한다.</li></ul><h3 id=http-버전별-분기>HTTP 버전별 분기</h3><pre tabindex=0><code>3.1.  HTTP/2 Version Identification

   The protocol defined in this document has two identifiers.

   o  The string &#34;h2&#34; identifies the protocol where HTTP/2 uses
      Transport Layer Security (TLS) [TLS12].  This identifier is used
      in the TLS application-layer protocol negotiation (ALPN) extension
      [TLS-ALPN] field and in any place where HTTP/2 over TLS is
      identified.

      The &#34;h2&#34; string is serialized into an ALPN protocol identifier as
      the two-octet sequence: 0x68, 0x32.
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/http2.go#L53
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>NextProtoTLS</span> = <span style=color:#e6db74>&#34;h2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// net/http/server.go#L2630
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>TLSNextProto</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#a6e22e>Handler</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L304
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>TLSNextProto</span>[<span style=color:#a6e22e>NextProtoTLS</span>] = <span style=color:#a6e22e>protoHandler</span>
</span></span></code></pre></div><ul><li>위와 같이 상수값으로 정의하고 http 모듈에서 TLS 상의 ALPN(Application Layer Protocol Negotiation) 을 통해서 TLSNextProto에 있는 handler mapping 을 사용해서 사용한다.</li></ul><hr><h3 id=http2-multiplexed-stream>HTTP2 Multiplexed stream</h3><pre tabindex=0><code>5.1.  Stream States

   The lifecycle of a stream is shown in Figure 2.

                                +--------+
                        send PP |        | recv PP
                       ,--------|  idle  |--------.
                      /         |        |         \
                     v          +--------+          v
              +----------+          |           +----------+
              |          |          | send H /  |          |
       ,------| reserved |          | recv H    | reserved |------.
       |      | (local)  |          |           | (remote) |      |
       |      +----------+          v           +----------+      |
       |          |             +--------+             |          |
       |          |     recv ES |        | send ES     |          |
       |   send H |     ,-------|  open  |-------.     | recv H   |
       |          |    /        |        |        \    |          |
       |          v   v         +--------+         v   v          |
       |      +----------+          |           +----------+      |
       |      |   half   |          |           |   half   |      |
       |      |  closed  |          | send R /  |  closed  |      |
       |      | (remote) |          | recv R    | (local)  |      |
       |      +----------+          |           +----------+      |
       |           |                |                 |           |
       |           | send ES /      |       recv ES / |           |
       |           | send R /       v        send R / |           |
       |           | recv R     +--------+   recv R   |           |
       | send R /  `-----------&gt;|        |&lt;-----------&#39;  send R / |
       | recv R                 | closed |               recv R   |
       `-----------------------&gt;|        |&lt;----------------------&#39;
                                +--------+

          send:   endpoint sends this frame
          recv:   endpoint receives this frame

          H:  HEADERS frame (with implied CONTINUATIONs)
          PP: PUSH_PROMISE frame (with implied CONTINUATIONs)
          ES: END_STREAM flag
          R:  RST_STREAM frame
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/http2.go#L100
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stateName</span> = [<span style=color:#f92672>...</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stateIdle</span>:             <span style=color:#e6db74>&#34;Idle&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateOpen</span>:             <span style=color:#e6db74>&#34;Open&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateHalfClosedLocal</span>:  <span style=color:#e6db74>&#34;HalfClosedLocal&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateHalfClosedRemote</span>: <span style=color:#e6db74>&#34;HalfClosedRemote&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateClosed</span>:           <span style=color:#e6db74>&#34;Closed&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L1506
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverConn</span>) <span style=color:#a6e22e>closeStream</span>(<span style=color:#a6e22e>st</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stream</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>serveG</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>st</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>stateIdle</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>st</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>stateClosed</span> {
</span></span></code></pre></div><ul><li>stream의 lifecycle 이다. closeStream() 을 호출할 때 state를 체크하고 있는 걸 볼수 있다.</li></ul><pre tabindex=0><code>4.1.  Frame Format

   All frames begin with a fixed 9-octet header followed by a variable-
   length payload.

    +-----------------------------------------------+
    |                 Length (24)                   |
    +---------------+---------------+---------------+
    |   Type (8)    |   Flags (8)   |
    +-+-------------+---------------+-------------------------------+
    |R|                 Stream Identifier (31)                      |
    +=+=============================================================+
    |                   Frame Payload (0...)                      ...
    +---------------------------------------------------------------+

                          Figure 1: Frame Layout
</code></pre><pre tabindex=0><code>5.1.1.  Stream Identifiers

   Streams are identified with an unsigned 31-bit integer.  Streams
   initiated by a client MUST use odd-numbered stream identifiers; those
   initiated by the server MUST use even-numbered stream identifiers.  A
   stream identifier of zero (0x0) is used for connection control
   messages; the stream identifier of zero cannot be used to establish a
   new stream.
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L492
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>serverConn</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>streams</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>uint32</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>stream</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L1455
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverConn</span>) <span style=color:#a6e22e>processWindowUpdate</span>(<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WindowUpdateFrame</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>serveG</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>StreamID</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>: <span style=color:#75715e>// stream-level flow control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>st</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>state</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>StreamID</span>)
</span></span></code></pre></div><ul><li>frame 의 구성에서 frame payload 전에 stream identifier 가 담겨있는 것을 볼 수 있다.</li><li>stream은 streamID 를 통해서 관리되며, 어떠한 입력이 왔을 때 streamID 를 통해 상태를 조회하고, 동작하는 것을 코드로도 볼 수 있다.</li><li>즉, Multiplexed Streams 을 지원한다는 이야기이다.</li></ul><hr><h3 id=stream-prioritization>Stream Prioritization</h3><p>Stream Prioritization 은 둘러보다가 testcode랑 구현 내용을 발견하긴 했는데, 어떻게 구현했을지가 크게 궁금하지도 않고, 코드를 뜯어보는 비용에 비해서 크게 남는게 없을거 같아서 생략한다.</p><hr><h3 id=server-push>Server Push</h3><pre tabindex=0><code>8.2.  Server Push

   HTTP/2 allows a server to pre-emptively send (or &#34;push&#34;) responses
   (along with corresponding &#34;promised&#34; requests) to a client in
   association with a previous client-initiated request.  This can be
   useful when the server knows the client will need to have those
   responses available in order to fully process the response to the
   original request.
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L807
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverConn</span>) <span style=color:#a6e22e>serve</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// skip until #L879
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>serveMsgCh</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>msg</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// skip until #L899
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			  <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>startPushRequest</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>startPush</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>   <span style=color:#75715e>// skip
</span></span></span></code></pre></div><ul><li>위 코드를 이해하려면 다른 http, http2 의 코드들의 배경지식도 필요하다.</li><li>대충 설명하면, <code>serve()</code> 함수는 <code>http.ListenAndServe()</code> 가 호출되었을 때 결과적으로 호출되게 되는 함수이다. (살짝 다르긴 하지만, [[go-http]] 참고)</li><li>이렇게 그리고 http2 는 channel 과 goroutine 을 통해서 보내야하는 내용을 제어하고 있다.</li><li><code>startPush()</code> 는 별다른 게 없는 함수다. 읽어보면 그냥 규격대로 구현되어 있고, 특별한 점을 찾지는 않아서 적지는 않았다.</li><li>위 구현은 golang 을 잘 활용해서 구현한거니, 아마도 다른 언어에서는 쓰레드와 producer-consumer queue를 활용해서 구현해놨을 것 같다.</li></ul><hr><h3 id=header-compression>Header Compression</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ae81ff>4.3</span>.  <span style=color:#a6e22e>Header</span> <span style=color:#a6e22e>Compression</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Decompression</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Just</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>field</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>name</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>or</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>associated</span> <span style=color:#a6e22e>values</span>.  <span style=color:#a6e22e>Header</span> <span style=color:#a6e22e>fields</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>used</span> <span style=color:#a6e22e>within</span> <span style=color:#a6e22e>HTTP</span> <span style=color:#a6e22e>request</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>response</span> <span style=color:#a6e22e>messages</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>well</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>server</span> <span style=color:#a6e22e>push</span> <span style=color:#a6e22e>operations</span> (<span style=color:#a6e22e>see</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>8.2</span>).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Header</span> <span style=color:#a6e22e>lists</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>collections</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>zero</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>fields</span>.  <span style=color:#a6e22e>When</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>transmitted</span> <span style=color:#a6e22e>over</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>list</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>serialized</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>block</span> <span style=color:#a6e22e>using</span> <span style=color:#a6e22e>HTTP</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>compression</span> [<span style=color:#a6e22e>COMPRESSION</span>].  <span style=color:#a6e22e>The</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>serialized</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>block</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>then</span> <span style=color:#a6e22e>divided</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>octet</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>sequences</span>, <span style=color:#a6e22e>called</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>block</span> <span style=color:#a6e22e>fragments</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>transmitted</span> <span style=color:#a6e22e>within</span> <span style=color:#a6e22e>the</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>payload</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>HEADERS</span> (<span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>6.2</span>), <span style=color:#a6e22e>PUSH_PROMISE</span> (<span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>6.6</span>), <span style=color:#a6e22e>or</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>CONTINUATION</span> (<span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>6.10</span>) <span style=color:#a6e22e>frames</span>.
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L415
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>hpackEncoder</span> = <span style=color:#a6e22e>hpack</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>headerWriteBuf</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewFramer</span>(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>bw</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>ReadMetaHeaders</span> = <span style=color:#a6e22e>hpack</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>initialHeaderTableSize</span>, <span style=color:#66d9ef>nil</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/frame.go#L487
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Framer</span>) <span style=color:#a6e22e>ReadFrame</span>() (<span style=color:#a6e22e>Frame</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip until L516
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fh</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>FrameHeaders</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>ReadMetaHeaders</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>readMetaFrame</span>(<span style=color:#a6e22e>f</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>HeadersFrame</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>어떻게 compression 할지는 추가적으로 정의가 되어있고, 여기서는 그냥 이를 사용만 한다.</li><li>위 코드를 보면 framer 에 Decoder 로 hpack 을 넣어주는 것을 볼 수있다.</li><li>이를 사용해서 frame을 읽는다.</li><li>쓰기 부분은 추가적으로 찾지는 않았지만 sc.hpackEncoder 를 통해서 할 것 이라고 추정할 수 있다.</li></ul></div><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer>
<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/simpledotcss/simple.css><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.140.0"><meta name=description content="minuk.dev wiki"><meta name=keywords content="hugo,site,new"><meta name=author content="Min-Uk.Lee"><title>http2 탐구 |
minuk dev wiki
</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></head><body><header class=header><div class=header_left><a href=/><img class=logo src=/images/Rb.png alt=logo>
MinUk.Dev</a></div><div class=header_middle>http2 탐구</div></header><main><article class=main><div class=title><h1 class=title-header>http2 탐구</h1></div><a href=https://github.com/minuk-dev/minuk-dev.github.io/blame/master/content/wiki/http2.md><h5>created : Wed, 03 Aug 2022 15:42:58 +0900</h5><h5>modified : Wed, 03 Aug 2022 15:44:45 +0900</h5></a><div class=article-meta><div class="breadcumb content"><i class="bi bi-folder"></i>
[[devops]]</div></div><div class=list-terms><ul><i class="bi bi-tags" title=Tags></i>
<a href=/tags/http class=tag-btn>http</a>
<a href=/tags/http2 class=tag-btn>http2</a></ul></div><aside class=navbar id=nav-toc style=text-align:left><nav id=TableOfContents><ul><li><a href=#rfc-7540-과-go-코드-뜯어보기>RFC 7540 과 go 코드 뜯어보기</a><ul><li><a href=#http-버전별-분기>HTTP 버전별 분기</a></li><li><a href=#http2-multiplexed-stream>HTTP2 Multiplexed stream</a></li><li><a href=#stream-prioritization>Stream Prioritization</a></li><li><a href=#server-push>Server Push</a></li><li><a href=#header-compression>Header Compression</a></li></ul></li></ul></nav></aside><div class=content><ul><li>동기 : gRPC 에서 bidirection을 지원하는데 이게 http2 에서 이미 지원하고 있어서 라는 사실을 알게 되었다. http2 에 대해 너무 모르고 있었던 것 같아서 정리한다.</li></ul><hr><ul><li>특징 알아보기<ul><li><a href=https://www.popit.kr/%EB%82%98%EB%A7%8C-%EB%AA%A8%EB%A5%B4%EA%B3%A0-%EC%9E%88%EB%8D%98-http2/>출처 - 나만 모르고 있던 http2</a></li><li>HTTP/1.1 의 문제점<ul><li>HOL(Head Of Line) Blocking</li><li>반복적인 3-way Handshake 로 인한 RTT 증가</li><li>언제나 Cookie를 보내면서 무거운 Header 구조</li></ul></li><li>Multiplexed Streams</li><li>Stream Prioritization</li><li>Server Push</li><li>Header Compression</li></ul></li></ul><hr><h2 id=rfc-7540-과-go-코드-뜯어보기>RFC 7540 과 go 코드 뜯어보기</h2><ul><li>특징이 나와있는 사이트들은 정말 많지만, 코드 레벨로 말하는 곳은 얼마 없다.</li><li>RFC 문서와 구현 코드를 비교하면서 정리하자.</li><li>golang 에서는 아직 standard library인 net/http 는 http 1.1 만을 지원하는 것 같다. http2 는 <a href=http://golang.org/x/net/http2>golang.org/x/net/http2</a> 를 사용해야한다.</li></ul><h3 id=http-버전별-분기>HTTP 버전별 분기</h3><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=3.1.%20%20HTTP/2%20Version%20Identification%0a%0a%20%20%20The%20protocol%20defined%20in%20this%20document%20has%20two%20identifiers.%0a%0a%20%20%20o%20%20The%20string%20%22h2%22%20identifies%20the%20protocol%20where%20HTTP/2%20uses%0a%20%20%20%20%20%20Transport%20Layer%20Security%20%28TLS%29%20[TLS12].%20%20This%20identifier%20is%20used%0a%20%20%20%20%20%20in%20the%20TLS%20application-layer%20protocol%20negotiation%20%28ALPN%29%20extension%0a%20%20%20%20%20%20[TLS-ALPN]%20field%20and%20in%20any%20place%20where%20HTTP/2%20over%20TLS%20is%0a%20%20%20%20%20%20identified.%0a%0a%20%20%20%20%20%20The%20%22h2%22%20string%20is%20serialized%20into%20an%20ALPN%20protocol%20identifier%20as%0a%20%20%20%20%20%20the%20two-octet%20sequence:%200x68,%200x32.>
<i class="bi bi-copy"></i></button></div><pre><code>3.1.  HTTP/2 Version Identification

   The protocol defined in this document has two identifiers.

   o  The string &#34;h2&#34; identifies the protocol where HTTP/2 uses
      Transport Layer Security (TLS) [TLS12].  This identifier is used
      in the TLS application-layer protocol negotiation (ALPN) extension
      [TLS-ALPN] field and in any place where HTTP/2 over TLS is
      identified.

      The &#34;h2&#34; string is serialized into an ALPN protocol identifier as
      the two-octet sequence: 0x68, 0x32.</code></pre></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/http2.go#L53%0aconst%20%28%0a%20%20/*%20skip%20*/%0a%20%20NextProtoTLS%20=%20%22h2%22%0a%20%20/*%20skip%20*/%0a%29">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/http2.go#L53
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>NextProtoTLS</span> = <span style=color:#e6db74>&#34;h2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* skip */</span>
</span></span><span style=display:flex><span>)</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=//%20net/http/server.go#L2630%0atype%20Server%20struct%20%7b%0a%20%20//%20skip%0a%20%20TLSNextProto%20map[string]func%28*Server,%20*tls.Conn,%20Handler%29%0a%20%20//%20skip%0a%7d>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// net/http/server.go#L2630
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Server</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>TLSNextProto</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#a6e22e>Handler</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/server.go#L304%0a%20%20s.TLSNextProto[NextProtoTLS]%20=%20protoHandler">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L304
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>TLSNextProto</span>[<span style=color:#a6e22e>NextProtoTLS</span>] = <span style=color:#a6e22e>protoHandler</span></span></span></code></pre></div></div><ul><li>위와 같이 상수값으로 정의하고 http 모듈에서 TLS 상의 ALPN(Application Layer Protocol Negotiation) 을 통해서 TLSNextProto에 있는 handler mapping 을 사용해서 사용한다.</li></ul><hr><h3 id=http2-multiplexed-stream>HTTP2 Multiplexed stream</h3><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=5.1.%20%20Stream%20States%0a%0a%20%20%20The%20lifecycle%20of%20a%20stream%20is%20shown%20in%20Figure%202.%0a%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20+--------+%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20send%20PP%20%7c%20%20%20%20%20%20%20%20%7c%20recv%20PP%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20,--------%7c%20%20idle%20%20%7c--------.%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20/%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%5c%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20+--------+%20%20%20%20%20%20%20%20%20%20v%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20+----------+%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20+----------+%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20send%20H%20/%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20,------%7c%20reserved%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20recv%20H%20%20%20%20%7c%20reserved%20%7c------.%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%7c%20%28local%29%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%20%28remote%29%20%7c%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20+----------+%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20%20+----------+%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20+--------+%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20recv%20ES%20%7c%20%20%20%20%20%20%20%20%7c%20send%20ES%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20send%20H%20%7c%20%20%20%20%20,-------%7c%20%20open%20%20%7c-------.%20%20%20%20%20%7c%20recv%20H%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20/%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%5c%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20v%20%20%20v%20%20%20%20%20%20%20%20%20+--------+%20%20%20%20%20%20%20%20%20v%20%20%20v%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20+----------+%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20+----------+%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%7c%20%20%20half%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20half%20%20%20%7c%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%7c%20%20closed%20%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20send%20R%20/%20%20%7c%20%20closed%20%20%7c%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%7c%20%28remote%29%20%7c%20%20%20%20%20%20%20%20%20%20%7c%20recv%20R%20%20%20%20%7c%20%28local%29%20%20%7c%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20+----------+%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20+----------+%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%20send%20ES%20/%20%20%20%20%20%20%7c%20%20%20%20%20%20%20recv%20ES%20/%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%20send%20R%20/%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20send%20R%20/%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%20recv%20R%20%20%20%20%20+--------+%20%20%20recv%20R%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%7c%0a%20%20%20%20%20%20%20%7c%20send%20R%20/%20%20%60-----------%3e%7c%20%20%20%20%20%20%20%20%7c%3c-----------%27%20%20send%20R%20/%20%7c%0a%20%20%20%20%20%20%20%7c%20recv%20R%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%20closed%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20recv%20R%20%20%20%7c%0a%20%20%20%20%20%20%20%60-----------------------%3e%7c%20%20%20%20%20%20%20%20%7c%3c----------------------%27%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20+--------+%0a%0a%20%20%20%20%20%20%20%20%20%20send:%20%20%20endpoint%20sends%20this%20frame%0a%20%20%20%20%20%20%20%20%20%20recv:%20%20%20endpoint%20receives%20this%20frame%0a%0a%20%20%20%20%20%20%20%20%20%20H:%20%20HEADERS%20frame%20%28with%20implied%20CONTINUATIONs%29%0a%20%20%20%20%20%20%20%20%20%20PP:%20PUSH_PROMISE%20frame%20%28with%20implied%20CONTINUATIONs%29%0a%20%20%20%20%20%20%20%20%20%20ES:%20END_STREAM%20flag%0a%20%20%20%20%20%20%20%20%20%20R:%20%20RST_STREAM%20frame>
<i class="bi bi-copy"></i></button></div><pre><code>5.1.  Stream States

   The lifecycle of a stream is shown in Figure 2.

                                &#43;--------&#43;
                        send PP |        | recv PP
                       ,--------|  idle  |--------.
                      /         |        |         \
                     v          &#43;--------&#43;          v
              &#43;----------&#43;          |           &#43;----------&#43;
              |          |          | send H /  |          |
       ,------| reserved |          | recv H    | reserved |------.
       |      | (local)  |          |           | (remote) |      |
       |      &#43;----------&#43;          v           &#43;----------&#43;      |
       |          |             &#43;--------&#43;             |          |
       |          |     recv ES |        | send ES     |          |
       |   send H |     ,-------|  open  |-------.     | recv H   |
       |          |    /        |        |        \    |          |
       |          v   v         &#43;--------&#43;         v   v          |
       |      &#43;----------&#43;          |           &#43;----------&#43;      |
       |      |   half   |          |           |   half   |      |
       |      |  closed  |          | send R /  |  closed  |      |
       |      | (remote) |          | recv R    | (local)  |      |
       |      &#43;----------&#43;          |           &#43;----------&#43;      |
       |           |                |                 |           |
       |           | send ES /      |       recv ES / |           |
       |           | send R /       v        send R / |           |
       |           | recv R     &#43;--------&#43;   recv R   |           |
       | send R /  `-----------&gt;|        |&lt;-----------&#39;  send R / |
       | recv R                 | closed |               recv R   |
       `-----------------------&gt;|        |&lt;----------------------&#39;
                                &#43;--------&#43;

          send:   endpoint sends this frame
          recv:   endpoint receives this frame

          H:  HEADERS frame (with implied CONTINUATIONs)
          PP: PUSH_PROMISE frame (with implied CONTINUATIONs)
          ES: END_STREAM flag
          R:  RST_STREAM frame</code></pre></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/http2.go#L100%0avar%20stateName%20=%20[...]string%7b%0a%20%20stateIdle:%20%20%20%20%20%20%20%20%20%20%20%20%20%22Idle%22,%0a%09stateOpen:%20%20%20%20%20%20%20%20%20%20%20%20%20%22Open%22,%0a%09stateHalfClosedLocal:%20%20%22HalfClosedLocal%22,%0a%09stateHalfClosedRemote:%20%22HalfClosedRemote%22,%0a%09stateClosed:%20%20%20%20%20%20%20%20%20%20%20%22Closed%22,%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/http2.go#L100
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stateName</span> = [<span style=color:#f92672>...</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stateIdle</span>:             <span style=color:#e6db74>&#34;Idle&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateOpen</span>:             <span style=color:#e6db74>&#34;Open&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateHalfClosedLocal</span>:  <span style=color:#e6db74>&#34;HalfClosedLocal&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateHalfClosedRemote</span>: <span style=color:#e6db74>&#34;HalfClosedRemote&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stateClosed</span>:           <span style=color:#e6db74>&#34;Closed&#34;</span>,
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/server.go#L1506%0afunc%20%28sc%20*serverConn%29%20closeStream%28st%20*stream,%20err%20error%29%20%7b%0a%09sc.serveG.check%28%29%0a%09if%20st.state%20==%20stateIdle%20%7c%7c%20st.state%20==%20stateClosed%20%7b">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L1506
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverConn</span>) <span style=color:#a6e22e>closeStream</span>(<span style=color:#a6e22e>st</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stream</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>serveG</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>st</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>stateIdle</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>st</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>stateClosed</span> {</span></span></code></pre></div></div><ul><li>stream의 lifecycle 이다. closeStream() 을 호출할 때 state를 체크하고 있는 걸 볼수 있다.</li></ul><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=#ZgotmplZ>
<i class="bi bi-copy"></i></button></div><pre><code>4.1.  Frame Format

   All frames begin with a fixed 9-octet header followed by a variable-
   length payload.

    &#43;-----------------------------------------------&#43;
    |                 Length (24)                   |
    &#43;---------------&#43;---------------&#43;---------------&#43;
    |   Type (8)    |   Flags (8)   |
    &#43;-&#43;-------------&#43;---------------&#43;-------------------------------&#43;
    |R|                 Stream Identifier (31)                      |
    &#43;=&#43;=============================================================&#43;
    |                   Frame Payload (0...)                      ...
    &#43;---------------------------------------------------------------&#43;

                          Figure 1: Frame Layout</code></pre></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=5.1.1.%20%20Stream%20Identifiers%0a%0a%20%20%20Streams%20are%20identified%20with%20an%20unsigned%2031-bit%20integer.%20%20Streams%0a%20%20%20initiated%20by%20a%20client%20MUST%20use%20odd-numbered%20stream%20identifiers;%20those%0a%20%20%20initiated%20by%20the%20server%20MUST%20use%20even-numbered%20stream%20identifiers.%20%20A%0a%20%20%20stream%20identifier%20of%20zero%20%280x0%29%20is%20used%20for%20connection%20control%0a%20%20%20messages;%20the%20stream%20identifier%20of%20zero%20cannot%20be%20used%20to%20establish%20a%0a%20%20%20new%20stream.>
<i class="bi bi-copy"></i></button></div><pre><code>5.1.1.  Stream Identifiers

   Streams are identified with an unsigned 31-bit integer.  Streams
   initiated by a client MUST use odd-numbered stream identifiers; those
   initiated by the server MUST use even-numbered stream identifiers.  A
   stream identifier of zero (0x0) is used for connection control
   messages; the stream identifier of zero cannot be used to establish a
   new stream.</code></pre></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=//%20golang.org/x/net/http2/server.go#L492%0atype%20serverConn%20struct%20%7b%0a%20%20//%20skip%0a%20%20streams%20map[uint32]*stream%0a%20%20//%20skip>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L492
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>serverConn</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>streams</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>uint32</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>stream</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/server.go#L1455%0afunc%20%28sc%20*serverConn%29%20processWindowUpdate%28f%20*WindowUpdateFrame%29%20error%20%7b%0a%09sc.serveG.check%28%29%0a%09switch%20%7b%0a%09case%20f.StreamID%20!=%200:%20//%20stream-level%20flow%20control%0a%09%09state,%20st%20:=%20sc.state%28f.StreamID%29">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L1455
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverConn</span>) <span style=color:#a6e22e>processWindowUpdate</span>(<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WindowUpdateFrame</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>serveG</span>.<span style=color:#a6e22e>check</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>StreamID</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>: <span style=color:#75715e>// stream-level flow control
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>st</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>state</span>(<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>StreamID</span>)</span></span></code></pre></div></div><ul><li>frame 의 구성에서 frame payload 전에 stream identifier 가 담겨있는 것을 볼 수 있다.</li><li>stream은 streamID 를 통해서 관리되며, 어떠한 입력이 왔을 때 streamID 를 통해 상태를 조회하고, 동작하는 것을 코드로도 볼 수 있다.</li><li>즉, Multiplexed Streams 을 지원한다는 이야기이다.</li></ul><hr><h3 id=stream-prioritization>Stream Prioritization</h3><p>Stream Prioritization 은 둘러보다가 testcode랑 구현 내용을 발견하긴 했는데, 어떻게 구현했을지가 크게 궁금하지도 않고, 코드를 뜯어보는 비용에 비해서 크게 남는게 없을거 같아서 생략한다.</p><hr><h3 id=server-push>Server Push</h3><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=8.2.%20%20Server%20Push%0a%0a%20%20%20HTTP/2%20allows%20a%20server%20to%20pre-emptively%20send%20%28or%20%22push%22%29%20responses%0a%20%20%20%28along%20with%20corresponding%20%22promised%22%20requests%29%20to%20a%20client%20in%0a%20%20%20association%20with%20a%20previous%20client-initiated%20request.%20%20This%20can%20be%0a%20%20%20useful%20when%20the%20server%20knows%20the%20client%20will%20need%20to%20have%20those%0a%20%20%20responses%20available%20in%20order%20to%20fully%20process%20the%20response%20to%20the%0a%20%20%20original%20request.>
<i class="bi bi-copy"></i></button></div><pre><code>8.2.  Server Push

   HTTP/2 allows a server to pre-emptively send (or &#34;push&#34;) responses
   (along with corresponding &#34;promised&#34; requests) to a client in
   association with a previous client-initiated request.  This can be
   useful when the server knows the client will need to have those
   responses available in order to fully process the response to the
   original request.</code></pre></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/server.go#L807%0afunc%20%28sc%20*serverConn%29%20serve%28%29%20%7b%0a%20%20//%20skip%0a%20%20for%20%7b%0a%20%20%20%20//%20skip%0a%20%20%20%20select%20%7b%0a%20%20%20%20//%20skip%20until%20#L879%0a%20%20%20%20case%20msg%20:=%20%3c-sc.serveMsgCh:%0a%09%09%09switch%20v%20:=%20msg.%28type%29%20%7b%0a%09%09%09//%20skip%20until%20#L899%0a%09%09%09%20%20case%20*startPushRequest:%0a%09%09%09%09sc.startPush%28v%29%0a%20%20%20//%20skip">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L807
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>serverConn</span>) <span style=color:#a6e22e>serve</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// skip until #L879
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>serveMsgCh</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>msg</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// skip until #L899
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			  <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>startPushRequest</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>startPush</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>   <span style=color:#75715e>// skip
</span></span></span></code></pre></div></div><ul><li>위 코드를 이해하려면 다른 http, http2 의 코드들의 배경지식도 필요하다.</li><li>대충 설명하면, <code>serve()</code> 함수는 <code>http.ListenAndServe()</code> 가 호출되었을 때 결과적으로 호출되게 되는 함수이다. (살짝 다르긴 하지만, [[go-http]] 참고)</li><li>이렇게 그리고 http2 는 channel 과 goroutine 을 통해서 보내야하는 내용을 제어하고 있다.</li><li><code>startPush()</code> 는 별다른 게 없는 함수다. 읽어보면 그냥 규격대로 구현되어 있고, 특별한 점을 찾지는 않아서 적지는 않았다.</li><li>위 구현은 golang 을 잘 활용해서 구현한거니, 아마도 다른 언어에서는 쓰레드와 producer-consumer queue를 활용해서 구현해놨을 것 같다.</li></ul><hr><h3 id=header-compression>Header Compression</h3><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data=4.3.%20%20Header%20Compression%20and%20Decompression%0a%0a%20%20%20Just%20as%20in%20HTTP/1,%20a%20header%20field%20in%20HTTP/2%20is%20a%20name%20with%20one%20or%0a%20%20%20more%20associated%20values.%20%20Header%20fields%20are%20used%20within%20HTTP%20request%0a%20%20%20and%20response%20messages%20as%20well%20as%20in%20server%20push%20operations%20%28see%0a%20%20%20Section%208.2%29.%0a%0a%20%20%20Header%20lists%20are%20collections%20of%20zero%20or%20more%20header%20fields.%20%20When%0a%20%20%20transmitted%20over%20a%20connection,%20a%20header%20list%20is%20serialized%20into%20a%0a%20%20%20header%20block%20using%20HTTP%20header%20compression%20[COMPRESSION].%20%20The%0a%20%20%20serialized%20header%20block%20is%20then%20divided%20into%20one%20or%20more%20octet%0a%20%20%20sequences,%20called%20header%20block%20fragments,%20and%20transmitted%20within%20the%0a%20%20%20payload%20of%20HEADERS%20%28Section%206.2%29,%20PUSH_PROMISE%20%28Section%206.6%29,%20or%0a%20%20%20CONTINUATION%20%28Section%206.10%29%20frames.>
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ae81ff>4.3</span>.  <span style=color:#a6e22e>Header</span> <span style=color:#a6e22e>Compression</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Decompression</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Just</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>field</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>name</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>or</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>associated</span> <span style=color:#a6e22e>values</span>.  <span style=color:#a6e22e>Header</span> <span style=color:#a6e22e>fields</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>used</span> <span style=color:#a6e22e>within</span> <span style=color:#a6e22e>HTTP</span> <span style=color:#a6e22e>request</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>response</span> <span style=color:#a6e22e>messages</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>well</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>server</span> <span style=color:#a6e22e>push</span> <span style=color:#a6e22e>operations</span> (<span style=color:#a6e22e>see</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>8.2</span>).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Header</span> <span style=color:#a6e22e>lists</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>collections</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>zero</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>fields</span>.  <span style=color:#a6e22e>When</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>transmitted</span> <span style=color:#a6e22e>over</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>list</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>serialized</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>block</span> <span style=color:#a6e22e>using</span> <span style=color:#a6e22e>HTTP</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>compression</span> [<span style=color:#a6e22e>COMPRESSION</span>].  <span style=color:#a6e22e>The</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>serialized</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>block</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>then</span> <span style=color:#a6e22e>divided</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>octet</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>sequences</span>, <span style=color:#a6e22e>called</span> <span style=color:#a6e22e>header</span> <span style=color:#a6e22e>block</span> <span style=color:#a6e22e>fragments</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>transmitted</span> <span style=color:#a6e22e>within</span> <span style=color:#a6e22e>the</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>payload</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>HEADERS</span> (<span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>6.2</span>), <span style=color:#a6e22e>PUSH_PROMISE</span> (<span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>6.6</span>), <span style=color:#a6e22e>or</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>CONTINUATION</span> (<span style=color:#a6e22e>Section</span> <span style=color:#ae81ff>6.10</span>) <span style=color:#a6e22e>frames</span>.</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/server.go#L415%0asc.hpackEncoder%20=%20hpack.NewEncoder%28&amp;sc.headerWriteBuf%29%0a%0ar%20:=%20NewFramer%28sc.bw,%20c%29%0afr.ReadMetaHeaders%20=%20hpack.NewDecoder%28initialHeaderTableSize,%20nil%29">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/server.go#L415
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>hpackEncoder</span> = <span style=color:#a6e22e>hpack</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>headerWriteBuf</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewFramer</span>(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>bw</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>ReadMetaHeaders</span> = <span style=color:#a6e22e>hpack</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>initialHeaderTableSize</span>, <span style=color:#66d9ef>nil</span>)</span></span></code></pre></div></div><div class=codeblock><div class=copy-button-box><button class=copy-button state=copy data="//%20golang.org/x/net/http2/frame.go#L487%0afunc%20%28fr%20*Framer%29%20ReadFrame%28%29%20%28Frame,%20error%29%20%7b%0a%20%20//%20skip%20until%20L516%0a%20%20if%20fh.Type%20==%20FrameHeaders%20&&%20fr.ReadMetaHeaders%20!=%20nil%20%7b%0a%09%09return%20fr.readMetaFrame%28f.%28*HeadersFrame%29%29%0a%09%7d%0a%20%20return%20f,%20nil%0a%7d">
<i class="bi bi-copy"></i></button></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// golang.org/x/net/http2/frame.go#L487
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Framer</span>) <span style=color:#a6e22e>ReadFrame</span>() (<span style=color:#a6e22e>Frame</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// skip until L516
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fh</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>FrameHeaders</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>ReadMetaHeaders</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>readMetaFrame</span>(<span style=color:#a6e22e>f</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>HeadersFrame</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><ul><li>어떻게 compression 할지는 추가적으로 정의가 되어있고, 여기서는 그냥 이를 사용만 한다.</li><li>위 코드를 보면 framer 에 Decoder 로 hpack 을 넣어주는 것을 볼 수있다.</li><li>이를 사용해서 frame을 읽는다.</li><li>쓰기 부분은 추가적으로 찾지는 않았지만 sc.hpackEncoder 를 통해서 할 것 이라고 추정할 수 있다.</li></ul></div><hr><div class=list-files><ul class=section-tree></ul></div></article><script src=/js/wikilink.js></script><div><script src=https://utteranc.es/client.js repo=minuk-dev/minuk-dev.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></main><footer class=footer><div class=footer-left></div><div class=footer-right><ul class=social><li><a href=/about>About</a></li><li><a href=https://github.com/minuk-dev>Github</a></li></ul></div></footer></body><script src=/js/dir_toggle.js></script><script src=/js/codeblock_copy.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css><script type=module>
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";
mermaid.initialize({
  startOnLoad: true,
  theme: "dark",
});
</script></html>